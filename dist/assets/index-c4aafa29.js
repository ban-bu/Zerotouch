import{r as f,a as Vt,R as Kt}from"./vendor-b1791c80.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))m(c);new MutationObserver(c=>{for(const d of c)if(d.type==="childList")for(const u of d.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&m(u)}).observe(document,{childList:!0,subtree:!0});function l(c){const d={};return c.integrity&&(d.integrity=c.integrity),c.referrerPolicy&&(d.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?d.credentials="include":c.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function m(c){if(c.ep)return;c.ep=!0;const d=l(c);fetch(c.href,d)}})();var Tt={exports:{}},xt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Zt=f,Jt=Symbol.for("react.element"),Qt=Symbol.for("react.fragment"),Xt=Object.prototype.hasOwnProperty,en=Zt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,tn={key:!0,ref:!0,__self:!0,__source:!0};function Pt(s,t,l){var m,c={},d=null,u=null;l!==void 0&&(d=""+l),t.key!==void 0&&(d=""+t.key),t.ref!==void 0&&(u=t.ref);for(m in t)Xt.call(t,m)&&!tn.hasOwnProperty(m)&&(c[m]=t[m]);if(s&&s.defaultProps)for(m in t=s.defaultProps,t)c[m]===void 0&&(c[m]=t[m]);return{$$typeof:Jt,type:s,key:d,ref:u,props:c,_owner:en.current}}xt.Fragment=Qt;xt.jsx=Pt;xt.jsxs=Pt;Tt.exports=xt;var e=Tt.exports,wt={},kt=Vt;wt.createRoot=kt.createRoot,wt.hydrateRoot=kt.hydrateRoot;/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var nn={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const sn=s=>s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase().trim(),B=(s,t)=>{const l=f.forwardRef(({color:m="currentColor",size:c=24,strokeWidth:d=2,absoluteStrokeWidth:u,className:x="",children:y,...v},b)=>f.createElement("svg",{ref:b,...nn,width:c,height:c,stroke:m,strokeWidth:u?Number(d)*24/Number(c):d,className:["lucide",`lucide-${sn(s)}`,x].join(" "),...v},[...t.map(([k,C])=>f.createElement(k,C)),...Array.isArray(y)?y:[y]]));return l.displayName=`${s}`,l};/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=B("AlertCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const it=B("AlertTriangle",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z",key:"c3ski4"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const At=B("ArrowRight",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=B("Bot",[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rt=B("CheckCircle",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const on=B("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rn=B("Filter",[["polygon",{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3",key:"1yg77f"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const an=B("GraduationCap",[["path",{d:"M22 10v6M2 10l10-5 10 5-10 5z",key:"1ef52a"}],["path",{d:"M6 12v5c3 3 9 3 12 0v-5",key:"1f75yj"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const St=B("HelpCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3",key:"1u773s"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ln=B("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cn=B("Layers",[["path",{d:"m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z",key:"8b97xw"}],["path",{d:"m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65",key:"dd6zsq"}],["path",{d:"m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65",key:"ep9fru"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _t=B("Lightbulb",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ft=B("MessageCircle",[["path",{d:"m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z",key:"v2veuj"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dn=B("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const un=B("Moon",[["path",{d:"M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z",key:"a7tn18"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pn=B("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z",key:"ymcmye"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=B("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mn=B("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dt=B("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gn=B("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hn=B("ShoppingBag",[["path",{d:"M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z",key:"hou9p0"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M16 10a4 4 0 0 1-8 0",key:"1ltviw"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fn=B("Sparkles",[["path",{d:"m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z",key:"17u4zn"}],["path",{d:"M5 3v4",key:"bklmnn"}],["path",{d:"M19 17v4",key:"iiml17"}],["path",{d:"M3 5h4",key:"nem4j1"}],["path",{d:"M17 19h4",key:"lbex7p"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xn=B("Sun",[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const at=B("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lt=B("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yn=B("Volume2",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["path",{d:"M15.54 8.46a5 5 0 0 1 0 7.07",key:"ltjumu"}],["path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14",key:"1kegas"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bn=B("VolumeX",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=B("XCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $t=B("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jt=B("Zap",[["polygon",{points:"13 2 3 14 12 14 11 22 21 10 12 10 13 2",key:"45s27k"}]]),Se=({children:s,type:t="fade",duration:l=300,show:m=!0,onExited:c=()=>{}})=>{const[d,u]=f.useState(m),[x,y]=f.useState(!1),v=(k,C,j)=>{const M="transition-all duration-300 ease-in-out";if(!C)return"opacity-0 scale-95";switch(k){case"fade":return`${M} opacity-100`;case"slide-up":return`${M} opacity-100 translate-y-0`;case"slide-down":return`${M} opacity-100 translate-y-0`;case"slide-left":return`${M} opacity-100 translate-x-0`;case"slide-right":return`${M} opacity-100 translate-x-0`;case"scale":return`${M} opacity-100 scale-100`;default:return`${M} opacity-100`}};if(f.useEffect(()=>{let k;return m&&!d?(u(!0),y(!0),k=setTimeout(()=>{y(!1)},50)):!m&&d&&(y(!0),k=setTimeout(()=>{u(!1),y(!1),c()},l)),()=>{clearTimeout(k)}},[m,d,l,c]),!d&&!m)return null;const b=v(t,m);return e.jsx("div",{className:b,children:s})},wn=({message:s="Sending..."})=>e.jsxs("div",{className:"flex items-center space-x-2 text-gray-500 text-sm",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsx("span",{children:s})]}),vn=({message:s="AI is thinking"})=>e.jsxs("div",{className:"flex items-center space-x-2 text-gray-500",children:[e.jsx("span",{className:"text-sm",children:s}),e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-1 h-1 bg-gray-400 rounded-full animate-pulse",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-1 h-1 bg-gray-400 rounded-full animate-pulse",style:{animationDelay:"200ms"}}),e.jsx("div",{className:"w-1 h-1 bg-gray-400 rounded-full animate-pulse",style:{animationDelay:"400ms"}})]})]}),Nn=({scenario:s,messages:t,onSendMessage:l,isProcessing:m})=>{const[c,d]=f.useState(""),[u,x]=f.useState(null),y=f.useRef(null),v=f.useRef(null);f.useEffect(()=>{},[t]);const b=j=>{j.preventDefault(),!(!c.trim()&&!u)&&(l({text:c.trim(),image:u,timestamp:new Date().toISOString()}),d(""),x(null),v.current&&(v.current.value=""))},k=j=>{const M=j.target.files[0];M&&M.type.startsWith("image/")&&x(M)},C=()=>{x(null),v.current&&(v.current.value="")};return e.jsxs("div",{className:"h-full flex flex-col glass-effect rounded-2xl overflow-hidden",style:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%)",backdropFilter:"blur(20px) saturate(1.3)",WebkitBackdropFilter:"blur(20px) saturate(1.3)",border:"1px solid rgba(255, 255, 255, 0.2)",height:"calc(100vh - 200px)"},children:[e.jsxs("div",{className:"panel-header glass-effect flex-shrink-0",style:{background:"linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.12) 100%)",backdropFilter:"blur(20px) saturate(1.3)",borderRadius:"20px",border:"1px solid rgba(255, 255, 255, 0.2)",borderBottom:"1px solid rgba(255, 255, 255, 0.1)"},children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-blue-100/70 dark:bg-blue-900/50 rounded-2xl backdrop-blur-sm",children:e.jsx(at,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:"Customer Conversation"}),!1]})]}),!1]}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-3 p-4 min-h-0",style:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.02) 0%, rgba(248, 250, 252, 0.01) 100%)",backdropFilter:"blur(10px) saturate(1.1)"},children:[(!t||t.length===0)&&e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-center text-gray-500 space-y-4",children:[e.jsx("div",{className:"p-4 bg-gradient-to-r from-blue-100/80 to-sky-100/80 dark:from-blue-900/30 dark:to-sky-900/30 rounded-full shadow-inner backdrop-blur-sm",children:e.jsx(at,{className:"w-8 h-8 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm",children:"Enter your request or question here"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Text and image input supported"})]})]}),t&&t.map((j,M)=>e.jsxs("div",{className:"space-y-2",children:[j.type==="user"&&e.jsx(Se,{type:"slide-right",show:!0,children:e.jsxs("div",{className:"message-bubble message-user slide-in-right",children:[j.image&&e.jsx("div",{className:"mb-2",children:e.jsx("img",{src:URL.createObjectURL(j.image),alt:"User upload",className:"max-w-full h-auto rounded-lg shadow-md"})}),e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(at,{className:"w-4 h-4 text-white mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"message-content",children:e.jsx("p",{className:"whitespace-pre-wrap select-text",children:j.text})}),e.jsx("div",{className:"text-xs text-gray-300 mt-1 opacity-90",style:{textShadow:"0 1px 2px rgba(0,0,0,0.5)"},children:new Date(j.timestamp).toLocaleTimeString()})]})]})]})}),j.type==="ai_response"&&e.jsx(Se,{type:"slide-left",show:!0,children:e.jsx("div",{className:"message-bubble message-ai slide-in-left",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(ke,{className:"w-4 h-4 text-gray-600 dark:text-gray-400 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"message-content",children:e.jsx("p",{className:"whitespace-pre-wrap select-text",children:j.text})}),e.jsx("div",{className:"text-xs text-gray-300 mt-1 opacity-90",style:{textShadow:"0 1px 2px rgba(0,0,0,0.5)"},children:new Date(j.timestamp).toLocaleTimeString()})]})]})})})]},M)),m&&e.jsx("div",{className:"message-bubble message-ai",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ke,{className:"w-4 h-4 text-gray-600"}),e.jsx(vn,{message:"AI is translating"})]})}),e.jsx("div",{ref:y})]}),e.jsx("div",{className:"p-4 border-t border-white/20 dark:border-white/10 glass-effect rounded-b-2xl flex-shrink-0",children:e.jsx("form",{onSubmit:b,className:"space-y-3",children:e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("textarea",{value:c,onChange:j=>d(j.target.value),placeholder:`As ${s.problemRole}, please describe your needs...`,className:"input-field resize-none transition-all duration-200 focus:shadow-md",rows:3,readOnly:m}),u&&e.jsx(Se,{type:"scale",show:!0,children:e.jsxs("div",{className:"mt-3 relative inline-block",children:[e.jsx("img",{src:URL.createObjectURL(u),alt:"Preview",className:"max-w-xs h-auto rounded-lg border border-gray-300 shadow-md"}),e.jsx("button",{type:"button",onClick:C,className:"absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 shadow-lg transition-all duration-200 hover:scale-110",children:"Ã—"})]})}),m&&e.jsx("div",{className:"mt-2",children:e.jsx(wn,{message:"Sending..."})})]}),e.jsxs("div",{className:"flex items-end space-x-2",children:[e.jsx("input",{ref:v,type:"file",accept:"image/*",onChange:k,className:"hidden",id:"image-upload"}),e.jsx("button",{type:"submit",disabled:!c.trim()&&!u||m,className:"btn-primary p-3 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none",title:"Send message",children:e.jsx(Dt,{className:"w-5 h-5"})})]})]})})})]})},kn=({processing:s,messages:t,onGenerateSuggestion:l,onGenerateFollowUp:m,onGenerateIntelligentFollowUp:c,onGenerateNeedsAnalysis:d,onGenerateDepartmentContact:u,onGenerateDepartmentContactOnly:x,onChatWithAI:y,onAcceptSuggestion:v,onNegotiateSuggestion:b,onRejectSuggestion:k,onAcceptFollowUp:C,onNegotiateFollowUp:j,onRejectFollowUp:M,onSendToSolution:F,onSendToProblem:D,onSetSolutionInput:q,onCancelIteration:O,currentScenario:U,onCancelNegotiation:J,onSendNegotiationRequest:E,onCancelFollowUpNegotiation:K,onSendFollowUpNegotiationRequest:ce,onPrepareDirectSendCandidate:P,thinkingContent:z,answerContent:Z,isStreaming:me,isPaused:oe,onPauseAI:we,onResumeAI:ae,onAdjustAI:ue,showMissingInfoPanel:Q})=>{const $e=f.useRef(null);f.useState("analysis");const[H,ne]=f.useState({}),[he,ee]=f.useState(!1),[ve,ge]=f.useState("");f.useEffect(()=>{},[t]);const ze=({messageId:L,messageType:R,onSendNegotiation:se,onCancel:N})=>{const[I,fe]=f.useState(""),[_,Ie]=f.useState(!1),xe=async()=>{if(!(!I.trim()||_)){console.log("ðŸ”„ å‘é€åå•†è¯·æ±‚:",{messageId:L,negotiationText:I,messageType:R}),Ie(!0);try{await se(L,I),fe(""),console.log("âœ… åå•†è¯·æ±‚å‘é€æˆåŠŸ")}catch(de){console.error("âŒ å‘é€åå•†è¯·æ±‚å¤±è´¥:",de)}finally{Ie(!1)}}};return e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 mt-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ft,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-800 dark:text-blue-200",children:"Negotiation Mode"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("textarea",{value:I,onChange:de=>fe(de.target.value),placeholder:`Describe how you'd like to adjust this ${R==="suggestion"?"suggestion":"follow-up"}...`,className:"w-full p-2 text-sm border border-blue-200 dark:border-blue-700 rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-blue-900/30 dark:text-blue-100",rows:3,disabled:_}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed",onClick:xe,disabled:!I.trim()||_,children:_?"Sending...":"Send negotiation"}),e.jsx("button",{className:"px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors text-sm",onClick:()=>N(L),disabled:_,children:"Cancel"})]})]})]})},te=()=>{const L=f.useRef(null);f.useEffect(()=>{L.current&&(L.current.scrollTop=L.current.scrollHeight)},[z]);const R=()=>{ve.trim()&&(ue&&ue(ve.trim()),ge(""),ee(!1))},se=()=>{ee(!1),ge(""),ae&&ae()};return e.jsxs("div",{className:"bg-gradient-to-br from-purple-50/90 to-indigo-50/90 dark:from-purple-900/20 dark:to-indigo-900/20 border border-purple-200/50 dark:border-purple-700/50 rounded-xl p-4 glass-effect flex flex-col",style:{maxHeight:"calc(100vh - 300px)",height:"auto"},children:[e.jsxs("div",{className:"flex items-center justify-between mb-3 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${oe?"bg-yellow-500":"bg-purple-500 animate-pulse"}`}),e.jsx("h4",{className:"text-sm font-semibold text-purple-800 dark:text-purple-200",children:"ðŸ§  AI Thinking"}),me&&!oe&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-1 h-1 bg-purple-400 rounded-full animate-bounce"}),e.jsx("div",{className:"w-1 h-1 bg-purple-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),e.jsx("div",{className:"w-1 h-1 bg-purple-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]}),oe&&e.jsx("span",{className:"text-xs text-yellow-600 dark:text-yellow-400 font-medium",children:"Paused"})]}),e.jsxs("div",{className:"flex space-x-2",children:[!1,oe&&!he&&e.jsx("button",{onClick:()=>ee(!0),className:"p-2 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 rounded-lg transition-all duration-200 group",title:"Give adjustment",children:e.jsx(pn,{className:"w-4 h-4 text-blue-600 group-hover:text-blue-700"})}),oe&&!he&&e.jsx("button",{onClick:()=>ae&&ae(),className:"p-2 bg-green-500/20 hover:bg-green-500/30 border border-green-500/40 rounded-lg transition-all duration-200 group",title:"Resume AI reasoning",children:e.jsx(mn,{className:"w-4 h-4 text-green-600 group-hover:text-green-700"})})]})]}),he&&e.jsxs("div",{className:"mb-3 p-3 bg-blue-50/80 dark:bg-blue-900/20 border border-blue-200/50 dark:border-blue-700/50 rounded-lg flex-shrink-0",children:[e.jsx("div",{className:"text-sm font-medium text-blue-800 dark:text-blue-200 mb-2",children:"ðŸ’¡ Adjustment for AI"}),e.jsx("textarea",{value:ve,onChange:N=>ge(N.target.value),placeholder:"Describe the issue in reasoning and how to improve...",className:"w-full p-2 text-sm border border-blue-200 dark:border-blue-700 rounded resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-blue-900/30 dark:text-blue-100",rows:3,autoFocus:!0}),e.jsxs("div",{className:"flex space-x-2 mt-2",children:[e.jsx("button",{onClick:R,disabled:!ve.trim(),className:"px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:"Apply"}),e.jsx("button",{onClick:se,className:"px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors text-sm",children:"Cancel"})]})]}),e.jsx("div",{ref:L,className:"flex-1 overflow-y-auto bg-white/70 dark:bg-gray-800/70 rounded-lg p-3 backdrop-blur-sm border border-purple-200/30 dark:border-purple-700/30",style:{minHeight:"200px",maxHeight:"calc(100vh - 450px)",height:"auto"},children:z?e.jsxs("div",{className:"text-sm text-purple-900 dark:text-purple-100 whitespace-pre-wrap font-mono leading-relaxed",children:[z,me&&!oe&&e.jsx("span",{className:"animate-pulse text-purple-500",children:"|"}),oe&&e.jsx("span",{className:"text-yellow-500",children:"â¸ï¸"})]}):e.jsx("div",{className:"text-sm text-purple-500 dark:text-purple-400 italic",children:"Waiting for AI to start thinking..."})})]})},Ee=()=>{const[L,R]=f.useState(!1),[se,N]=f.useState(""),[I,fe]=f.useState(!1),_=f.useRef(null);f.useEffect(()=>{L&&_.current&&setTimeout(()=>{_.current.focus()},150)},[L]);const Ie=f.useCallback(async()=>{if(se.trim()&&y){fe(!0);try{await y(se.trim()),N("")}catch(xe){console.error("AIå¯¹è¯å‡ºé”™:",xe)}finally{fe(!1)}}},[se,y]);return e.jsxs("div",{className:"space-y-4",children:[!1,L&&e.jsx("div",{className:"p-4 rounded-xl bg-gradient-to-r from-gray-50/80 to-slate-100/80 dark:from-gray-800/80 dark:to-slate-800/80 border border-gray-200/50 dark:border-gray-700/50 transition-all duration-300 ease-in-out",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center space-x-2",children:[e.jsx(ke,{className:"w-4 h-4"}),e.jsx("span",{children:"Ask AI"})]}),e.jsx("div",{className:"relative",children:e.jsx("textarea",{ref:_,value:se,onChange:xe=>N(xe.target.value),placeholder:"Type your question for AI...",className:"w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:3,style:{minHeight:"80px"}})},"ai-input-container"),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:Ie,disabled:!se.trim()||I,className:"flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2",children:I?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Asking..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ft,{className:"w-4 h-4"}),e.jsx("span",{children:"Ask AI"})]})}),e.jsx("button",{onClick:()=>N(""),className:"px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors",children:"Clear"})]})]})},"ai-controls-panel")]})},qe=L=>L.includes("é—®é¢˜ç«¯")?e.jsx(cn,{className:"w-4 h-4 text-blue-600"}):L.includes("æ–¹æ¡ˆç«¯")?e.jsx(jt,{className:"w-4 h-4 text-green-600"}):L.includes("å»ºè®®")?e.jsx(_t,{className:"w-4 h-4 text-purple-600"}):L.includes("è¿½é—®")?e.jsx(rn,{className:"w-4 h-4 text-orange-600"}):L.includes("éœ€æ±‚åˆ†æž")?e.jsx(jt,{className:"w-4 h-4 text-teal-600"}):L.includes("éƒ¨é—¨è”ç»œ")||L.includes("è”ç»œæŒ‡ä»¤")||L.includes("å®¢æˆ·å›žå¤å’Œéƒ¨é—¨è”ç»œ")||L.includes("ç”Ÿæˆéƒ¨é—¨è”ç»œ")?e.jsx(lt,{className:"w-4 h-4 text-green-600"}):L.includes("AIå¯¹è¯")?e.jsx(ft,{className:"w-4 h-4 text-blue-600"}):L.includes("æœ€ç»ˆ")?e.jsx(At,{className:"w-4 h-4 text-indigo-600"}):e.jsx(ke,{className:"w-4 h-4 text-gray-600"});return e.jsxs("div",{className:"h-full flex flex-col glass-effect rounded-2xl overflow-hidden",style:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%)",backdropFilter:"blur(20px) saturate(1.3)",WebkitBackdropFilter:"blur(20px) saturate(1.3)",border:"1px solid rgba(255, 255, 255, 0.2)",height:"calc(100vh - 200px)"},children:[e.jsx("div",{className:"p-4 border-b border-white/20 dark:border-white/10 glass-effect rounded-t-2xl flex-shrink-0",style:{background:"linear-gradient(135deg, rgba(147, 51, 234, 0.15) 0%, rgba(99, 102, 241, 0.12) 100%)",backdropFilter:"blur(20px) saturate(1.3)"},children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-gradient-to-br from-purple-500/90 to-indigo-600/90 rounded-2xl backdrop-blur-sm",children:e.jsx(ke,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:"AI Console"}),!1]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-4 p-4 min-h-0",style:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.02) 0%, rgba(248, 250, 252, 0.01) 100%)",backdropFilter:"blur(10px) saturate(1.1)"},children:[t.length===0&&!s&&!me&&!z&&!Z&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center text-gray-500 dark:text-gray-400 space-y-6",children:[e.jsx(Se,{type:"fade",show:!0,children:e.jsx("div",{className:"p-6 rounded-full shadow-inner div-with-background",children:e.jsx(fn,{className:"w-12 h-12 text-purple-600 dark:text-purple-400"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xl font-semibold",children:"AI Console"}),!1]}),e.jsx("div",{className:"w-full max-w-md",children:e.jsx(Ee,{})})]}),(t.length>0||s||me||z||Z)&&e.jsxs("div",{className:"h-full flex flex-col space-y-4",children:[(me||z||Z)&&e.jsxs("div",{className:"space-y-4",children:[z&&e.jsx(Se,{type:"slide-up",show:!0,children:e.jsx(te,{})}),!1]}),e.jsx(Se,{type:"fade",show:!0,children:e.jsx("div",{className:"p-4 glass-effect div-with-background rounded-xl",children:e.jsx(Ee,{})})}),e.jsx(Se,{type:"fade",show:!0,children:e.jsx("div",{className:"p-4 glass-effect div-with-background rounded-xl",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ke,{className:"w-5 h-5 text-purple-600 dark:text-purple-400"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center space-x-2",children:s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-bounce"}),e.jsx("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),e.jsx("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]}),e.jsx("span",{className:"text-sm text-purple-700 dark:text-purple-300",children:"AI processing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),e.jsx("span",{className:"text-sm text-purple-700 dark:text-purple-300",children:"AI idle"})]})}),t.length>0&&e.jsxs("div",{className:"text-xs text-purple-600 dark:text-purple-400 mt-1",children:["Processed ",t.length," requests"]})]})]})})}),e.jsx("div",{className:"space-y-3",children:(()=>{const L=t.filter(R=>!(R!=null&&R.title&&(R.title.includes("ç”Ÿæˆæ™ºèƒ½è¿½é—®")||R.title.includes("åå•†ä¿®æ”¹æ™ºèƒ½è¿½é—®"))));return[...L].reverse().map((R,se)=>{var I,fe,_,Ie,xe,de,Te,Pe,Ae,le,Ce,pe,Oe,Le,$,Y;const N=L.length-1-se;return e.jsx(Se,{type:"slide-up",show:!0,children:e.jsx("div",{className:"p-4 glass-effect div-with-background rounded-xl",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[qe(R.title),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-800 dark:text-gray-200 mb-2",children:R.title}),R.title.includes("å»ºè®®")&&R.output&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 mb-3",children:e.jsx("div",{className:"text-sm text-purple-800 dark:text-purple-200",children:(I=H[`${N}_suggestion`])!=null&&I.negotiating?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-purple-600 border-t-transparent rounded-full"}),e.jsx("span",{children:"Negotiating..."})]}):((fe=H[`${N}_suggestion`])==null?void 0:fe.negotiatedContent)||R.output})}),(_=H[`${N}_suggestion`])!=null&&_.accepted?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 text-sm px-3 py-1 rounded",children:"âœ“ å·²æŽ¥å—å»ºè®®"}),e.jsxs("button",{onClick:()=>{var G;const A=((G=H[`${N}_suggestion`])==null?void 0:G.negotiatedContent)||R.output;u&&u(A)},className:"w-full px-4 py-3 text-white rounded-lg transition-all duration-200 flex items-center justify-center space-x-2 text-sm font-medium hover:scale-105",style:{background:"linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(16, 185, 129, 0.15) 100%)",backdropFilter:"blur(10px) saturate(1.3)",WebkitBackdropFilter:"blur(10px) saturate(1.3)",border:"1px solid rgba(34, 197, 94, 0.3)",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)"},title:"ç”Ÿæˆå®¢æˆ·å›žå¤å’Œéƒ¨é—¨è”ç»œæŒ‡ä»¤",disabled:s,children:[e.jsx(lt,{className:"w-4 h-4"}),e.jsx("span",{children:"ç”Ÿæˆå®¢æˆ·å›žå¤å’Œéƒ¨é—¨è”ç»œæŒ‡ä»¤"}),s&&e.jsx("div",{className:"w-4 h-4 border-2 border-green-400 border-t-transparent rounded-full animate-spin ml-1"})]})]}):(Ie=H[`${N}_suggestion`])!=null&&Ie.showNegotiation?e.jsx(ze,{messageId:`${N}_suggestion`,messageType:"suggestion",onSendNegotiation:async(A,G)=>{ne(V=>({...V,[A]:{...V[A],negotiating:!0}}));try{E&&await E(A,G,V=>{ne(ye=>({...ye,[A]:{...ye[A],negotiating:!1,showNegotiation:!1,negotiated:!0,negotiatedContent:V}}))})}catch(V){console.error("åå•†è¯·æ±‚å¤±è´¥:",V),ne(ye=>({...ye,[A]:{...ye[A],negotiating:!1,showNegotiation:!1}}))}},onCancel:A=>{J&&J(A),ne(G=>({...G,[A]:{...G[A],showNegotiation:!1}}))}}):(xe=H[`${N}_suggestion`])!=null&&xe.negotiated?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-2",children:e.jsx("div",{className:"text-sm text-blue-800 dark:text-blue-200",children:"âœ“ å·²åå•†ä¿®æ”¹"})}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:()=>{var G;const A=((G=H[`${N}_suggestion`])==null?void 0:G.negotiatedContent)||R.output;v&&v(A),ne(V=>({...V,[`${N}_suggestion`]:{accepted:!0,negotiatedContent:A}}))},className:"flex-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-xs transition-colors flex items-center justify-center space-x-1",children:[e.jsx(rt,{className:"w-3 h-3"}),e.jsx("span",{children:"æŽ¥å—å»ºè®®"})]}),e.jsxs("button",{onClick:()=>k&&k(R.output),className:"flex-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs transition-colors flex items-center justify-center space-x-1",children:[e.jsx(gt,{className:"w-3 h-3"}),e.jsx("span",{children:"é‡æ–°ç”Ÿæˆ"})]})]})]}):e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:()=>{var G;const A=((G=H[`${N}_suggestion`])==null?void 0:G.negotiatedContent)||R.output;v&&v(A),ne(V=>({...V,[`${N}_suggestion`]:{accepted:!0,negotiatedContent:A}}))},className:"flex-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-xs transition-colors flex items-center justify-center space-x-1",children:[e.jsx(rt,{className:"w-3 h-3"}),e.jsx("span",{children:"é‡‡çº³å»ºè®®"})]}),e.jsxs("button",{onClick:()=>k&&k(R.output),className:"flex-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs transition-colors flex items-center justify-center space-x-1",children:[e.jsx(gt,{className:"w-3 h-3"}),e.jsx("span",{children:"é‡æ–°ç”Ÿæˆ"})]})]})]}),R.title.includes("è¿½é—®")&&R.output&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"p-3 rounded-lg bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 mb-3",children:e.jsx("div",{className:"text-sm text-orange-800 dark:text-orange-200",children:(de=H[`${N}_followup`])!=null&&de.negotiating?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-orange-600 border-t-transparent rounded-full"}),e.jsx("span",{children:"Negotiating..."})]}):((Te=H[`${N}_followup`])==null?void 0:Te.negotiatedContent)||R.output})}),(Pe=H[`${N}_followup`])!=null&&Pe.accepted?e.jsx("div",{className:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 text-sm px-3 py-1 rounded",children:"âœ“ å·²æŽ¥å—è¿½é—®ï¼ˆå·²å¡«å…¥è¾“å…¥æ¡†ï¼‰"}):(Ae=H[`${N}_followup`])!=null&&Ae.negotiated?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-2",children:e.jsx("div",{className:"text-sm text-blue-800 dark:text-blue-200",children:"âœ“ å·²åå•†ä¿®æ”¹"})}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:()=>{var G;const A=((G=H[`${N}_followup`])==null?void 0:G.negotiatedContent)||R.output;console.log("ðŸ”˜ æŽ¥å—è¿½é—®æŒ‰é’®è¢«ç‚¹å‡»",{finalText:A,onSetSolutionInput:!!q}),q?(console.log("ðŸ“ è°ƒç”¨onSetSolutionInput:",A),q(A),O&&O(),console.log("ðŸ”„ å·²é€€å‡ºè¿­ä»£æ¨¡å¼")):console.error("âŒ onSetSolutionInputæœªå®šä¹‰"),ne(V=>({...V,[`${N}_followup`]:{accepted:!0,negotiatedContent:A}}))},className:"flex-1 px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-xs transition-colors flex items-center justify-center space-x-1",children:[e.jsx(rt,{className:"w-3 h-3"}),e.jsx("span",{children:"æŽ¥å—è¿½é—®"})]}),e.jsxs("button",{onClick:()=>M&&M(R.output),className:"flex-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs transition-colors flex items-center justify-center space-x-1",children:[e.jsx(gt,{className:"w-3 h-3"}),e.jsx("span",{children:"é‡æ–°ç”Ÿæˆ"})]})]})]}):e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:()=>{var G;const A=((G=H[`${N}_followup`])==null?void 0:G.negotiatedContent)||R.output;console.log("ðŸ”˜ é‡‡çº³è¿½é—®æŒ‰é’®è¢«ç‚¹å‡»",{finalText:A,onSetSolutionInput:!!q}),q?(console.log("ðŸ“ è°ƒç”¨onSetSolutionInput:",A),q(A),O&&O(),console.log("ðŸ”„ å·²é€€å‡ºè¿­ä»£æ¨¡å¼")):console.error("âŒ onSetSolutionInputæœªå®šä¹‰"),ne(V=>({...V,[`${N}_followup`]:{accepted:!0,negotiatedContent:A}}))},className:"flex-1 px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-xs transition-colors flex items-center justify-center space-x-1",children:[e.jsx(rt,{className:"w-3 h-3"}),e.jsx("span",{children:"é‡‡çº³è¿½é—®"})]}),e.jsxs("button",{onClick:()=>M&&M(R.output),className:"flex-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs transition-colors flex items-center justify-center space-x-1",children:[e.jsx(gt,{className:"w-3 h-3"}),e.jsx("span",{children:"é‡æ–°ç”Ÿæˆ"})]})]})]}),R.title.includes("ç”Ÿæˆéƒ¨é—¨è”ç»œ")&&R.structuredOutput&&e.jsx("div",{className:"mt-3 space-y-3",children:R.structuredOutput.contactInstruction&&e.jsxs("div",{className:"p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800",children:[e.jsx("div",{className:"text-xs font-medium text-blue-600 dark:text-blue-400 mb-1",children:"å†…éƒ¨è”ç»œæŒ‡ä»¤"}),e.jsx("div",{className:"text-sm text-blue-800 dark:text-blue-200 mb-2",children:R.structuredOutput.contactInstruction}),e.jsx("button",{onClick:()=>{ne(A=>({...A,[`${N}_department_only`]:{sent:!0}}))},className:"px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors",children:e.jsx("span",{children:(le=H[`${N}_department_only`])!=null&&le.sent?"å·²å‘é€":"å‘é€ç»™ç›¸å…³éƒ¨é—¨"})})]})}),R.title.includes("å®¢æˆ·å›žå¤å’Œéƒ¨é—¨è”ç»œ")&&!R.title.includes("ç”Ÿæˆéƒ¨é—¨è”ç»œ")&&R.structuredOutput&&e.jsxs("div",{className:"mt-3 space-y-3",children:[R.structuredOutput.customerReply&&e.jsxs("div",{className:"p-3 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800",children:[e.jsx("div",{className:"text-xs font-medium text-green-600 dark:text-green-400 mb-1",children:"ç»™å®¢æˆ·çš„å›žå¤"}),e.jsx("div",{className:"text-sm text-green-800 dark:text-green-200 mb-2",children:R.structuredOutput.customerReply}),e.jsxs("button",{onClick:()=>{const A=R.structuredOutput.customerReply;q&&(q(A),O&&O()),ne(G=>({...G,[`${N}_customerReply`]:{applied:!0}}))},className:`px-3 py-1 ${(Ce=H[`${N}_customerReply`])!=null&&Ce.applied?"bg-gray-500 cursor-not-allowed":"bg-green-500 hover:bg-green-600"} text-white rounded-lg text-xs transition-colors flex items-center space-x-1`,disabled:(pe=H[`${N}_customerReply`])==null?void 0:pe.applied,children:[e.jsx(Dt,{className:"w-3 h-3"}),e.jsx("span",{children:(Oe=H[`${N}_customerReply`])!=null&&Oe.applied?"å·²åº”ç”¨":"åº”ç”¨å®¢æˆ·å›žå¤"})]})]}),R.structuredOutput.contactInstruction&&e.jsxs("div",{className:"p-3 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800",children:[e.jsx("div",{className:"text-xs font-medium text-yellow-600 dark:text-yellow-400 mb-1",children:"å†…éƒ¨è”ç»œæŒ‡ä»¤"}),e.jsx("div",{className:"text-sm text-yellow-800 dark:text-yellow-200",children:R.structuredOutput.contactInstruction}),e.jsxs("button",{onClick:()=>{ne(A=>({...A,[`${N}_department`]:{sent:!0}}))},className:`mt-2 px-3 py-1 ${(Le=H[`${N}_department`])!=null&&Le.sent?"bg-gray-500 cursor-not-allowed":"bg-yellow-500 hover:bg-yellow-600"} text-white rounded-lg text-xs transition-colors flex items-center space-x-1`,disabled:($=H[`${N}_department`])==null?void 0:$.sent,children:[e.jsx(lt,{className:"w-3 h-3"}),e.jsx("span",{children:(Y=H[`${N}_department`])!=null&&Y.sent?"å·²å‘é€":"å‘é€ç»™ç›¸å…³éƒ¨é—¨"})]})]})]}),R.type==="ai_chat"&&e.jsxs("div",{className:"mt-3 space-y-3",children:[e.jsxs("div",{className:"p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800",children:[e.jsx("div",{className:"text-xs font-medium text-blue-600 dark:text-blue-400 mb-1",children:"æ‚¨çš„é—®é¢˜"}),e.jsx("div",{className:"text-sm text-blue-800 dark:text-blue-200",children:R.question})]}),e.jsxs("div",{className:"p-3 rounded-lg bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800",children:[e.jsxs("div",{className:"text-xs font-medium text-purple-600 dark:text-purple-400 mb-1 flex items-center space-x-1",children:[e.jsx(ke,{className:"w-3 h-3"}),e.jsx("span",{children:"AIå›žç­”"}),R.error&&e.jsx("span",{className:"text-red-500",children:"ï¼ˆå‡ºé”™ï¼‰"})]}),e.jsx("div",{className:"text-sm text-purple-800 dark:text-purple-200",children:R.answer})]})]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:new Date(R.timestamp).toLocaleTimeString()})]})]})})},`${N}-${R.timestamp}`)})})()})]}),e.jsx("div",{ref:$e})]})]})},Sn=({scenario:s,messages:t=[],onSendMessage:l,onSendToProblem:m,isProcessing:c,iterationMode:d,pendingResponse:u,directSendCandidate:x,onConfirmDirectSend:y,onCancelDirectSend:v,onGenerateSuggestion:b,onGenerateFollowUp:k,onGenerateDepartmentContact:C,onMarkContactInstructionSent:j,onMarkCustomerReplyApplied:M,onPrepareDirectSendCandidate:F,onConfirmSend:D,onCancelIteration:q,onSetInput:O,inputRef:U,settings:J,iterationProcessing:E,onAcceptSuggestion:K,onNegotiateSuggestion:ce,onCancelNegotiation:P,onSendNegotiationRequest:z,onRejectSuggestion:Z,onAcceptFollowUp:me,onNegotiateFollowUp:oe,onCancelFollowUpNegotiation:we,onSendFollowUpNegotiationRequest:ae,onRejectFollowUp:ue,onAcceptIntelligentFollowUp:Q,onNegotiateIntelligentFollowUp:$e,onCancelIntelligentFollowUpNegotiation:H,onSendIntelligentFollowUpNegotiationRequest:ne,onRejectIntelligentFollowUp:he,onGenerateIntelligentFollowUp:ee,onGenerateDepartmentContactOnly:ve,onChatWithAI:ge,onClearAiChatHistory:ze,onGenerateCustomerReplyForMessage:te,onNegotiateCustomerReplyCandidate:Ee,aiChatHistory:qe,currentScenario:L,missingInfoOptions:R,showMissingInfoPanel:se,onToggleMissingInfoOption:N,onGenerateFollowUpBySelectedInfo:I,onSkipInfoCollection:fe,chatMode:_,departmentModalVisible:Ie,emergencyModalVisible:xe,onSwitchChatMode:de,onCloseModeModal:Te,onCloseEmergencyModalOnly:Pe,onHandleEmergencyMode:Ae})=>{const[le,Ce]=f.useState(""),[pe,Oe]=f.useState(!1),Le=f.useRef(null),[$,Y]=f.useState({}),[A,G]=f.useState({}),[V,ye]=f.useState(""),[Ve,Ge]=f.useState("urgent");f.useEffect(()=>{var n;(n=Le.current)==null||n.scrollIntoView({behavior:"smooth"})},[t]),f.useEffect(()=>{O&&O(Ce)},[O]);const _e=(n="normal")=>{switch(n){case"department":return{primary:"rgba(34, 197, 94, 0.9)",secondary:"rgba(16, 185, 129, 0.85)",accent:"rgba(5, 150, 105, 0.8)",textLight:"text-green-100",iconColor:"text-green-100",bgAccent:"bg-green-600/30",borderAccent:"border-green-400/30"};case"emergency":return{primary:"rgba(239, 68, 68, 0.9)",secondary:"rgba(220, 38, 38, 0.85)",accent:"rgba(185, 28, 28, 0.8)",textLight:"text-red-100",iconColor:"text-red-100",bgAccent:"bg-red-600/30",borderAccent:"border-red-400/30"};case"normal":default:return{primary:"rgba(59, 130, 246, 0.9)",secondary:"rgba(99, 102, 241, 0.85)",accent:"rgba(14, 165, 233, 0.8)",textLight:"text-blue-100",iconColor:"text-blue-100",bgAccent:"bg-blue-600/30",borderAccent:"border-blue-400/30"}}},He=async n=>{if(!pe){Oe(!0);try{switch(n){case"suggestion":b&&b();break;case"followup":se?console.log("âš ï¸ ä¿¡æ¯é€‰æ‹©é¢æ¿å·²æ˜¾ç¤ºï¼Œè·³è¿‡å¿«æ·é”®è¿½é—®ç”Ÿæˆ"):ee&&ee();break;case"department":ve&&ve();break;case"chat":le.trim()&&ge&&(await ge(le.trim()),Ce(""));break;default:break}}catch(be){console.error("AIåŠŸèƒ½æ‰§è¡Œå¤±è´¥:",be)}finally{Oe(!1)}}},ot=n=>{if(n.key==="Enter")if(n.ctrlKey||n.metaKey){if(n.preventDefault(),!le.trim()||!m)return;const be={text:le.trim(),timestamp:new Date().toISOString(),type:"direct_reply",source:"ai_collaboration"};m(be),Ce("")}else n.shiftKey||(n.preventDefault(),He("chat"))};return e.jsxs("div",{className:"h-full flex flex-col glass-effect rounded-2xl overflow-hidden",style:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%)",backdropFilter:"blur(20px) saturate(1.3)",WebkitBackdropFilter:"blur(20px) saturate(1.3)",border:"1px solid rgba(255, 255, 255, 0.2)",height:"calc(100vh - 200px)"},children:[e.jsx("div",{className:"p-4 border-b border-white/20 dark:border-white/10 glass-effect rounded-t-2xl",style:{background:"linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.12) 100%)",backdropFilter:"blur(20px) saturate(1.3)"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-green-100/70 dark:bg-emerald-900/50 rounded-2xl backdrop-blur-sm",children:e.jsx(ft,{className:"w-5 h-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-white",children:"AI Collaboration"}),!1]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex items-center space-x-1 text-xs text-gray-500",children:[e.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"}),e.jsx("span",{children:"AI Online"})]}),qe&&qe.length>0&&e.jsxs("div",{className:"text-xs text-blue-600 dark:text-blue-400",children:["Turns: ",Math.floor(qe.length/2)]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 min-h-0",style:{background:"linear-gradient(135deg, rgba(255, 255, 255, 0.02) 0%, rgba(248, 250, 252, 0.01) 100%)",backdropFilter:"blur(10px) saturate(1.1)"},children:[(!t||t.length===0)&&e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center text-gray-500 dark:text-gray-400 space-y-4",children:[e.jsx(Se,{type:"fade",show:!0,children:e.jsx("div",{className:"p-4 bg-gradient-to-r from-green-100/80 to-emerald-100/80 dark:from-green-900/30 dark:to-emerald-900/30 rounded-full shadow-inner backdrop-blur-sm",children:e.jsx(ke,{className:"w-8 h-8 text-green-600 dark:text-green-400"})})}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Collaborate with AI to reply to customers"}),!1,!1,e.jsx("div",{className:"mt-4 p-3 rounded-lg border border-blue-200/50 dark:border-blue-800/50",style:{background:"linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(147, 197, 253, 0.05) 100%)",backdropFilter:"blur(10px) saturate(1.2)"}})]}),t&&t.map((n,be)=>{var Fe,Be,Ze,Je,Qe,We,Ue,Xe,et,tt,Ke,W,Re,Ye,De,ct,nt,dt,ut,pt,mt,r,a,p,h,S;return e.jsxs("div",{className:"space-y-2",children:[n.type==="user"&&e.jsx("div",{className:"flex justify-end",children:(()=>{_e(n.generatedInMode||_);const o={normal:{primary:"rgba(99, 102, 241, 0.9)",secondary:"rgba(139, 92, 246, 0.85)",textLight:"text-purple-100",iconColor:"text-purple-100"},department:{primary:"rgba(34, 197, 94, 0.9)",secondary:"rgba(16, 185, 129, 0.85)",textLight:"text-green-100",iconColor:"text-green-100"},emergency:{primary:"rgba(245, 101, 101, 0.9)",secondary:"rgba(239, 68, 68, 0.85)",textLight:"text-red-100",iconColor:"text-red-100"}},i=o[n.generatedInMode||_]||o.normal;return e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-br-md shadow-sm hover:shadow-md transition-all duration-200",style:{background:`linear-gradient(135deg, ${i.primary} 0%, ${i.secondary} 100%)`,color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:`text-xs font-medium ${i.textLight} mb-1 opacity-90`,children:["ðŸ‘¨â€ðŸ’¼ Agent",n.generatedInMode==="department"?" (contact mode)":n.generatedInMode==="emergency"?" (emergency mode)":""]}),e.jsx("div",{className:"whitespace-pre-wrap text-white select-text text-sm",children:n.text}),e.jsx("div",{className:`text-xs ${i.textLight} mt-1 opacity-90`,children:new Date(n.timestamp).toLocaleTimeString()})]}),e.jsx(at,{className:`w-4 h-4 ${i.iconColor} mt-0.5 flex-shrink-0`})]})})})()}),n.type==="ai_chat"&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex items-start justify-start",children:(()=>{const o=_e(n.generatedInMode||_);return e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-bl-md shadow-sm hover:shadow-md transition-all duration-200",style:{background:n.error?"linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.85) 100%)":`linear-gradient(135deg, ${o.primary} 0%, ${o.secondary} 100%)`,color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ke,{className:`w-4 h-4 ${o.iconColor} mt-0.5 flex-shrink-0`}),n.isStreaming&&e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:`text-xs font-medium ${o.textLight} mb-1 opacity-90 flex items-center space-x-1`,children:[e.jsxs("span",{children:["ðŸ¤– AI assistant",n.generatedInMode==="department"?" (contact mode)":n.generatedInMode==="emergency"?" (emergency mode)":""]}),n.isStreaming&&e.jsx("span",{className:"text-green-200 animate-pulse",children:"Answering..."}),n.error&&e.jsx("span",{className:"text-red-200",children:"(Error)"})]}),e.jsxs("div",{className:"whitespace-pre-wrap text-white select-text leading-relaxed text-sm",children:[n.isStreaming?n.text:n.answer||n.text,n.isStreaming&&e.jsx("span",{className:"ml-1 inline-block w-2 h-5 bg-white opacity-75 animate-pulse align-text-bottom"})]}),e.jsxs("div",{className:`text-xs ${o.textLight} mt-2 opacity-90 flex items-center justify-between`,children:[e.jsx("span",{children:n.isStreaming?"Generating...":new Date(n.timestamp).toLocaleTimeString()}),n.conversationId&&e.jsxs("span",{className:`text-xs ${o.bgAccent} px-2 py-1 rounded`,children:["#",n.conversationId.toString().slice(-4)]})]})]})]})})})()}),e.jsx("div",{className:"ml-2 mt-1",children:e.jsx("button",{onClick:async()=>{if(console.log("ðŸ” ç”Ÿæˆå®¢æˆ·å›žå¤æŒ‰é’®è¢«ç‚¹å‡»"),console.log("ðŸ” onGenerateCustomerReplyForMessage æ˜¯å¦å­˜åœ¨:",!!te),!te){console.log("âŒ onGenerateCustomerReplyForMessage å‡½æ•°æœªä¼ é€’");return}console.log("ðŸ” å¼€å§‹è°ƒç”¨ onGenerateCustomerReplyForMessage");try{const o=await te({text:n.answer||n.text,answer:n.answer,translation:n.translation,suggestion:n.suggestion,aiAdvice:n.aiAdvice,timestamp:n.timestamp});console.log("ðŸ” å®¢æˆ·å›žå¤ç”Ÿæˆç»“æžœ:",{optimized:o,type:typeof o})}catch(o){console.error("âŒ ç”Ÿæˆå®¢æˆ·å›žå¤æ—¶å‘ç”Ÿé”™è¯¯:",o)}},className:"px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors disabled:opacity-50",disabled:n.isStreaming,title:"Generate a customer reply based on this AI message as a separate bubble",children:"Generate customer reply"})})]}),n.type==="suggestion"&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"flex items-start justify-start",children:[(()=>{const o=_e(n.generatedInMode||_);return e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-bl-md shadow-sm hover:shadow-md transition-all duration-200",style:{background:`linear-gradient(135deg, ${o.primary} 0%, ${o.secondary} 100%)`,color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(_t,{className:`w-4 h-4 ${o.iconColor} mt-0.5 flex-shrink-0`}),n.isStreaming&&e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:`text-xs font-medium ${o.textLight} mb-1 opacity-90 flex items-center space-x-1`,children:[e.jsxs("span",{children:["ðŸ’¡ AI suggestion",n.generatedInMode==="department"?" (contact mode)":n.generatedInMode==="emergency"?" (emergency mode)":""]}),n.isStreaming&&e.jsx("span",{className:"text-green-200 animate-pulse",children:"Generating..."})]}),e.jsxs("div",{className:"whitespace-pre-wrap text-white select-text text-sm",children:[n.text,n.isStreaming&&e.jsx("span",{className:"ml-1 inline-block w-2 h-5 bg-white opacity-75 animate-pulse align-text-bottom"})]}),e.jsx("div",{className:`text-xs ${o.textLight} mt-1 opacity-90`,children:n.isStreaming?"Generating...":new Date(n.timestamp).toLocaleTimeString()})]})]})})})(),e.jsxs("div",{className:"ml-2 mt-1 space-x-2",children:[e.jsx("button",{onClick:async()=>{te&&await te({text:n.text,translation:n.translation,suggestion:n.text,aiAdvice:n.aiAdvice,timestamp:n.timestamp})},className:"px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors disabled:opacity-50",disabled:n.isStreaming,title:"Generate a customer reply based on this AI message as a separate bubble",children:"ç”Ÿæˆå®¢æˆ·å›žå¤"}),e.jsx("button",{onClick:()=>{G(o=>{var i;return{...o,[n.id]:{...o[n.id]||{},showNegotiation:!((i=o[n.id])!=null&&i.showNegotiation)}}})},className:"px-2 py-1 text-xs bg-purple-600 hover:bg-purple-700 text-white rounded-md transition-colors disabled:opacity-50",disabled:n.isStreaming,title:"Negotiate this follow-up",children:"åå•†ä¿®æ”¹"})]}),((Fe=A[n.id])==null?void 0:Fe.showNegotiation)&&e.jsxs("div",{className:"ml-2 mt-2 bg-white/10 border border-white/20 rounded-md p-2 max-w-[80%]",children:[e.jsx("textarea",{value:((Be=A[n.id])==null?void 0:Be.nego)||"",onChange:o=>G(i=>({...i,[n.id]:{...i[n.id]||{},nego:o.target.value}})),placeholder:"è¯´æ˜Žä½ å¸Œæœ›å¦‚ä½•è°ƒæ•´è¿™æ¡æ™ºèƒ½è¿½é—®...",className:"w-full p-2 bg-transparent text-white placeholder-white/70 border border-white/30 rounded mb-2 text-xs resize-none",rows:3}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:async()=>{var i;const o=(((i=A[n.id])==null?void 0:i.nego)||"").trim();o&&typeof ae=="function"&&await ae(n.id,o,w=>{G(g=>({...g,[n.id]:{...g[n.id]||{},showNegotiation:!1,nego:""}}))})},className:"px-2 py-1 text-xs bg-purple-600 hover:bg-purple-700 text-white rounded-md",children:"å‘é€åå•†"}),e.jsx("button",{onClick:()=>G(o=>({...o,[n.id]:{...o[n.id]||{},showNegotiation:!1}})),className:"px-2 py-1 text-xs bg-gray-500 hover:bg-gray-600 text-white rounded-md",children:"å–æ¶ˆ"})]})]})]})}),(n.type==="followup"||n.type==="intelligent_followup")&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"flex items-start justify-start",children:[(()=>{const o=_e(n.generatedInMode||_);return e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-bl-md shadow-sm hover:shadow-md transition-all duration-200",style:{background:`linear-gradient(135deg, ${o.primary} 0%, ${o.secondary} 100%)`,color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(St,{className:`w-4 h-4 ${o.iconColor} mt-0.5 flex-shrink-0`}),n.isStreaming&&e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:`text-xs font-medium ${o.textLight} mb-1 opacity-90 flex items-center space-x-1`,children:[e.jsxs("span",{children:["ðŸ” Smart follow-up",n.generatedInMode==="department"?" (contact mode)":n.generatedInMode==="emergency"?" (emergency mode)":""]}),n.isStreaming&&e.jsx("span",{className:"text-green-200 animate-pulse",children:"Generating..."})]}),e.jsxs("div",{className:"whitespace-pre-wrap text-white select-text text-sm",children:[n.text,n.isStreaming&&e.jsx("span",{className:"ml-1 inline-block w-2 h-5 bg-white opacity-75 animate-pulse align-text-bottom"})]}),e.jsx("div",{className:`text-xs ${o.textLight} mt-1 opacity-90`,children:n.isStreaming?"Generating...":new Date(n.timestamp).toLocaleTimeString()})]})]})})})(),e.jsx("div",{className:"ml-2 mt-1",children:e.jsx("button",{onClick:async()=>{te&&await te({text:n.text,translation:n.translation,suggestion:n.text,aiAdvice:n.aiAdvice,timestamp:n.timestamp})},className:"px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors disabled:opacity-50",disabled:n.isStreaming,title:"Generate a customer reply based on this AI message as a separate bubble",children:"ç”Ÿæˆå®¢æˆ·å›žå¤"})})]})}),n.type==="department_contact"&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"flex items-start justify-start",children:[e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-bl-md shadow-sm hover:shadow-md transition-all duration-200",style:{background:"linear-gradient(135deg, rgba(34, 197, 94, 0.9) 0%, rgba(16, 185, 129, 0.85) 100%)",color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(lt,{className:"w-4 h-4 text-green-100 mt-0.5 flex-shrink-0"}),n.isStreaming&&e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-xs font-medium text-green-100 mb-1 opacity-90 flex items-center space-x-1",children:[e.jsx("span",{children:"ðŸ¢ Department contact"}),n.isStreaming&&e.jsx("span",{className:"text-green-200 animate-pulse",children:"Generating..."})]}),e.jsxs("div",{className:"whitespace-pre-wrap text-white select-text text-sm",children:[n.text,n.isStreaming&&e.jsx("span",{className:"ml-1 inline-block w-2 h-5 bg-white opacity-75 animate-pulse align-text-bottom"})]}),e.jsx("div",{className:"text-xs text-green-100 mt-1 opacity-90",children:n.isStreaming?"Generating...":new Date(n.timestamp).toLocaleTimeString()})]})]})}),e.jsx("div",{className:"ml-2 mt-1",children:e.jsx("button",{onClick:async()=>{te&&await te({text:n.text,translation:n.translation,suggestion:n.text,aiAdvice:n.aiAdvice,timestamp:n.timestamp})},className:"px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors disabled:opacity-50",disabled:n.isStreaming,title:"Generate a customer reply based on this AI message as a separate bubble",children:"ç”Ÿæˆå®¢æˆ·å›žå¤"})})]})}),n.type==="comprehensive_analysis"&&!n.question&&e.jsxs("div",{className:"flex items-start justify-start",children:[(()=>{const o=_e(n.generatedInMode||_);return e.jsx("div",{className:"max-w-[85%] p-4 rounded-2xl rounded-bl-md shadow-sm hover:shadow-md transition-all duration-200",style:{background:`linear-gradient(135deg, ${o.primary} 0%, ${o.secondary} 100%)`,color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ke,{className:`w-5 h-5 ${o.iconColor} mt-0.5 flex-shrink-0`}),n.isStreaming&&e.jsx("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm font-medium text-purple-100 mb-2 opacity-90 flex items-center space-x-1",children:[e.jsx("span",{children:"ðŸ§  Comprehensive analysis"}),n.isStreaming&&e.jsx("span",{className:"text-green-200 animate-pulse text-xs",children:"æ­£åœ¨åˆ†æž..."})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-xs text-purple-100 mb-1 opacity-90",children:"ðŸ“‹ Needs analysis:"}),e.jsxs("div",{className:"whitespace-pre-wrap text-white select-text mb-2 text-sm",children:[n.text,n.isStreaming&&e.jsx("span",{className:"ml-1 inline-block w-2 h-4 bg-white opacity-75 animate-pulse align-text-bottom"})]}),e.jsx("div",{className:"whitespace-pre-wrap text-white select-text italic opacity-90 pl-3 border-l-2 border-purple-300/50 text-sm",children:n.isStreaming?"Translating...":n.translation&&n.translation.trim()?n.translation:`Customer inquiry: ${n.text}. Suggest asking for specific needs to provide an accurate solution.`})]}),(n.suggestion||n.aiAdvice)&&e.jsxs("div",{className:"pt-2 border-t border-purple-300/30",children:[e.jsx("div",{className:"text-xs text-purple-100 mb-1 opacity-90",children:"ðŸ’¡ AI suggestion:"}),e.jsxs("div",{className:"bg-purple-600/30 rounded-lg p-3 space-y-2",children:[n.suggestion&&e.jsx("div",{className:"whitespace-pre-wrap text-white select-text text-sm",children:n.suggestion}),n.aiAdvice&&e.jsx("div",{className:"whitespace-pre-wrap text-white select-text opacity-90 italic border-l-2 border-purple-200/50 pl-3 text-sm",children:n.aiAdvice})]})]}),e.jsx("div",{className:"text-xs text-purple-100 mt-2 opacity-90",children:n.isStreaming?"Analyzing...":new Date(n.timestamp).toLocaleTimeString()})]})]})})})(),e.jsx("div",{className:"ml-2 mt-1",children:e.jsx("button",{onClick:async()=>{te&&await te({text:n.translation||n.suggestion||n.aiAdvice||n.text,translation:n.translation,suggestion:n.suggestion,aiAdvice:n.aiAdvice,timestamp:n.timestamp})},className:"px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors disabled:opacity-50",disabled:n.isStreaming,title:"Generate a customer reply as a separate bubble",children:"Generate customer reply"})})]}),n.type==="needs_analysis"&&e.jsx("div",{className:"flex justify-start",children:(()=>{const o=_e(n.generatedInMode||_);return e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-bl-md shadow-sm hover:shadow-md transition-all duration-200",style:{background:`linear-gradient(135deg, ${o.primary} 0%, ${o.secondary} 100%)`,color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(ke,{className:`w-4 h-4 ${o.iconColor} mt-0.5 flex-shrink-0`}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:`text-xs font-medium ${o.textLight} mb-1 opacity-90`,children:["ðŸ§  Intelligent needs analysis",n.generatedInMode==="department"?" (contact mode)":n.generatedInMode==="emergency"?" (emergency mode)":""]}),e.jsxs("div",{className:"mb-2",children:[e.jsx("div",{className:`text-xs ${o.textLight} mb-1 opacity-90`,children:"ðŸ“‹ éœ€æ±‚ç†è§£ï¼š"}),e.jsx("div",{className:"whitespace-pre-wrap text-white select-text text-sm",children:n.text})]}),e.jsxs("div",{className:`mb-2 pt-2 border-t ${o.textLight.replace("text","border")}/30`,children:[e.jsx("div",{className:`text-xs ${o.textLight} mb-1 opacity-90`,children:"ðŸ”„ éœ€æ±‚è½¬è¯‘ï¼š"}),e.jsx("div",{className:"whitespace-pre-wrap text-white select-text italic text-sm",children:n.translation&&n.translation.trim()?n.translation:`å®¢æˆ·å’¨è¯¢ï¼š${n.text}ï¼Œå»ºè®®äº†è§£å®¢æˆ·çš„å…·ä½“éœ€æ±‚ä»¥æä¾›ç²¾å‡†çš„æœåŠ¡è§£å†³æ–¹æ¡ˆã€‚`})]}),n.missingInfoOptions&&n.missingInfoOptions.length>0&&e.jsxs("div",{className:`mt-2 pt-2 border-t ${o.textLight.replace("text","border")}/30`,children:[e.jsx("div",{className:`text-xs ${o.textLight} mb-1`,children:"ðŸ’¡ å‘çŽ°å¯äº†è§£ä¿¡æ¯ï¼š"}),e.jsx("ul",{className:`text-xs ${o.textLight} space-y-1`,children:n.missingInfoOptions.map((i,w)=>e.jsxs("li",{children:["â€¢ ",i.name]},w))})]}),e.jsx("div",{className:`text-xs ${o.textLight} mt-1 opacity-90`,children:new Date(n.timestamp).toLocaleTimeString()})]})]})})})()}),n.type==="department_suggestion"&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-bl-md shadow-sm hover:shadow-md transition-all duration-200",style:{background:"linear-gradient(135deg, rgba(34, 197, 94, 0.9) 0%, rgba(16, 185, 129, 0.85) 100%)",color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(yt,{className:"w-4 h-4 text-green-100 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-xs font-medium text-green-100 mb-1 opacity-90",children:"ðŸ“ž Department contact suggestion"}),e.jsx("div",{className:"whitespace-pre-wrap text-white select-text leading-relaxed text-sm",children:n.text}),e.jsx("div",{className:"text-xs text-green-100 mt-2 opacity-90",children:new Date(n.timestamp).toLocaleTimeString()})]})]})})}),n.type==="department_contact_with_instructions"&&e.jsx("div",{className:"flex justify-start",children:(()=>{const o=_e(n.generatedInMode||_);return e.jsx("div",{className:"max-w-[90%] p-4 rounded-2xl rounded-bl-md shadow-lg hover:shadow-xl transition-all duration-200",style:{background:`linear-gradient(135deg, ${o.primary} 0%, ${o.secondary} 50%, ${o.accent} 100%)`,color:"white",border:`1px solid ${o.primary.replace("0.9","0.2")}`,boxShadow:`0 8px 25px -5px ${o.primary.replace("0.9","0.25")}`},children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"p-2 rounded-lg bg-white/20 backdrop-blur-sm",children:e.jsx(yt,{className:`w-5 h-5 ${o.iconColor}`})}),n.isStreaming&&e.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full border-2 border-white animate-pulse"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsxs("div",{className:`text-sm font-semibold ${o.textLight}`,children:["ðŸ”— Smart department contact plan",_==="emergency"?" (emergency)":_==="department"?" (contact mode)":""]}),e.jsxs("div",{className:`text-xs bg-white/20 px-2 py-0.5 rounded-full ${o.textLight}`,children:["AIç”Ÿæˆ",n.isStreaming&&"ä¸­..."]})]}),e.jsxs("div",{className:"whitespace-pre-wrap text-white select-text leading-relaxed text-sm",children:[n.text,n.isStreaming&&e.jsx("span",{className:"ml-1 inline-block w-2 h-5 bg-white opacity-75 animate-pulse align-text-bottom"})]}),e.jsxs("div",{className:`flex items-center justify-between mt-3 pt-2 border-t ${o.textLight.replace("text","border")}/20`,children:[e.jsx("div",{className:`text-xs ${o.textLight} opacity-90`,children:n.isStreaming?"Generating...":new Date(n.timestamp).toLocaleTimeString()}),n.isDefault&&e.jsx("div",{className:`text-xs ${o.textLight}/70 italic`,children:"åŸºäºŽåœºæ™¯é»˜è®¤æ–¹æ¡ˆ"})]})]})]})})})()}),n.type==="emergency_response"&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-bl-md shadow-sm hover:shadow-md transition-all duration-200",style:{background:"linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.85) 100%)",color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(it,{className:"w-4 h-4 text-red-100 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-xs font-medium text-red-100 mb-1 opacity-90 flex items-center space-x-2",children:[e.jsx("span",{children:"âš ï¸ Emergency handling plan"}),n.escalated&&e.jsx("span",{className:"bg-red-600/50 px-2 py-0.5 rounded text-xs",children:"å·²å‡çº§"})]}),e.jsx("div",{className:"whitespace-pre-wrap text-white select-text leading-relaxed text-sm",children:n.text}),e.jsxs("div",{className:"text-xs text-red-100 mt-2 opacity-90 flex items-center justify-between",children:[e.jsx("span",{children:new Date(n.timestamp).toLocaleTimeString()}),e.jsx("span",{className:"bg-red-600/30 px-2 py-0.5 rounded",children:n.urgencyLevel==="critical"?"å…³é”®çº§":n.urgencyLevel==="urgent"?"Urgent":"High"})]})]})]})})}),n.type==="escalation_notice"&&e.jsx("div",{className:"flex justify-center",children:e.jsx("div",{className:"max-w-[60%] p-2 rounded-lg shadow-sm",style:{background:"linear-gradient(135deg, rgba(245, 158, 11, 0.9) 0%, rgba(217, 119, 6, 0.85) 100%)",color:"white"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs font-medium text-amber-100 mb-1",children:"ðŸ“¢ ç³»ç»Ÿé€šçŸ¥"}),e.jsx("div",{className:"text-xs text-white select-text",children:n.text})]})})}),(n.type==="emergency_error"||n.isError)&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-bl-md shadow-sm",style:{background:"linear-gradient(135deg, rgba(156, 163, 175, 0.9) 0%, rgba(107, 114, 128, 0.85) 100%)",color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(vt,{className:"w-4 h-4 text-gray-200 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-xs font-medium text-gray-200 mb-1 opacity-90",children:"âŒ ç³»ç»Ÿé”™è¯¯"}),e.jsx("div",{className:"text-sm text-white select-text",children:n.text}),e.jsx("div",{className:"text-xs text-gray-200 mt-1 opacity-90",children:new Date(n.timestamp).toLocaleTimeString()})]})]})})}),n.type==="intelligent_followup_candidate"&&e.jsx("div",{className:"flex items-start justify-start",children:e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-bl-md shadow-sm hover:shadow-md transition-all duration-200",style:{background:"linear-gradient(135deg, rgba(168, 85, 247, 0.92) 0%, rgba(124, 58, 237, 0.88) 100%)",color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(St,{className:"w-4 h-4 text-purple-100 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-xs font-medium text-purple-100 mb-1 opacity-90 flex items-center space-x-1",children:[e.jsx("span",{children:"ðŸ¤” æ™ºèƒ½è¿½é—®è‰ç¨¿"}),n.isStreaming&&e.jsx("span",{className:"text-green-200 animate-pulse",children:"æ­£åœ¨ç”Ÿæˆ..."}),n.error&&e.jsx("span",{className:"text-red-200",children:"ï¼ˆå‡ºé”™ï¼‰"})]}),(Ze=$[n.id])!=null&&Ze.isEditing?e.jsx("textarea",{value:((Je=$[n.id])==null?void 0:Je.text)??n.text,onChange:o=>Y(i=>({...i,[n.id]:{isEditing:!0,text:o.target.value}})),className:"w-full mt-1 p-2 bg-white/10 border border-white/30 rounded-md text-white text-sm resize-none focus:outline-none focus:ring-2 focus:ring-white/40",rows:3}):e.jsxs("div",{className:"whitespace-pre-wrap text-white select-text text-sm",children:[((Qe=$[n.id])==null?void 0:Qe.text)??n.text,n.isStreaming&&e.jsx("span",{className:"ml-1 inline-block w-2 h-5 bg-white opacity-75 animate-pulse align-text-bottom"})]}),!n.isStreaming&&!n.error&&e.jsxs("div",{className:"mt-2 flex space-x-2",children:[(We=$[n.id])!=null&&We.isEditing?e.jsx("button",{onClick:()=>Y(o=>({...o,[n.id]:{...o[n.id]||{},isEditing:!1}})),className:"px-2 py-1 text-xs bg-white/20 hover:bg-white/30 text-white rounded-md border border-white/30",children:"å®Œæˆç¼–è¾‘"}):e.jsx("button",{onClick:()=>Y(o=>{var i;return{...o,[n.id]:{isEditing:!0,text:((i=o[n.id])==null?void 0:i.text)??n.text}}}),className:"px-2 py-1 text-xs bg-white/20 hover:bg-white/30 text-white rounded-md border border-white/30",children:"ç¼–è¾‘ä¿®æ”¹"}),e.jsx("button",{onClick:()=>{var w;if(!m)return;const i=((((w=$[n.id])==null?void 0:w.text)??n.text)||"").trim();i&&m({text:i,timestamp:new Date().toISOString()})},className:"px-2 py-1 text-xs bg-green-600 hover:bg-green-700 text-white rounded-md",children:"ç›´æŽ¥å‘é€"}),e.jsx("button",{onClick:()=>{Y(o=>({...o,[n.id]:{...o[n.id]||{},showNegotiation:!0}}))},className:"px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded-md",children:"åå•†ä¿®æ”¹"})]}),((Ue=$[n.id])==null?void 0:Ue.showNegotiation)&&e.jsxs("div",{className:"mt-2 bg-white/10 border border-white/30 rounded-md p-2",children:[e.jsx("textarea",{value:((Xe=$[n.id])==null?void 0:Xe.nego)||"",onChange:o=>Y(i=>({...i,[n.id]:{...i[n.id]||{},nego:o.target.value}})),placeholder:"è¯´æ˜Žå¸Œæœ›å¦‚ä½•è°ƒæ•´è¿™æ¡æ™ºèƒ½è¿½é—®...",className:"w-full p-2 bg-transparent text-white placeholder-white/70 border border-white/30 rounded mb-2 text-xs resize-none",rows:3}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:async()=>{var i,w;const o=(((i=$[n.id])==null?void 0:i.nego)||"").trim();if(!(!o||(w=$[n.id])!=null&&w.negoSubmitting)){Y(g=>({...g,[n.id]:{...g[n.id]||{},negoSubmitting:!0}}));try{typeof ne=="function"&&await ne(n.id,o,g=>{Y(T=>({...T,[n.id]:{...T[n.id]||{},showNegotiation:!1,nego:"",text:g}}))})}catch(g){console.error("å‘é€åå•†å¤±è´¥:",g)}finally{Y(g=>({...g,[n.id]:{...g[n.id]||{},negoSubmitting:!1}}))}}},disabled:!(((et=$[n.id])==null?void 0:et.nego)||"").trim()||((tt=$[n.id])==null?void 0:tt.negoSubmitting),className:`px-2 py-1 text-xs rounded-md text-white ${(Ke=$[n.id])!=null&&Ke.negoSubmitting?"bg-blue-400 cursor-not-allowed":"bg-blue-500 hover:bg-blue-600"}`,children:(W=$[n.id])!=null&&W.negoSubmitting?e.jsxs("span",{className:"inline-flex items-center space-x-1",children:[e.jsx("span",{className:"w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):"å‘é€åå•†"}),e.jsx("button",{onClick:()=>Y(o=>({...o,[n.id]:{...o[n.id]||{},showNegotiation:!1}})),disabled:(Re=$[n.id])==null?void 0:Re.negoSubmitting,className:`px-2 py-1 text-xs text-white rounded-md ${(Ye=$[n.id])!=null&&Ye.negoSubmitting?"bg-gray-400 cursor-not-allowed":"bg-gray-500 hover:bg-gray-600"}`,children:"Cancel"})]})]}),e.jsx("div",{className:"text-xs text-purple-100 mt-1 opacity-90",children:new Date(n.timestamp).toLocaleTimeString()})]})]})})}),n.type==="customer_reply_candidate"&&e.jsx("div",{className:"flex items-start justify-start",children:e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-bl-md shadow-sm hover:shadow-md transition-all duration-200",style:{background:"linear-gradient(135deg, rgba(59, 130, 246, 0.92) 0%, rgba(37, 99, 235, 0.88) 100%)",color:"white"},children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx(ke,{className:"w-4 h-4 text-blue-100 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-xs font-medium text-blue-100 mb-1 opacity-90 flex items-center space-x-1",children:[e.jsx("span",{children:"ðŸ“ å®¢æˆ·å›žå¤è‰ç¨¿"}),n.isStreaming&&e.jsx("span",{className:"text-green-200 animate-pulse",children:"æ­£åœ¨ç”Ÿæˆ..."}),n.error&&e.jsx("span",{className:"text-red-200",children:"ï¼ˆå‡ºé”™ï¼‰"})]}),(De=$[n.id])!=null&&De.isEditing?e.jsx("textarea",{value:((ct=$[n.id])==null?void 0:ct.text)??n.text,onChange:o=>Y(i=>({...i,[n.id]:{isEditing:!0,text:o.target.value}})),className:"w-full mt-1 p-2 bg-white/10 border border-white/30 rounded-md text-white text-sm resize-none focus:outline-none focus:ring-2 focus:ring-white/40",rows:4}):e.jsxs("div",{className:"whitespace-pre-wrap text-white select-text text-sm",children:[((nt=$[n.id])==null?void 0:nt.text)??n.text,n.isStreaming&&e.jsx("span",{className:"ml-1 inline-block w-2 h-5 bg-white opacity-75 animate-pulse align-text-bottom"})]}),!n.isStreaming&&!n.error&&e.jsxs("div",{className:"mt-2 flex space-x-2",children:[(dt=$[n.id])!=null&&dt.isEditing?e.jsx("button",{onClick:()=>Y(o=>({...o,[n.id]:{...o[n.id]||{},isEditing:!1}})),className:"px-2 py-1 text-xs bg-white/20 hover:bg-white/30 text-white rounded-md border border-white/30",children:"å®Œæˆç¼–è¾‘"}):e.jsx("button",{onClick:()=>Y(o=>{var i;return{...o,[n.id]:{isEditing:!0,text:((i=o[n.id])==null?void 0:i.text)??n.text}}}),className:"px-2 py-1 text-xs bg-white/20 hover:bg-white/30 text-white rounded-md border border-white/30",children:"ç¼–è¾‘ä¿®æ”¹"}),e.jsx("button",{onClick:()=>{var w;if(!m)return;const i=((((w=$[n.id])==null?void 0:w.text)??n.text)||"").trim();i&&m({text:i,timestamp:new Date().toISOString()})},className:"px-2 py-1 text-xs bg-green-600 hover:bg-green-700 text-white rounded-md",children:"ç›´æŽ¥å‘é€"}),e.jsx("button",{onClick:()=>Y(o=>({...o,[n.id]:{...o[n.id]||{},showReplyNegotiation:!0}})),className:"px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded-md",children:"åå•†ä¿®æ”¹"})]}),((ut=$[n.id])==null?void 0:ut.showReplyNegotiation)&&e.jsxs("div",{className:"mt-2 bg-white/10 border border-white/30 rounded-md p-2",children:[e.jsx("textarea",{value:((pt=$[n.id])==null?void 0:pt.replyNego)||"",onChange:o=>Y(i=>({...i,[n.id]:{...i[n.id]||{},replyNego:o.target.value}})),placeholder:"è¯´æ˜Žå¸Œæœ›å¦‚ä½•è°ƒæ•´è¿™æ¡å®¢æˆ·å›žå¤...",className:"w-full p-2 bg-transparent text-white placeholder-white/70 border border-white/30 rounded mb-2 text-xs resize-none",rows:3}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:async()=>{var i,w;const o=(((i=$[n.id])==null?void 0:i.replyNego)||"").trim();if(!(!o||(w=$[n.id])!=null&&w.replySubmitting)){Y(g=>({...g,[n.id]:{...g[n.id]||{},replySubmitting:!0}}));try{typeof Ee=="function"&&await Ee(n.id,o,g=>{Y(T=>({...T,[n.id]:{...T[n.id]||{},showReplyNegotiation:!1,replyNego:"",text:g}}))})}catch(g){console.error("å®¢æˆ·å›žå¤åå•†å¤±è´¥:",g)}finally{Y(g=>({...g,[n.id]:{...g[n.id]||{},replySubmitting:!1}}))}}},disabled:!(((mt=$[n.id])==null?void 0:mt.replyNego)||"").trim()||((r=$[n.id])==null?void 0:r.replySubmitting),className:`px-2 py-1 text-xs rounded-md text-white ${(a=$[n.id])!=null&&a.replySubmitting?"bg-blue-400 cursor-not-allowed":"bg-blue-500 hover:bg-blue-600"}`,children:(p=$[n.id])!=null&&p.replySubmitting?e.jsxs("span",{className:"inline-flex items-center space-x-1",children:[e.jsx("span",{className:"w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):"å‘é€åå•†"}),e.jsx("button",{onClick:()=>Y(o=>({...o,[n.id]:{...o[n.id]||{},showReplyNegotiation:!1}})),disabled:(h=$[n.id])==null?void 0:h.replySubmitting,className:`px-2 py-1 text-xs text-white rounded-md ${(S=$[n.id])!=null&&S.replySubmitting?"bg-gray-400 cursor-not-allowed":"bg-gray-500 hover:bg-gray-600"}`,children:"Cancel"})]})]}),e.jsx("div",{className:"text-xs text-blue-100 mt-1 opacity-90",children:new Date(n.timestamp).toLocaleTimeString()})]})]})})})]},be)}),(c||E||pe)&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"max-w-[80%] p-3 rounded-2xl rounded-bl-md shadow-sm",style:{background:"linear-gradient(135deg, rgba(156, 163, 175, 0.9) 0%, rgba(107, 114, 128, 0.85) 100%)",color:"white"},children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-white",children:"AI is thinking..."})]})})}),e.jsx("div",{ref:Le})]}),se&&e.jsx(Se,{type:"slide-up",show:!0,children:e.jsx("div",{className:"p-4 border-t border-white/20 dark:border-white/10",style:{background:"linear-gradient(135deg, rgba(251, 146, 60, 0.08) 0%, rgba(251, 191, 36, 0.06) 100%)",backdropFilter:"blur(20px) saturate(1.3)",WebkitBackdropFilter:"blur(20px) saturate(1.3)",border:"1px solid rgba(251, 146, 60, 0.2)",borderRadius:"12px"},children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-orange-800 dark:text-orange-200",children:[e.jsx(vt,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-semibold",children:"é€‰æ‹©å¸Œæœ›äº†è§£çš„ä¿¡æ¯"})]}),e.jsx("p",{className:"text-xs text-orange-700 dark:text-orange-300",children:"AIåˆ†æžå‘çŽ°å¯ä»¥äº†è§£ä»¥ä¸‹ä¿¡æ¯ä»¥æä¾›æ›´ç²¾å‡†çš„æœåŠ¡ï¼Œè¯·é€‰æ‹©æ‚¨å¸Œæœ›è¯¢é—®çš„ä¿¡æ¯ç‚¹ï¼š"}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:R.map((n,be)=>e.jsx("div",{className:`p-3 rounded-lg border-2 cursor-pointer transition-all duration-200 ${n.selected?"border-orange-300 bg-orange-100 dark:bg-orange-900/30":"border-gray-200 bg-white dark:bg-gray-800 hover:border-orange-200"}`,onClick:()=>N&&N(be),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:`mt-1 w-5 h-5 rounded-full border-2 flex items-center justify-center ${n.selected?"border-orange-500 bg-orange-500":"border-gray-300"}`,children:n.selected&&e.jsx(on,{className:"w-3 h-3 text-white"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:n.name}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300 mt-1",children:n.description})]})]})},be))}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:()=>{if(console.log("ðŸ”„ ç”Ÿæˆè¿½é—®æŒ‰é’®è¢«ç‚¹å‡»"),E){console.log("âš ï¸ Processing, ignoring click");return}I()},disabled:E||!R.some(n=>n.selected),className:"flex-1 btn-primary p-3 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none transition-all duration-200 hover:scale-105 flex items-center justify-center space-x-2",children:E?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"ç”Ÿæˆä¸­..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(At,{className:"w-4 h-4"}),e.jsxs("span",{children:["ç›´æŽ¥ç”Ÿæˆè¿½é—® (",R.filter(n=>n.selected).length,")"]})]})}),e.jsx("button",{onClick:fe,disabled:E,className:"px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2",children:e.jsx("span",{children:"è·³è¿‡"})})]})]})})}),e.jsxs("div",{className:"p-4 border-t border-white/20 dark:border-white/10 glass-effect rounded-b-2xl flex-shrink-0",style:{background:"linear-gradient(135deg, rgba(248, 250, 252, 0.08) 0%, rgba(241, 245, 249, 0.05) 100%)",backdropFilter:"blur(20px) saturate(1.3)",WebkitBackdropFilter:"blur(20px) saturate(1.3)"},children:[!1,e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("button",{onClick:()=>de&&de("normal"),disabled:pe||c,className:`p-2 rounded-lg transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed ${_==="normal"?"bg-gradient-to-r from-blue-500/30 to-cyan-500/30 border-2 border-blue-500/50 shadow-lg":"bg-gradient-to-r from-blue-500/10 to-cyan-500/10 border border-blue-500/20 hover:from-blue-500/20 hover:to-cyan-500/20"}`,title:"Normal chat",children:e.jsxs("div",{className:"flex flex-col items-center space-y-1",children:[e.jsx(dn,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),e.jsx("div",{className:"text-xs font-medium text-blue-700 dark:text-blue-300",children:"Normal"})]})}),e.jsx("button",{onClick:()=>de&&de("department"),disabled:pe||c,className:`p-2 rounded-lg transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed ${_==="department"?"bg-gradient-to-r from-green-500/30 to-emerald-500/30 border-2 border-green-500/50 shadow-lg":"bg-gradient-to-r from-green-500/10 to-emerald-500/10 border border-green-500/20 hover:from-green-500/20 hover:to-emerald-500/20"}`,title:"Department contact",children:e.jsxs("div",{className:"flex flex-col items-center space-y-1",children:[e.jsx(yt,{className:"w-4 h-4 text-green-600 dark:text-green-400"}),e.jsx("div",{className:"text-xs font-medium text-green-700 dark:text-green-300",children:"Contact"})]})}),e.jsx("button",{onClick:()=>de&&de("emergency"),disabled:pe||c,className:`p-2 rounded-lg transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed ${_==="emergency"?"bg-gradient-to-r from-red-500/30 to-orange-500/30 border-2 border-red-500/50 shadow-lg":"bg-gradient-to-r from-red-500/10 to-orange-500/10 border border-red-500/20 hover:from-red-500/20 hover:to-orange-500/20"}`,title:"Emergency escalation",children:e.jsxs("div",{className:"flex flex-col items-center space-y-1",children:[e.jsx(it,{className:"w-4 h-4 text-red-600 dark:text-red-400"}),e.jsx("div",{className:"text-xs font-medium text-red-700 dark:text-red-300",children:"Emergency"})]})})]}),e.jsxs("div",{className:"inline-flex items-center space-x-2 px-3 py-1 rounded-full text-xs ml-4",style:{background:_==="normal"?"rgba(59, 130, 246, 0.1)":_==="department"?"rgba(34, 197, 94, 0.1)":"rgba(239, 68, 68, 0.1)",color:_==="normal"?"rgb(37, 99, 235)":_==="department"?"rgb(21, 128, 61)":"rgb(185, 28, 28)"},children:[e.jsx("div",{className:"w-2 h-2 rounded-full animate-pulse",style:{background:_==="normal"?"rgb(59, 130, 246)":_==="department"?"rgb(34, 197, 94)":"rgb(239, 68, 68)"}}),e.jsxs("span",{children:["Current: ",_==="normal"?"Normal":_==="department"?"Contact":"Emergency"]})]})]}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 flex items-center space-x-2",children:le.length>0&&e.jsxs("span",{className:"bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded text-blue-600 dark:text-blue-300",children:[le.length," characters"]})})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("textarea",{ref:U,value:le,onChange:n=>Ce(n.target.value),onKeyDown:ot,placeholder:"ðŸ’¬ Type a message... ask AI assistant or reply to customer",className:"flex-1 p-3 border border-blue-200 dark:border-blue-700 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-blue-900/30 dark:text-blue-100 text-sm transition-all duration-200",rows:3,disabled:pe||c,style:{boxShadow:"inset 0 1px 3px rgba(0,0,0,0.1)"}}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx("button",{onClick:()=>He("chat"),disabled:!le.trim()||pe||c,className:"flex items-center justify-center space-x-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98] shadow-lg min-w-[100px]",title:pe?"AI is thinking...":"Send message to ask AI",children:pe?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-xs font-medium",children:"Thinking"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"w-4 h-4"}),e.jsx("span",{className:"text-xs font-medium",children:"Ask AI"})]})}),e.jsxs("button",{onClick:()=>{if(!le.trim()||!m)return;const n={text:le.trim(),timestamp:new Date().toISOString(),type:"direct_reply",source:"ai_collaboration"};m(n),Ce("")},disabled:!le.trim()||c,className:"flex items-center justify-center space-x-2 px-4 py-2 bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98] shadow-lg min-w-[100px]",title:"Send directly to customer without AI translation",children:[e.jsx(at,{className:"w-4 h-4"}),e.jsx("span",{className:"text-xs font-medium",children:"Reply to customer"})]})]})]})]}),xe&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",onClick:()=>Te&&Te("emergency"),children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 w-96 max-w-[90%] shadow-xl",onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(it,{className:"w-5 h-5 text-red-500"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Emergency Handling"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Urgency Level"}),e.jsxs("select",{value:Ve,onChange:n=>Ge(n.target.value),className:"w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white",children:[e.jsx("option",{value:"urgent",children:"Urgent - Requires priority handling"}),e.jsx("option",{value:"high",children:"High - Important but not urgent"}),e.jsx("option",{value:"critical",children:"Critical - Report to management immediately"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Description"}),e.jsx("textarea",{value:V,onChange:n=>ye(n.target.value),placeholder:"Please describe the emergency in detail...",className:"w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg resize-none bg-white dark:bg-gray-700 text-gray-900 dark:text-white",rows:4})]}),e.jsxs("div",{className:"flex space-x-3 pt-4",children:[e.jsxs("button",{onClick:()=>{if(V.trim()&&Ae){const n=V.trim(),be=Ve;ye(""),Ge("urgent"),Pe&&Pe(),Ae(be,n).catch(Fe=>{console.error("Error handling emergency:",Fe)})}},disabled:!V.trim(),className:"flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2",children:[e.jsx(it,{className:"w-4 h-4"}),e.jsx("span",{children:"Submit Emergency Request"})]}),e.jsx("button",{onClick:()=>{ye(""),Ge("urgent"),Te&&Te("emergency")},className:"px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-colors",children:"Cancel"})]})]})]})})]})},jn=()=>{const[s,t]=f.useState([]),l=f.useCallback(u=>{const x=Date.now()+Math.random(),y={id:x,type:"info",duration:5e3,...u};t(v=>[...v,y]),y.duration>0&&setTimeout(()=>{m(x)},y.duration)},[]),m=f.useCallback(u=>{t(x=>x.filter(y=>y.id!==u))},[]);f.useEffect(()=>{window.showNotification=l},[l]);const c=u=>{switch(u){case"success":return e.jsx(rt,{className:"w-5 h-5 text-green-600"});case"error":return e.jsx(vt,{className:"w-5 h-5 text-red-600"});case"warning":return e.jsx(it,{className:"w-5 h-5 text-yellow-600"});default:return e.jsx(ln,{className:"w-5 h-5 text-blue-600"})}},d=u=>{switch(u){case"success":return"bg-green-50 border-green-200 text-green-800";case"error":return"bg-red-50 border-red-200 text-red-800";case"warning":return"bg-yellow-50 border-yellow-200 text-yellow-800";default:return"bg-blue-50 border-blue-200 text-blue-800"}};return s.length===0?null:e.jsx("div",{className:"fixed top-4 right-4 z-50 space-y-2",children:s.map(u=>e.jsx("div",{className:`max-w-sm w-full border rounded-lg p-4 shadow-lg transition-all duration-300 transform translate-x-0 ${d(u.type)}`,children:e.jsxs("div",{className:"flex items-start space-x-3",children:[c(u.type),e.jsxs("div",{className:"flex-1 min-w-0",children:[u.title&&e.jsx("h4",{className:"text-sm font-medium mb-1",children:u.title}),e.jsx("p",{className:"text-sm",children:u.message})]}),e.jsx("button",{onClick:()=>m(u.id),className:"flex-shrink-0 text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx($t,{className:"w-4 h-4"})})]})},u.id))})},qt=(s,t="info",l={})=>{window.showNotification&&window.showNotification({message:s,type:t,...l})},In=(s,t={})=>{qt(s,"success",t)},Cn=(s,t={})=>{qt(s,"info",t)},Rn=({onClearMessages:s,onToggleSettings:t,onFocusInput:l})=>(f.useEffect(()=>{const m=c=>{const d=c.ctrlKey||c.metaKey;c.shiftKey,c.altKey;const u=["INPUT","TEXTAREA"].includes(c.target.tagName);if(d&&c.key==="k"&&!u){c.preventDefault(),s(),Cn("All messages cleared",{duration:2e3});return}if(d&&c.key===","&&!u){c.preventDefault(),t();return}if(d&&c.key==="/"&&!u){c.preventDefault(),It();return}if(d&&c.key==="1"&&!u){c.preventDefault(),l("problem");return}if(d&&c.key==="3"&&!u){c.preventDefault(),l("solution");return}if(c.key==="Escape"){document.querySelectorAll("[data-modal]").forEach(y=>{y.style.display!=="none"&&(y.style.display="none")});return}if(c.key==="F1"){c.preventDefault(),It();return}};return document.addEventListener("keydown",m),()=>{document.removeEventListener("keydown",m)}},[s,t,l]),null),It=()=>{const s=[{key:"Ctrl/Cmd + K",description:"Clear all messages"},{key:"Ctrl/Cmd + ,",description:"Open settings"},{key:"Ctrl/Cmd + /",description:"Show shortcuts help"},{key:"Ctrl/Cmd + 1",description:"Focus left input (customer)"},{key:"Ctrl/Cmd + 3",description:"Focus right input (solution)"},{key:"Esc",description:"Cancel current action"},{key:"F1",description:"Show help"}];s.map(l=>`${l.key}: ${l.description}`).join(`
`);const t=document.createElement("div");t.setAttribute("data-modal","shortcuts-help"),t.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",t.innerHTML=`
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Keyboard Shortcuts</h3>
        <button class="text-gray-400 hover:text-gray-600" onclick="this.closest('[data-modal]').remove()">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="space-y-3">
        ${s.map(l=>`
          <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
            <span class="text-sm text-gray-600">${l.description}</span>
            <kbd class="px-2 py-1 text-xs font-mono bg-gray-100 rounded border">${l.key}</kbd>
          </div>
        `).join("")}
      </div>
      <div class="mt-6 text-center">
        <button 
          class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
          onclick="this.closest('[data-modal]').remove()"
        >
          Close
        </button>
      </div>
    </div>
  `,t.addEventListener("click",l=>{l.target===t&&t.remove()}),document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&t.remove()},1e4)},Mn=({isOpen:s,onClose:t,settings:l,onUpdateSettings:m})=>{const[c,d]=f.useState(l),u=f.useRef(null);f.useEffect(()=>{d(l)},[l]),f.useEffect(()=>{const b=k=>{u.current&&!u.current.contains(k.target)&&s&&t()};return document.addEventListener("mousedown",b),()=>{document.removeEventListener("mousedown",b)}},[s,t]);const x=(b,k)=>{d(C=>({...C,[b]:k}))},y=()=>{m(c),In("Settings saved",{duration:2e3}),t()},v=()=>{const b={darkMode:window.matchMedia("(prefers-color-scheme: dark)").matches,fontSize:"medium",soundEnabled:!0,autoScroll:!0,showTimestamps:!0,language:"zh-CN",apiEndpoint:"https://api.example.com/v1",maxMessagesPerPanel:50};d(b)};return s?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center",children:e.jsxs("div",{ref:u,className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4 overflow-hidden transition-all duration-300 transform scale-100",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(gn,{className:"w-5 h-5 text-primary-600 dark:text-primary-400"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Settings"})]}),e.jsx("button",{onClick:t,className:"text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-colors",children:e.jsx($t,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"px-6 py-4 max-h-[70vh] overflow-y-auto",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 mb-3",children:"Appearance"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[c.darkMode?e.jsx(un,{className:"w-5 h-5 text-gray-600 dark:text-gray-300"}):e.jsx(xn,{className:"w-5 h-5 text-yellow-500"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Dark mode"})]}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"sr-only peer",checked:c.darkMode,onChange:b=>x("darkMode",b.target.checked)}),e.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 dark:peer-focus:ring-primary-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-600"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Font size"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400 capitalize",children:c.fontSize})]}),e.jsxs("select",{value:c.fontSize,onChange:b=>x("fontSize",b.target.value),className:"block w-full px-3 py-2 text-sm bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:[e.jsx("option",{value:"small",children:"Small"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"large",children:"Large"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 mb-3",children:"Behavior"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[c.soundEnabled?e.jsx(yn,{className:"w-5 h-5 text-gray-600 dark:text-gray-300"}):e.jsx(bn,{className:"w-5 h-5 text-gray-600 dark:text-gray-300"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Sound effects"})]}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"sr-only peer",checked:c.soundEnabled,onChange:b=>x("soundEnabled",b.target.checked)}),e.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 dark:peer-focus:ring-primary-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-600"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Auto scroll to latest message"}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"sr-only peer",checked:c.autoScroll,onChange:b=>x("autoScroll",b.target.checked)}),e.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 dark:peer-focus:ring-primary-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-600"})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Show message timestamps"}),e.jsxs("label",{className:"relative inline-flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"sr-only peer",checked:c.showTimestamps,onChange:b=>x("showTimestamps",b.target.checked)}),e.jsx("div",{className:"w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 dark:peer-focus:ring-primary-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary-600"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 mb-3",children:"Advanced"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 dark:text-gray-300 mb-2",children:"Language"}),e.jsxs("select",{value:c.language,onChange:b=>x("language",b.target.value),className:"block w-full px-3 py-2 text-sm bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:[e.jsx("option",{value:"zh-CN",children:"Chinese (Simplified)"}),e.jsx("option",{value:"en-US",children:"English (US)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-700 dark:text-gray-300 mb-2",children:"API endpoint"}),e.jsx("input",{type:"text",value:c.apiEndpoint,onChange:b=>x("apiEndpoint",b.target.value),className:"block w-full px-3 py-2 text-sm bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white",placeholder:"https://api.example.com/v1"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm text-gray-700 dark:text-gray-300",children:"Max messages per panel"}),e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:c.maxMessagesPerPanel})]}),e.jsx("input",{type:"range",min:"10",max:"100",step:"10",value:c.maxMessagesPerPanel,onChange:b=>x("maxMessagesPerPanel",parseInt(b.target.value)),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"})]})]})]})]})}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 dark:bg-gray-750 border-t border-gray-200 dark:border-gray-700 flex justify-between",children:[e.jsx("button",{onClick:v,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-650",children:"Reset"}),e.jsxs("div",{className:"space-x-2",children:[e.jsx("button",{onClick:t,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-650",children:"Cancel"}),e.jsx("button",{onClick:y,className:"px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:bg-primary-700 dark:hover:bg-primary-600",children:"Save"})]})]})]})}):null},En="modulepreload",Tn=function(s,t){return new URL(s,t).href},Ct={},Pn=function(t,l,m){if(!l||l.length===0)return t();const c=document.getElementsByTagName("link");return Promise.all(l.map(d=>{if(d=Tn(d,m),d in Ct)return;Ct[d]=!0;const u=d.endsWith(".css"),x=u?'[rel="stylesheet"]':"";if(!!m)for(let b=c.length-1;b>=0;b--){const k=c[b];if(k.href===d&&(!u||k.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${x}`))return;const v=document.createElement("link");if(v.rel=u?"stylesheet":En,u||(v.as="script",v.crossOrigin=""),v.href=d,document.head.appendChild(v),u)return new Promise((b,k)=>{v.addEventListener("load",b),v.addEventListener("error",()=>k(new Error(`Unable to preload CSS for ${d}`)))})})).then(()=>t()).catch(d=>{const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=d,window.dispatchEvent(u),!u.defaultPrevented)throw d})},Ne={baseURL:"https://api-inference.modelscope.cn/v1/",model:"deepseek-ai/DeepSeek-V3.1",apiKeys:["ms-bc1564ca-2e11-4dc4-9cea-fb485028936c","ms-86a76da4-13fa-4810-b412-759dc8511cc4"],currentKeyIndex:0},je=(s,t=2e3)=>typeof s!="string"||s.length<=t?s:s.slice(0,t)+"â€¦(truncated)",X=async(s,t=.7,l=4096,m=null,c={})=>{var v,b;const{enableThinking:d=!0,stream:u=!0}=c||{},x=Ne.apiKeys.length;let y=null;for(let k=0;k<x;k++){const C=Ne.apiKeys[Ne.currentKeyIndex];try{const j={role:"system",content:"Language policy: Respond in English only. Do not use Chinese characters. Keep responses concise, professional, and user-friendly."},M=Array.isArray(s)?[j,...s]:[j],F=typeof import.meta<"u"&&{BASE_URL:"./",MODE:"production",DEV:!1,PROD:!0,SSR:!1}&&!1;console.group("[LLM] DeepSeek-V3.1 Request Details (Thinking Mode)"),console.log("ðŸ”¹ Model:",Ne.model),console.log("ðŸ”‘ API Key Index:",Ne.currentKeyIndex+1,"/",Ne.apiKeys.length),console.log("ðŸ”¹ Temperature:",t),console.log("ðŸ”¹ Total Messages:",M.length),console.log("ðŸ§  Thinking Mode:",d?"Enabled":"Disabled"),console.log("ðŸ“¡ Stream Mode:",u?"Enabled":"Disabled"),console.group("ðŸ“ Complete Prompt Content");try{M.forEach((P,z)=>{console.group(`ðŸ’¬ Message ${z+1}: [${P.role.toUpperCase()}]`),console.log(P.content),console.groupEnd()})}catch(P){console.log("Error displaying messages:",P)}if(console.groupEnd(),F){console.group("ðŸ”§ Debug Info (JSON Format)");try{console.log("messages JSON:",JSON.stringify(M,null,2))}catch{console.log("Failed to serialize messages to JSON")}console.groupEnd()}console.time("[LLM] â±ï¸ Request Latency"),console.log("ðŸ” callModelScopeAPI - About to request:",`${Ne.baseURL}chat/completions`);const D=await fetch(`${Ne.baseURL}chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${C}`},body:JSON.stringify({model:Ne.model,messages:M,temperature:t,max_tokens:l,stream:u,enable_thinking:d})});if(!D.ok){console.timeEnd("[LLM] â±ï¸ Request Latency"),console.log("âŒ HTTP Status:",D.status,D.statusText);let P="";try{const Z=await D.json();console.log("âŒ API Error Details:",Z),P=((v=Z.error)==null?void 0:v.message)||Z.message||""}catch{console.log("âŒ Failed to parse error response")}if(D.status===429&&k<x-1){Ne.currentKeyIndex=(Ne.currentKeyIndex+1)%Ne.apiKeys.length,console.log("ðŸ”„ Rate limit hit, switching to API key",Ne.currentKeyIndex+1);const Z=(k+1)*2e3;console.log(`â³ Waiting ${Z}ms before retry...`),await new Promise(me=>setTimeout(me,Z)),console.groupEnd(),y=new Error(`API call failed: ${D.status} ${D.statusText}${P?" - "+P:""}`);continue}console.groupEnd();const z=P?`API call failed: ${D.status} ${D.statusText} - ${P}`:`API call failed: ${D.status} ${D.statusText}`;throw new Error(z)}if(!u)try{const P=await D.json();console.timeEnd("[LLM] â±ï¸ Request Latency");let z="";if(P&&Array.isArray(P.choices)&&P.choices.length>0){const Z=P.choices[0];z=((Z.message||{}).content||Z.text||P.output_text||"").toString()}else typeof P.output_text=="string"?z=P.output_text:typeof P.text=="string"&&(z=P.text);return console.group("ðŸ“¤ Response Statistics"),console.log("ðŸ’¬ Final answer length:",(z||"").length,"characters"),P.usage&&console.log("ðŸ’° Token Usage:",P.usage),console.groupEnd(),console.group("âœ… Final Answer"),console.log(z||"(Empty response)"),console.groupEnd(),console.groupEnd(),(z||"").trim()}catch{console.log("âš ï¸ Failed to parse non-stream JSON, reading text instead");const z=await D.text();return console.timeEnd("[LLM] â±ï¸ Request Latency"),console.group("âœ… Final Answer (raw)"),console.log(z||"(Empty response)"),console.groupEnd(),console.groupEnd(),(z||"").trim()}let q="",O="",U=!1,J=null;console.group("ðŸ§  DeepSeek-V3.1 Reasoning"),console.log("=".repeat(50));let E=null;const K={isPaused:!1,isAborted:!1,pause:()=>{if(console.log("â¸ï¸ Pausing AI reasoning"),K.isPaused=!0,E)try{E.cancel("User requested pause")}catch(P){console.log("â¸ï¸ Reader cancel failed:",P.message)}m&&m.onStreamPaused&&m.onStreamPaused()},resume:()=>{console.log("â–¶ï¸ Resuming AI reasoning"),K.isPaused=!1},abort:()=>{console.log("ðŸ›‘ Aborting AI reasoning"),K.isAborted=!0,E&&E.cancel()}};if(m&&m.onStreamStart){const P={messages:s,temperature:t,maxTokens:l,onComplete:z=>{console.log("Streaming completed, result:",z)}};m.onStreamStart(K,P)}E=(b=D.body)==null?void 0:b.getReader();const ce=new TextDecoder;if(!E)throw new Error("Unable to acquire response stream");try{let P=!1;for(;;){if(K.isAborted||P){console.log("ðŸ›‘ Streaming aborted");break}for(;K.isPaused&&!K.isAborted;)await new Promise(we=>setTimeout(we,5));const{done:z,value:Z}=await E.read();if(z)break;const oe=ce.decode(Z,{stream:!0}).split(`
`).filter(we=>we.trim());for(const we of oe){if(K.isAborted||P){console.log("ðŸ›‘ Streaming aborted (line)"),P=!0;break}if(!we.startsWith("data: "))continue;const ae=we.slice(6);if(ae!=="[DONE]")try{const ue=JSON.parse(ae);if(ue.usage&&(J=ue.usage),!ue.choices||ue.choices.length===0)continue;const Q=ue.choices[0].delta;for(;K.isPaused&&!K.isAborted;)await new Promise($e=>setTimeout($e,1));if(K.isAborted){console.log("ðŸ›‘ Streaming aborted (delta)"),P=!0;break}if(Q.reasoning_content!==void 0&&Q.reasoning_content!==null&&Q.reasoning_content!==""){if(K.isPaused)break;console.log("ðŸ§  Reasoning chunk:",Q.reasoning_content),q+=Q.reasoning_content,m&&m.onThinking&&m.onThinking(Q.reasoning_content,q)}if(Q.content!==void 0&&Q.content!==null){if(K.isPaused)break;U||(console.log(`
`+"=".repeat(20)+" Full Answer "+"=".repeat(20)),U=!0),Q.content&&Q.content!==""&&(console.log("ðŸ’¬ Answer chunk:",Q.content),m&&m.onAnswering&&m.onAnswering(Q.content,O+Q.content)),O+=Q.content}}catch(ue){console.log("Error parsing streaming data:",ue);continue}}if(P)break}}finally{E.releaseLock()}return console.log(),console.groupEnd(),console.timeEnd("[LLM] â±ï¸ Request Latency"),m&&m.onStreamEnd&&m.onStreamEnd(q,O),console.group("ðŸ“¤ Response Statistics"),console.log("ðŸ§  Reasoning length:",q.length,"characters"),console.log("ðŸ’¬ Final answer length:",O.length,"characters"),J&&console.log("ðŸ’° Token Usage:",J),console.groupEnd(),console.groupCollapsed("ðŸ§  Complete Reasoning Process"),console.log(q||"(No reasoning content)"),console.groupEnd(),console.group("âœ… Final Answer"),console.log(O||"(Empty response)"),console.groupEnd(),console.groupEnd(),O.trim()}catch(j){try{console.groupEnd()}catch{}if(console.groupCollapsed("[LLM] Error"),console.error("DeepSeek-V3.1 API call error:",j),console.groupEnd(),j.message.includes("429")&&k<x-1){y=j;continue}throw j}}throw y||new Error("All API keys have reached usage limits")},Ot=s=>{if(!s)return s;const t=["^I am very sorry.*$","^I'm very sorry.*$","^Sorry.*$","^I apologize.*$","I could not understand","I couldn't understand","Please describe.*in detail","Please provide more information","Insufficient information","Please correct me if.*","Hello!.*help you","Are you.*looking for.*type of product","Clothes, shoes,? or other.*","Thank you for your feedback","We (greatly|highly) value","If you have any questions","If you need.*help","Please feel free to contact","(customer support|support team)","We will.*(do our best|try our best).*resolve","We appreciate your understanding","Please ignore this conversation","Continue browsing.*(services|information)","Welcome.*contact us"];let l=s;return t.forEach(m=>{const c=new RegExp(m,"gi");l=l.replace(c,"")}),l.trim()},Rt=s=>{if(!s)return s;const t=["^I am very sorry.*$","^I'm very sorry.*$","^Sorry.*$","I could not understand your request","Please describe in detail","Insufficient information, cannot","Please correct me if.*","Thank you for your feedback, we.*value","If you have any questions, please feel free to contact","The customer support team will","The support team will","Thank you for your understanding"];let l=s;return t.forEach(m=>{const c=new RegExp(m,"gmi");l=l.replace(c,"")}),l.trim()},An=s=>{if(!s)return s;let t=s.trim();return/[!?]$/.test(t)||(t=t.endsWith(".")?t.replace(/\.$/,"?"):t+"?"),t},Mt=s=>{if(!s)return s;let t=s.trim();return t=t.replace(/^(hello|hi)[!,.\s]*/i,""),t=t.replace(/^(pleased to.*|glad to.*)[.!?]+\s*/i,""),t=t.replace(/^(thank(s| you)[\s\S]{0,20}?)[.!?]+\s*/i,""),t.trim()},Lt=async(s,t,l=[],m=null,c=null)=>{try{console.log("[LLM] Starting AI collaborative chat:",{userQuestion:s,scenario:t,hasFullContext:!!m,chatHistoryLength:l.length,chatMode:m==null?void 0:m.chatMode});const d=(m==null?void 0:m.chatMode)||"normal",u=d==="department",x=d==="emergency";let y="";if(m&&typeof m=="object"){const{aiChatHistory:j=[],customerMessages:M=[],solutionMessages:F=[],llmMessages:D=[],scenario:q={},chatMode:O}=m;y=`
### ðŸ“‹ Workbench Information Analysis:

**ðŸŽ¯ Current Service Scenario**
- Industry: ${q.name||t||"retail"} (Retail)
- Customer Identity: ${q.problemRole||"Customer"}  
- You are assisting: ${q.solutionRole||"Customer Service Representative"}
${u?"- **ðŸ”— Current Mode: Contact Mode** - Focus on department coordination and internal instruction formulation":""}
${x?"- **ðŸš¨ Current Mode: Emergency Mode** - Focus on emergency incident handling and rapid response":""}

**ðŸ’¬ Your conversation history with customer service**ï¼ˆUnderstanding what you've discussed beforeï¼‰
${j.length>0?j.map(U=>`${U.role==="user"?"ðŸ‘¨â€ðŸ’¼Customer Service":"ðŸ¤–You"}: ${U.content}`).join(`
`):"ðŸ“ First conversation, no history"}

**ðŸ‘¥ Real dialogue between customers and customer service**ï¼ˆAnalyzing core information of customer needsï¼‰
${M.length>0?M.map(U=>`${U.role==="customer"?"ðŸ‘¤Customer":"ðŸªSystem"}: ${U.content}`).join(`
`):"ðŸ“­ No customer dialogue yet, customer service may have encountered general issues"}

**ðŸ› ï¸ Workbench Processing Records**ï¼ˆSuggestions and tools already provided by the systemï¼‰
${F.length>0?F.map(U=>`${{user:"ðŸ‘¨â€ðŸ’¼Customer Service Input",ai_response:"ðŸ¤–AI Reply",llm_request:"âš™ï¸AI Processing",suggestion:"ðŸ’¡AI Suggestion",followup:"â“AI Follow-up",intelligent_followup:"ðŸ§ Intelligent Follow-up",department_contact:"ðŸ¢Department Contact",needs_analysis:"ðŸ”Needs Analysis",ai_chat:"ðŸ’¬AI Collaboration"}[U.type]||U.type}: ${U.content}`).join(`
`):"ðŸ“„ No work records, this is a new consultation"}

**ðŸ”§ AI Analysis Processing Records**ï¼ˆSystem analysis resultsï¼‰
${D.length>0?D.map(U=>`ðŸ“Š ${U.type}: ${U.content}`).join(`
`):"ðŸ†• No AI analysis records"}`}else l&&l.length>0?y=`
### ðŸ“‹ Basic Conversation Information:

**ðŸ“ Historical Conversation Records**
${l.slice(-8).map(j=>`${j.panel||j.role||"User"}: ${j.text||j.content}`).join(`
`)}`:y=`
### ðŸ“‹ Workbench Information Analysis:

**ðŸŽ¯ Current Service Scenario**
- Industry: ${t||"retail"} (Retail)
- Situation: Brand new conversation, no historical records

**ðŸ’¡ Tip:** Customer service may need general guidance or encountered new issues`;let v;u?v=`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, an AI system specifically designed to optimize enterprise internal collaboration. The platform is currently in contact mode, specifically assisting customer service in cross-departmental communication and internal coordination.

ã€Function Descriptionã€‘Customer service has activated the "AI Collaboration Assistant" and selected contact mode. The core function of this feature is: to provide professional departmental coordination guidance for customer service, including problem attribution analysis, contact strategy formulation, and internal instruction generation, helping customer service efficiently coordinate resources across departments.

ã€Generation Instructionsã€‘Please provide departmental coordination solutions based on the professional requirements of contact mode:
1. Identify the most suitable department to handle the problem
2. Provide specific contact strategies and internal instructions
3. Provide necessary communication scripts
4. Ensure suggestions are immediately executable

**âš¡ Mandatory Requirement: Responses must be extremely concise, single-point answers, no more than 3 sentences, direct to the core, strictly prohibiting lengthy expressions, explanations, background descriptions, word counts or any unnecessary content. Only say key information!**

## Workbench Information Analysis:

${y}

=== Customer Service Questions in Contact Mode ===
"${s}"

## Please provide professional department coordination guidance based on the above information:`:x?v=`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, an AI system specifically designed to handle crisis events. The platform is currently in emergency mode, specifically assisting customer service in quickly and professionally handling emergency situations and crisis management.

ã€Function Descriptionã€‘Customer service has activated the "AI Collaboration Assistant" and selected emergency mode. The key function of this feature is: to provide immediate crisis handling guidance for customer service, including risk assessment, emergency plan formulation, and escalation mechanism guidance, ensuring emergency situations receive timely and effective handling.

ã€Generation Instructionsã€‘Please conduct rapid analysis of emergency situations and provide emergency handling solutions based on the professional requirements of emergency mode:
1. Quickly assess the urgency level and impact scope of the incident
2. Provide immediately executable emergency handling measures
3. Clarify escalation timing, escalation paths, and key contacts
4. Provide professional crisis communication scripts and response strategies

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**

## Workbench Information Analysis:

${y}

=== Customer Service Questions in Emergency Mode ===
"${s}"

## Please quickly provide emergency handling guidance based on the above information:`:v=`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, an AI system specifically designed to provide real-time guidance for frontline customer service representatives, helping them better handle customer inquiries and improve service quality.

ã€Function Descriptionã€‘Customer service has activated the "AI Collaboration Assistant" function. The core value of this function is: when customer service encounters difficulties in handling customer inquiries, the system can provide specific and feasible handling suggestions and professional script guidance based on current conversation situations and workbench records.

ã€Generation Instructionsã€‘Please provide practical guidance based on professional customer service collaboration requirements:
1. Identify customer needs and key issues
2. Based on workbench records, provide targeted suggestions  
3. Provide specific scripts and handling solutions
4. Ensure suggestions comply with ${t||"retail"} industry characteristics

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**

## Workbench Information Analysis:

${y}

=== Customer Service Questions to You ===
"${s}"

## Please provide professional guidance for customer service based on the above information:`;const C=(await X([{role:"system",content:v},{role:"user",content:s}],.7,2048,c,{enableThinking:!0,stream:!0})).trim();return console.log("[LLM] AI collaboration suggestion completed:",{question:s,answer:C}),{answer:C,timestamp:new Date().toISOString()}}catch(d){return console.error("[LLM] AI collaboration suggestion failed:",d),{answer:"AI collaboration function temporarily unavailable, please try again later",timestamp:new Date().toISOString(),error:!0}}},bt=(s,t)=>{for(const l of t){const m=s.indexOf(l);if(m!==-1)return{idx:m,keyword:l}}return{idx:-1,keyword:""}},_n=(s,t="Chat History Context",l=6)=>{if(!s||s.length===0)return console.log("â„¹ï¸ No chat history available for context"),"";console.group("ðŸ” Chat History Analysis"),console.log(`ðŸ“Š Total History Messages: ${s.length}`),console.log(`ðŸ“ Using Recent Messages: ${Math.min(s.length,l)}`);const m=s.slice(-l);return m.forEach((d,u)=>{var b,k,C;let x="AI Processing";if(d.type==="user")if(d.panel==="problem")x="ðŸ‘¤Customer";else if(d.panel==="solution")x="ðŸ‘¨â€ðŸ’¼Enterprise CS";else{console.warn(`âš ï¸ Message panel field abnormal: panel="${d.panel}"`);const j=((b=d.text)==null?void 0:b.toLowerCase())||"";j.includes("return")||j.includes("complaint")||j.includes("dissatisfied")||j.includes("problem")||j.includes("help")||j.includes("inquiry")?(x="ðŸ‘¤Customer",console.log("ðŸ”§ Intelligent inference: Judged as customer message based on content characteristics")):(x="ðŸ‘¨â€ðŸ’¼Enterprise CS",console.log("ðŸ”§ Intelligent inference: Judged as enterprise message based on content characteristics"))}else d.type==="ai_response"?x=d.panel==="problem"?"ðŸ¤–System Reply(Customer)":"ðŸ¤–System Reply(Enterprise)":d.type==="llm_request"?x="âš™ï¸AI Requirements Translation":d.type==="ai_chat"&&(x="ðŸ¤–AI Collaboration Assistant");const y=(k=d.text)==null?void 0:k.substring(0,100),v=((C=d.text)==null?void 0:C.length)>100?"...":"";console.log(`${u+1}. [${x}]: ${y}${v}`),console.log(`   ðŸ” Debug: type="${d.type}", panel="${d.panel}", timestamp="${d.timestamp}"`)}),console.groupEnd(),`

${t}ï¼š
`+m.map((d,u)=>{var y,v;let x="AI Processing";if(d.type==="user")if(d.panel==="problem")x="ðŸ‘¤Customer";else if(d.panel==="solution")x="ðŸ‘¨â€ðŸ’¼Enterprise CS";else{console.warn(`âš ï¸ Message panel field abnormal: panel="${d.panel}", content preview: "${(y=d.text)==null?void 0:y.substring(0,50)}..."`);const b=((v=d.text)==null?void 0:v.toLowerCase())||"";b.includes("return")||b.includes("complaint")||b.includes("dissatisfied")||b.includes("problem")||b.includes("help")||b.includes("inquiry")?(x="ðŸ‘¤Customer",console.log("ðŸ”§ Intelligent inference: Judged as customer message based on content characteristics")):(x="ðŸ‘¨â€ðŸ’¼Enterprise CS",console.log("ðŸ”§ Intelligent inference: Judged as enterprise message based on content characteristics"))}else d.type==="ai_response"?x=d.panel==="problem"?"ðŸ¤–System Reply(Customer)":"ðŸ¤–System Reply(Enterprise)":d.type==="llm_request"?x="âš™ï¸AI Requirements Translation":d.type==="ai_chat"&&(x="ðŸ¤–AI Collaboration Assistant");return`${u+1}. ${x}: ${d.text}`}).join(`
`)},Me=(s,t=[])=>{let l=[];try{if(Array.isArray(s))l=s;else if(s&&typeof s=="object"){const{customerMessages:u=[],solutionMessages:x=[]}=s;l=[...u.map(y=>({...y,panel:"problem"})),...x.map(y=>({...y,panel:"solution"}))].sort((y,v)=>new Date(y.timestamp)-new Date(v.timestamp))}}catch(u){console.warn("âš ï¸ Exception occurred while building consumer history, will fall back to empty array",u),l=[]}const m=l.length>0?l.map((u,x)=>{let y="AI Processing";u.type==="user"?y=u.panel==="problem"?"ðŸ‘¤Customer":"ðŸ‘¨â€ðŸ’¼Enterprise CS":u.type==="ai_response"?y=u.panel==="problem"?"ðŸ¤–System Reply(Customer)":"ðŸ¤–System Reply(Enterprise)":u.type==="llm_request"&&(y="âš™ï¸AI Requirements Translation");const v=u.text||u.output||u.content||"";return`${x+1}. ${y}: ${v}`}).join(`
`):"(None)",c=Array.isArray(t)&&t.length>0?t.map((u,x)=>{const y=u.role==="user"?"ðŸ‘¨â€ðŸ’¼Collaboration User":"ðŸ¤–AI Collaboration Assistant";return`${x+1}. ${y}: ${u.content}`}).join(`
`):"(None)";return`

ã€Consumer Communication History - Fullã€‘
${m}

ã€AI Collaboration History - Fullã€‘
${c}`},Dn=s=>{const t=typeof s=="string"?s:"",l={translation:"",solutionsText:"",confirmationsText:""},m=["ã€REQUIREMENTS TRANSLATIONã€‘","ã€NEEDS TRANSLATIONã€‘","ã€TRANSLATION RESULTã€‘","ã€REQUIREMENTS CLARIFICATIONã€‘","Requirements Translation","Needs Translation","Translation Result","Requirements Clarification","Customer Needs Translation","User Needs Translation"],c=["ã€SOLUTION SUGGESTIONSã€‘","ã€RECOMMENDED SOLUTIONSã€‘","ã€ACTION RECOMMENDATIONSã€‘","Solution Suggestions","Recommended Solutions","Solution Recommendations","Action Recommendations"],d=["ã€INFORMATION TO CONFIRMã€‘","ã€INFO TO VERIFYã€‘","ã€PENDING CONFIRMATIONã€‘","Information to Confirm","Info to Verify"],u=bt(t,m),x=bt(t,c),y=bt(t,d),v=b=>{if(b===-1)return t.length;const k=[x.idx,y.idx,t.length].filter(C=>C!==-1&&C>b);return Math.min(...k)};if(u.idx!==-1){const b=u.idx+u.keyword.length,k=v(u.idx);l.translation=t.slice(b,k).trim()}else x.idx!==-1&&(l.translation=t.slice(0,x.idx).trim());if(x.idx!==-1){const b=x.idx+x.keyword.length,k=y.idx!==-1?y.idx:t.length;l.solutionsText=t.slice(b,k).trim()}if(y.idx!==-1){const b=y.idx+y.keyword.length;l.confirmationsText=t.slice(b).trim()}if(!l.translation){const b=x.idx!==-1?x.idx:t.search(/\n?\s*(æ–¹æ¡ˆ|é€‰é¡¹|å»ºè®®)\s*[1-9]/);if(b!==-1&&b>0)l.translation=t.slice(0,b).trim();else{const k=t.slice(0,500),C=k.split(/\n{2,}/);l.translation=(C[0]||k).trim()}}return l},$n=async(s,t,l,m=[],c=[])=>{try{const d={retail:{systemRole:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, an AI system dedicated to eliminating communication barriers by connecting customers with business stores, making bilateral communication smoother and more efficient.

ã€Function Descriptionã€‘When customers input requirements on the left side of the interface, the system triggers the "Requirements Analysis" function button. This button serves to: intelligently translate customers' everyday expressions into professional descriptions that businesses can understand, while generating specific solution recommendations to help businesses better understand and respond to customer needs.

ã€Generation Instructionsã€‘Please perform professional processing of customer input based on the above platform functions: accurately understand customers' real needs and potential intentions, transform them into professional descriptions that businesses can understand and execute, provide specific feasible solution options based on business capabilities, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:`ã€Communication Scenarioã€‘In retail customer-store communication environments, there are often expression differences between parties: customers use everyday language and their needs may not be clear enough, while businesses are accustomed to replying with professional terminology. The platform needs to serve as a bridge between them.

ã€Processing Requirementsã€‘
1. Deep Understanding: Analyze customers' explicit and implicit needs, identifying possible expression biases
2. Accurate Translation: Transform customer needs into professional descriptions containing key information such as product types, usage scenarios, budget ranges, specification requirements, etc.
3. Solution Recommendations: Based on translation results, provide 2-3 specific feasible solution options for businesses, including product recommendations, service suggestions, price ranges, etc.
4. Language Purification: When encountering inappropriate expressions, crude language, or emotional vocabulary, intelligently identify the actual intent behind them, transforming them into professional, neutral expressions, never directly quoting or repeating original inappropriate content`,example:`Example: Customer says "I need clothing suitable for business occasions" â†’ Translation: "Customer needs business formal wear for important meetings, budget to be confirmed, requires professional image" â†’ Solution suggestions: "1) Recommend classic business suit sets, price 800-1500 yuan, includes free alteration service 2) Recommend business casual wear, price 500-800 yuan, suitable for daily business occasions 3) Provide personal image consultant service, customize matching solutions based on specific needs"

Inappropriate language handling example: When customer inputs inappropriate expressions â†’ Translation: "Customer expressed strong emotions, may have dissatisfaction with products, services, or experience. Need to understand specific issues to provide targeted solutions" â†’ Solution suggestions: "1) Actively inquire about specific problems or difficulties encountered 2) Provide one-on-one customer service specialist communication 3) Arrange relevant departments to follow up based on problem nature"`},enterprise:{systemRole:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, an AI system specifically designed to solve internal cross-departmental communication problems within enterprises, helping business departments and technical departments establish effective communication bridges.

ã€Function Descriptionã€‘When business departments express requirements on the left side of the interface, the system activates the "Requirements Translation" function button. This button's purpose is to: convert business language into professional descriptions that technical teams can understand, generate specific feasible technical solutions, and eliminate communication deviations between departments.

ã€Generation Instructionsã€‘Please perform professional processing of business requirements based on the platform's cross-departmental communication function: accurately understand business departments' requirements and technical departments' capability boundaries, eliminate communication deviations between departments, provide specific feasible technical solution options, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:`ã€Communication Scenarioã€‘In enterprise internal cross-departmental collaboration environments, different departments use different professional languages: business departments focus on effectiveness and time, while technical departments focus on feasibility and resources. The platform serves as a translator, ensuring consistent understanding between both parties.

ã€Processing Requirementsã€‘
1. Requirements Analysis: Transform business requirements into technical-understandable functional requirements, including specific indicators, time limits, and resource constraints
2. Solution Design: Provide 2-3 solution options of different complexity levels based on technical capabilities
3. Risk Assessment: Identify potential technical risks and resource requirements during implementation
4. Language Purification: When encountering inappropriate expressions, crude language, or emotional vocabulary, intelligently identify the actual intent behind them, transforming them into professional, neutral expressions, never directly quoting or repeating original inappropriate content`,example:`Example: Marketing department says "We need to improve user experience" â†’ Translation: "Need to develop user experience optimization features, goal to improve user retention rate, within 3 months" â†’ Solution suggestions: "1) Quick solution: Optimize existing interface and interaction, expected to improve retention by 10%, requires 2 weeks, cost 50K 2) Medium solution: Redesign core processes, expected to improve retention by 25%, requires 6 weeks, cost 150K 3) Deep solution: Comprehensive reconstruction of user experience, expected to improve retention by 40%, requires 3 months, cost 400K"

Inappropriate language handling example: When departments express inappropriate emotions â†’ Translation: "Department expressed strong concern about current project progress, may have communication coordination or resource allocation issues. Need to clarify specific problem points and improvement directions" â†’ Solution suggestions: "1) Arrange cross-departmental coordination meetings to clarify responsibilities and timelines 2) Evaluate whether current resource allocation is reasonable, adjust manpower or budget allocation 3) Establish regular communication mechanisms to timely discover and resolve issues"`},education:{systemRole:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, an AI education assistant dedicated to improving teacher-student communication, connecting students' learning needs with teachers' teaching solutions, making educational communication more precise and effective.

ã€Function Descriptionã€‘When students express learning difficulties on the left side of the interface, the system activates the "Learning Diagnosis" function button. This button serves to: translate students' learning confusion into teaching points that teachers can understand, generate diverse teaching solution options, helping teachers develop personalized teaching strategies.

ã€Generation Instructionsã€‘Please perform professional analysis of student needs based on the platform's educational communication function: deeply understand students' learning difficulties and knowledge blind spots, transform them into actionable teaching points for teachers, provide diverse teaching solution options, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:`ã€Communication Scenarioã€‘In teacher-student interactive educational environments, there may be cognitive gaps between both parties: students cannot accurately express learning difficulties, and teachers may use overly professional language. The platform needs to establish understanding bridges between them.

ã€Processing Requirementsã€‘
1. Learning Diagnosis: Analyze students' specific difficulty points, knowledge background, and learning styles
2. Teaching Translation: Transform learning needs into professional descriptions containing knowledge points, difficulty analysis, and teaching objectives
3. Solution Recommendations: Provide 2-3 specific implementation plans for different teaching methods
4. Language Purification: When encountering inappropriate expressions, crude language, or emotional vocabulary, intelligently identify the actual intent behind them, transforming them into professional, neutral expressions, never directly quoting or repeating original inappropriate content`,example:`Example: Student says "I don't understand this concept" â†’ Translation: "Student has difficulty understanding the wave-particle duality concept in quantum physics, needs to start from basic concepts, establish cognition through experimental examples" â†’ Solution suggestions: "1) Experimental demonstration method: Through classic experiments like double-slit experiment, intuitively demonstrate wave-particle duality, suitable for visual learners 2) Analogy teaching method: Use analogies of water waves and marbles to help understand abstract concepts, suitable for students with strong logical thinking 3) Progressive teaching: Start from basic properties of light, gradually introduce quantum concepts, suitable for students with weaker foundations"

Inappropriate language handling example: When students express frustration â†’ Translation: "Student encountered difficulties in the learning process, showing frustration and learning pressure. Need to adjust teaching methods, provide more support and encouragement" â†’ Solution suggestions: "1) Lower learning difficulty, start explaining from more basic knowledge points 2) Use encouraging teaching methods, affirm students' efforts and progress 3) Provide individual tutoring, solve learning difficulties in a targeted manner"`}};if(!l||!d[l])throw new Error(`æ— æ•ˆçš„åœºæ™¯ç±»åž‹: ${l}ã€‚æ”¯æŒçš„åœºæ™¯: ${Object.keys(d).join(", ")}`);const u=d[l],x=Me(m,c),y={retail:`Enhanced Instructions (Retail Scenario):
1. Consumer Psychology Insight: Deeply understand customers' purchasing motivations, price sensitivity, quality expectations, and usage scenarios
2. Product Value Translation: Convert technical parameters into practical usage value, highlighting how products solve customers' specific problems
3. Purchase Decision Support: Provide clear product comparisons, cost-benefit analysis, and purchase recommendations to reduce decision costs
4. Service Experience Optimization: Emphasize pre-sales consultation, after-sales guarantee and other service values to enhance purchase confidence
5. Personalized Recommendations: Based on customer need characteristics, provide precise product recommendations and matching suggestions
6. Promotional Strategy Integration: Reasonably integrate promotional information, limited-time activities, etc., to create purchase urgency
7. Retail Style Restrictions: Avoid over-promotional language, prohibit using informal terms like "dear", "oh", maintain professional and friendly retail service tone
8. Retail Scenario Inappropriate Language Handling: Transform customer dissatisfaction into specific product or service improvement needs, focusing on returns/exchanges, quality issues, price disputes and other common retail problems' professional expression`,enterprise:`Enhanced Instructions (Enterprise Scenario):
1. Business Value Orientation: Convert technical solutions into quantifiable value indicators such as business revenue, cost savings, and efficiency improvements
2. Executive-Level Communication: Use language that decision-makers care about, highlighting key elements like ROI, risk control, and competitive advantages
3. Implementation Path Planning: Provide clear project timelines, milestone nodes, resource allocation, and risk contingency plans
4. Cross-Departmental Coordination: Consider different departments' interests and concerns, provide solutions that balance all parties' needs
5. Compliance Assurance: Ensure solutions comply with industry regulations, legal requirements, and internal corporate policy requirements
6. Scalability Design: Consider enterprise future development needs, provide forward-looking solutions
7. Enterprise Style Restrictions: Use formal business language, avoid colloquial expressions, maintain professional and rigorous enterprise communication style
8. Enterprise Scenario Inappropriate Language Handling: Transform inter-departmental conflicts or dissatisfaction into management-level improvement suggestions such as process optimization, resource allocation, communication mechanisms, avoiding direct expression at interpersonal relationship level`,education:`Enhanced Instructions (Education Scenario):
1. Learning Psychology Care: Understand students' learning pressure, cognitive characteristics, and emotional needs, provide warm and supportive expression
2. Knowledge System Construction: Break down complex concepts into easily understandable knowledge points, establish clear learning paths
3. Learning Method Guidance: Based on different learning styles, provide personalized learning strategies and skill recommendations
4. Growth Motivation Orientation: Emphasize progress and achievements in the learning process, build students' learning confidence
5. Home-School Communication Bridge: Balance student needs and parent expectations, promote effective three-party communication
6. Teaching Resource Integration: Reasonably utilize teaching tools, reference materials, and practical opportunities to enrich learning experience
7. Educational Style Restrictions: Use encouraging, inspiring language, avoid criticism or negative expressions, maintain positive educational tone
8. Educational Scenario Inappropriate Language Handling: Transform students' frustration and learning difficulties into specific learning support needs, focusing on learning method adjustment, psychological counseling, individual tutoring and other educational professional expressions`},v=[{role:"system",content:`${u.systemRole}

${u.instruction}

ã€Importantã€‘Input content filtering and intelligent processing rules:
1. Inappropriate language handling: If user input contains profanity, vulgarity, or aggressive words, do not repeat this content, but:
   - Identify as "user emotional expression" or "test input"
   - Understand possible real intentions (such as expressing dissatisfaction, seeking help, random testing, etc.)
   - Respond in a professional and friendly manner

2. Meaningless input handling: If input is:
   - Random letter/number combinations (like "cnm", "123", "aaa")
   - Single words without clear requirement meaning
   - Obviously test inputs
   Identify as "users needing guidance", suggest providing real requirements

3. Negative emotion recognition: If input expresses dissatisfaction or negative emotions, transform into opportunities to understand problems and provide help

Please output in the following format:

ã€REQUIREMENTS UNDERSTANDINGã€‘
Briefly summarize the user's core requirements (no more than 30 words)
- For valid requirements: normal summary
- For inappropriate input: state "user test input" or "user emotional expression"
- For meaningless input: state "input content unclear, needs guidance"

ã€INFORMATION OPTIONSã€‘
Generate options for specific requirements, format: option name|inquiry reason
- For valid requirements: normally generate 3-5 options
- For invalid input: return "no need to collect additional information"

ã€REQUIREMENTS TRANSLATIONã€‘
Transform into professional description:
- For valid requirements: normal translation
- For inappropriate input: translate to "customer may be testing system or expressing emotions, suggest friendly guidance to provide specific requirements"
- For meaningless input: translate to "customer input is unclear, suggest actively asking what help can be provided"`},{role:"user",content:`User input: "${s}"${t?`
(User also uploaded an image)`:""}${x}

Please analyze this input, and if it contains inappropriate language or meaningless content, please handle it intelligently.`}],b=await X(v,.1,2048,null,{enableThinking:!1,stream:!1}),k=Ot(b),C=Dn(k),j=[{name:"Requirements Analysis & Translation",content:C.translation}];C.solutionsText&&j.push({name:"Solution Suggestions",content:C.solutionsText}),C.confirmationsText&&C.confirmationsText!=="None"&&j.push({name:"Pending Confirmation Info",content:C.confirmationsText});const M=C.translation;return console.groupCollapsed("[LLM] Parsed -> problem_input"),console.log("structuredOutput:",C),console.log("translatedMessage:",je(M)),console.groupEnd(),{steps:j,translatedMessage:M,structuredOutput:C}}catch(d){throw console.error("Error processing problem input:",d),d}},qn=async(s,t,l=[],m=null,c=[])=>{try{const d=Me(l,c),x=[{role:"user",content:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, an AI system specifically designed to optimize bilateral communication, ensuring that enterprises' professional expressions can be transformed into friendly replies that customers can easily understand and accept.

ã€Function Descriptionã€‘After enterprise users input reply content on the right interface, the system activates the "Customer Reply Optimization" function button. The purpose of this button is: to intelligently transform enterprises' professional terminology and formal expressions into customer-friendly, easy-to-understand natural language, allowing customers to experience warm and professional service.

ã€Generation Instructionsã€‘Please perform professional reply optimization: Transform enterprise replies into customer-friendly concise replies, with natural and friendly language that gets straight to the point. Avoid word-by-word counting or outputting any word count-related prompts or markers; do not return intermediate content with growing counts during the process, only output final complete sentences.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**

Enterprise content: "${s}"${d}

Please directly output the final reply to the customer:`}];console.log("ðŸ” Customer reply generation - Prompt sent to LLM:",x);const y=await X(x,.7,2048,m,{enableThinking:!0,stream:!0}),v=y.trim();return console.log("ðŸ” Customer reply generation - LLM raw response:",y),console.log("ðŸ” Customer reply generation - Processed result:",v),console.log("âœ… Customer reply generation completed"),{steps:[{name:"Customer Reply Generation",content:v}],optimizedMessage:v,structuredOutput:{optimizedReply:v,internalNotes:"",additionalInfo:""}}}catch(d){throw console.error("Error processing solution response:",d),d}},Ft=async(s,t,l=[],m=null,c=[])=>{try{const d={retail:{systemRole:`ã€Platform Introductionã€‘The ZeroTouch Intelligent Communication Mediation Platform is handling a retail scenario communication assistance, with the platform goal of making exchanges between customers and business stores more efficient and precise.

ã€Function Descriptionã€‘Enterprise users clicked the "Generate Sales Suggestions" button, the core function of this button is: based on customer needs and current conversation content, quickly generate specific executable sales strategies and solutions for business stores, helping enterprises better respond to customer needs.

ã€Generation Instructionsã€‘Please generate professional retail suggestions for this button function: provide sales suggestions and solutions, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:"ã€Suggestion Scenarioã€‘Based on customer needs and business situation, generate professional sales suggestions, including product recommendations, pricing strategies, service plans and other specific executable suggestions."},enterprise:{systemRole:`ã€Platform Introductionã€‘The ZeroTouch Intelligent Communication Mediation Platform is handling enterprise internal cross-departmental communication, committed to eliminating understanding barriers between business departments and technical departments.

ã€Function Descriptionã€‘Technical team users activated the "Solution Suggestions" button, the function of this button is: based on business needs and technical status quo, quickly generate technical solution suggestions, providing specific implementation directions and strategic guidance for technical teams.

ã€Generation Instructionsã€‘Please generate professional technical suggestions for this button function: provide solution suggestions, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:"ã€Suggestion Scenarioã€‘Based on business needs and technical status quo, generate technical solution suggestions, including architecture design, technology selection, implementation plans and other specific executable suggestions."},education:{systemRole:`ã€Platform Introductionã€‘The ZeroTouch Intelligent Communication Mediation Platform is assisting teacher-student communication in educational scenarios, with the goal of precisely matching learning needs with teaching plans.

ã€Function Descriptionã€‘Teacher users used the "Teaching Suggestion Generation" button, the function of this button is: based on students' learning needs and teaching status quo, quickly generate personalized teaching plan suggestions for teachers, optimizing teaching effectiveness.

ã€Generation Instructionsã€‘Please generate professional teaching suggestions for this button function: provide teaching plan suggestions, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:"ã€Suggestion Scenarioã€‘Based on students' learning needs and teaching status quo, generate teaching suggestions, including teaching methods, course arrangements, learning guidance and other specific executable suggestions."}};if(!t||!d[t])throw new Error(`Invalid scenario type: ${t}`);const u=d[t],x=Me(l,c),y={retail:`Guidance Principles for Suggestion Generation (Retail Enterprise Specific):
1. Sales Strategy Optimization: Provide precise product recommendations and sales strategies based on customer demand characteristics
2. Inventory & Supply Chain: Consider product inventory, seasonal factors and supply chain efficiency
3. Customer Relationship Management: Provide specific suggestions for customer maintenance, repeat purchase promotion and word-of-mouth marketing
4. Pricing Strategy Development: Balance profit margins and market competitiveness, provide flexible pricing suggestions
5. Service Experience Enhancement: Optimize the full-process experience of pre-sales consultation, in-sales service and after-sales support
6. Retail Operations Practicality: Ensure suggestions align with retail industry characteristics and are easy for stores to execute
7. Retail Scenario Inappropriate Language Processing: Transform customer dissatisfaction into specific action plans for service improvement and product optimization`,enterprise:`Guidance Principles for Suggestion Generation (Enterprise Service Specific):
1. Business Value Quantification: Provide measurable ROI, cost savings and efficiency improvement metrics
2. Technical Feasibility Assessment: Balance technological advancement and implementation feasibility, provide risk control suggestions
3. Organizational Change Management: Consider change suggestions for personnel training, process adjustment and cultural adaptation
4. Compliance & Security Assurance: Ensure suggestions comply with industry standards and enterprise security policy requirements
5. Phased Implementation Planning: Provide progressive implementation plans to reduce business interruption risks
6. Enterprise Decision Support: Use business language that decision-makers care about, highlighting strategic value
7. Enterprise Scenario Inappropriate Language Processing: Transform departmental conflicts into suggestions for process optimization and collaboration mechanism improvements`,education:`Guidance Principles for Suggestion Generation (Education Service Specific):
1. Learning Outcome Orientation: Provide personalized teaching suggestions based on learning objectives and student characteristics
2. Teaching Resource Allocation: Reasonably utilize faculty, textbooks and teaching equipment, optimize resource allocation
3. Learning Progress Management: Provide differentiated learning progress arrangements and ability improvement paths
4. Home-School Collaboration Promotion: Establish effective home-school communication mechanisms, forming educational synergy
5. Learning Interest Cultivation: Focus on learning motivation stimulation and interest maintenance method suggestions
6. Educational Professionalism Assurance: Ensure suggestions comply with educational laws and student physical and mental development characteristics
7. Educational Scenario Inappropriate Language Processing: Transform learning difficulties into suggestions for teaching method adjustments and learning support optimization`},v=[{role:"system",content:`${u.systemRole}

${u.context}

${u.example}

Important Requirements:
1) Output concise suggestions, get straight to the point;
2) Avoid bullet points, numbering, excessive preamble;
3) Maintain executability and practicality;
4) Sentences should be complete and fluent.

ã€Key Principles to Prevent Hallucinationã€‘:
- Suggestions must be strictly based on the provided conversation content, must not speculate or add false information
- Do not mention specific product names, prices, times and other details that do not appear in the conversation
- If conversation information is insufficient, suggest understanding relevant information first, rather than fabricating content
- Focus on actually executable operational suggestions, avoid over-specifying non-existent information
- Stay honest, acknowledge insufficient information situations, rather than fabricating details`},{role:"user",content:`Current conversation content: "${s}"${x}

Please provide concise suggestions based on the above real conversation content, highlighting executable key points. Please ensure suggestions are completely based on actual conversation information, do not add any false or unmentioned details.`}],k=(await X(v,.7,2048,m,{enableThinking:!0,stream:!0})||"").trim(),C=[{name:"Suggestion Content",content:k}];return console.groupCollapsed("[LLM] Parsed -> generate_suggestion"),console.log("suggestionMessage:",je(k)),console.groupEnd(),{steps:C,suggestionMessage:k,structuredOutput:{suggestion:k}}}catch(d){throw console.error("Error generating enterprise suggestions:",d),d}},Nt=async(s,t,l=[],m=null,c=[])=>{try{const d={retail:{systemRole:`ã€Platform Introductionã€‘ZeroTouch Intelligent Communication Mediation Platform is providing communication support for retail scenarios, helping enterprise stores better understand customer needs.

ã€Function Descriptionã€‘Enterprise users clicked the "Intelligent Follow-up" button. The purpose of this button is: based on current conversation content, intelligently identify key information that still needs to be understood, generate targeted follow-up questions, helping enterprises obtain more complete customer requirement information.

ã€Generation Instructionsã€‘Please generate professional follow-up questions for this button function: help enterprises understand key information about customer needs, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:"ã€Follow-up Scenarioã€‘Based on current conversation, identify key information that needs further understanding, generate targeted follow-up questions.",example:`Customer says: "Need business suits"
Follow-up: "Could you please tell us your specific usage occasion? What is your approximate budget range? What are your height and weight? Do you have any preferences for color and style?"`},enterprise:{systemRole:`ã€Platform Introductionã€‘ZeroTouch Intelligent Communication Mediation Platform is assisting enterprise internal cross-departmental communication, focusing on eliminating information gaps between business requirements and technical implementation.

ã€Function Descriptionã€‘Technical team users activated the "Requirements Deep Dive" button. The role of this button is: based on business side expressions, intelligently generate in-depth business requirement follow-up questions, helping technical teams obtain complete information needed for implementation.

ã€Generation Instructionsã€‘Please generate professional follow-up questions for this button function: help technical teams gain deep understanding of business requirements, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:"ã€Follow-up Scenarioã€‘Based on current conversation, identify key information needed for technical implementation, generate targeted follow-up questions.",example:`Business side says: "Need to improve user experience"
Follow-up: "Which specific aspects of experience do you want to improve? Who is the target user group? What are the current pain points? Do you have specific time requirements? What is the budget range?"`},education:{systemRole:`ã€Platform Introductionã€‘ZeroTouch Intelligent Communication Mediation Platform is providing teacher-student communication support for educational scenarios, committed to making teaching more precise and effective.

ã€Function Descriptionã€‘Teacher users used the "Learning Situation Understanding" button. The function of this button is: based on learning difficulties expressed by students, intelligently generate follow-up questions to understand students' specific learning situations, helping teachers formulate personalized teaching plans.

ã€Generation Instructionsã€‘Please generate professional follow-up questions for this button function: help teachers understand students' learning situations, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:"ã€Follow-up Scenarioã€‘Based on current conversation, identify key information needed for teaching, generate targeted follow-up questions.",example:`Student says: "Don't understand this concept"
Follow-up: "Have you learned related basic knowledge before? Which learning method do you prefer? What level of understanding do you hope to achieve? Do you have any specific learning goals?"`}};if(!t||!d[t])throw new Error(`Invalid scenario type: ${t}`);const u=d[t],x=Me(l,c),y={retail:`Follow-up Generation Guidance Principles (Retail Enterprise Specific):
1. Sales Opportunity Mining: Identify customer potential needs, generate key follow-ups that promote transactions
2. Product Matching Precision: Understand customer specific usage scenarios and preferences through follow-ups
3. Price Sensitivity Detection: Skillfully understand customer budget range and value perception
4. Competitive Product Analysis: Understand customer perception and comparison standards of competitive products
5. Purchase Decision Process: Identify key factors and decision-makers that influence purchase decisions
6. Retail Scenario Adaptability: Ensure follow-up methods comply with retail environment communication characteristics
7. Retail Scenario Inappropriate Language Processing: Transform customer complaints into follow-up opportunities to understand real needs`,enterprise:`Follow-up Generation Guidance Principles (Enterprise Service Specific):
1. Business Needs Deep Mining: Understand enterprise real business pain points and goals through follow-ups
2. Decision Chain Identification: Understand enterprise internal decision-making processes and key decision-makers
3. Budget & Time Constraints: Explore project budget scope and implementation time requirements
4. Technical Environment Assessment: Understand enterprise existing technical architecture and integration requirements
5. Risk Tolerance Capability: Assess enterprise acceptance of new technologies and changes
6. Enterprise-level Professionalism: Use business language familiar to enterprise decision-makers for follow-ups
7. Enterprise Scenario Inappropriate Language Processing: Transform internal disagreements into follow-up strategies to understand various departmental needs`,education:`Follow-up Generation Guidance Principles (Education Service Specific):
1. Learning Goal Clarification: Understand specific learning goals and expected outcomes through follow-ups
2. Learning Ability Assessment: Understand student current level, learning habits and ability characteristics
3. Learning Environment Analysis: Explore home learning environment and school teaching conditions
4. Learning Motivation Stimulation: Understand student interest points and learning motivation sources
5. Parent Expectation Management: Balance differences between parent expectations and student actual abilities
6. Educational Professionalism Assurance: Ensure follow-ups comply with educational laws and student psychological characteristics
7. Educational Scenario Inappropriate Language Processing: Transform learning setbacks into follow-up opportunities to understand learning obstacles`},v=[{role:"system",content:`${u.systemRole}

${u.context}

Important Requirements:
1) Only generate one concise follow-up question, not multiple sentences
2) Follow-up should hit the key points, asking for the most critical information
3) Sentences should be natural and fluent, ending with a question mark
4) Avoid lengthy expressions, keep concise and clear
5) Focus on the core information points that most need to be understood`},{role:"user",content:`Current conversation content: "${s}"${x}

Please generate one concise follow-up question, hitting key points, asking for the most critical information. Just one sentence is needed.`}],k=(await X(v,.7,1024,m,{enableThinking:!0,stream:!0})||"").trim(),C=[{name:"Follow-up Content",content:k}];return console.groupCollapsed("[LLM] Parsed -> generate_followup"),console.log("followUpMessage:",je(k)),console.groupEnd(),{steps:C,followUpMessage:k,structuredOutput:{followUp:k}}}catch(d){throw console.error("Error generating enterprise follow-up:",d),d}},On=async s=>{const t=[{role:"system",content:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specialized in context analysis.

ã€Function Descriptionã€‘The system activated the "Context Analysis" function button, used to identify business scenarios and contextual backgrounds of user input.

ã€Generation Instructionsã€‘Please identify business scenarios, industry backgrounds or usage environments of user input based on professional context analysis requirements.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`},{role:"user",content:`User input: "${s}"

Please analyze the business scenarios, industry backgrounds or usage environments that this input may involve.`}];return await X(t,.7,1024,null,{enableThinking:!1,stream:!1})},Ln=async s=>{const t=[{role:"system",content:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specialized in concept design.

ã€Function Descriptionã€‘The system activated the "Concept Design" function button, used to transform user requirements into specific concepts and feature points.

ã€Generation Instructionsã€‘Please transform user requirements into specific functional requirements or solution key points based on professional concept design requirements.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`},{role:"user",content:`Based on user input: "${s}"

Please conceptualize it into specific functional requirements or solution key points.`}];return await X(t,.7,1024,null,{enableThinking:!1,stream:!1})},Fn=async s=>{const t=[{role:"system",content:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specialized in requirements completeness checking.

ã€Function Descriptionã€‘The system activated the "Missing Information Detection" function button, used to identify possible missing key information in user input.

ã€Generation Instructionsã€‘Please identify what additional information is needed to better understand and satisfy user requirements based on professional requirements completeness checking requirements.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`},{role:"user",content:`User input: "${s}"

Please identify what additional information is needed to better understand and satisfy user requirements?`}];return await X(t,.7,1024,null,{enableThinking:!1,stream:!1})},Un=async s=>{const t=[{role:"system",content:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specialized in requirements translation.

ã€Function Descriptionã€‘The system activated the "Requirements Translation" function button, used to transform user's original input into clear, professional requirement descriptions.

ã€Generation Instructionsã€‘Please transform user original input into clear, professional requirement descriptions containing specific functional requirements and expected results based on professional requirements translation requirements.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`},{role:"user",content:`User original input: "${s}"

Please transform it into clear, professional requirement descriptions containing specific functional requirements and expected results.`}];return await X(t,.7,1024,null,{enableThinking:!1,stream:!1})},zn=async s=>{const t=[{role:"system",content:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specialized in user experience optimization.

ã€Function Descriptionã€‘The system activated the "User-Friendly Optimization" function button, used to transform technical solutions into user-friendly language and provide clear action guides.

ã€Generation Instructionsã€‘Please transform technical solutions into user-friendly language containing clear steps and expected results based on professional user experience optimization requirements.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`},{role:"user",content:`Technical solution: "${s}"

Please transform it into user-friendly language containing clear steps and expected results.`}];return await X(t,.7,1024,null,{enableThinking:!1,stream:!1})},Gn=async(s,t,l,m=[],c=null,d=[])=>{try{const x={retail:{systemRole:`ã€Platform Introductionã€‘ZeroTouchæ™ºèƒ½æ²Ÿé€šä¸­ä»‹å¹³å°æ­£åœ¨ä¸ºé›¶å”®åœºæ™¯æä¾›æ™ºèƒ½åˆ†æžæœåŠ¡ï¼Œå¸®åŠ©ä¼ä¸šæ›´ç²¾å‡†åœ°ç†è§£é¡¾å®¢éœ€æ±‚ã€‚

ã€Function Descriptionã€‘ç³»ç»Ÿå¯åŠ¨äº†"éœ€æ±‚ä¿¡æ¯åˆ†æž"æŒ‰é’®ï¼Œè¿™ä¸ªæŒ‰é’®çš„ä½œç”¨æ˜¯ï¼šåŸºäºŽé¡¾å®¢çš„åˆæ­¥è¡¨è¾¾ï¼Œæ™ºèƒ½è¯†åˆ«è¿˜éœ€è¦äº†è§£çš„å…³é”®ä¿¡æ¯ç‚¹ï¼Œä¸ºä¼ä¸šæä¾›å…·ä½“çš„ä¿¡æ¯æ”¶é›†é€‰é¡¹ï¼Œç¡®ä¿åŽç»­æ²Ÿé€šæ›´åŠ é«˜æ•ˆã€‚

ã€Generation Instructionsã€‘è¯·ä¸ºè¿™ä¸ªæŒ‰é’®åŠŸèƒ½è¿›è¡Œä¸“ä¸šçš„éœ€æ±‚åˆ†æžï¼šé’ˆå¯¹ä»»ä½•äº§å“ç²¾å‡†è¯†åˆ«å…·ä½“çš„å…³é”®ä¿¡æ¯ç‚¹ã€‚

**âš¡ é‡è¦ï¼šå›žç­”å¿…é¡»ç®€æ´æ˜Žäº†ã€ç›´è¾¾è¦ç‚¹ï¼Œé¿å…å†—é•¿è¡¨è¾¾å’Œä¸å¿…è¦çš„ç»†èŠ‚æè¿°ã€‚ç¦æ­¢è¿‡åº¦æŽ¨ç†ï¼Œç›´æŽ¥ç»™å‡ºå®žç”¨ç­”æ¡ˆã€‚**`,instruction:`åˆ†æžç”¨æˆ·éœ€æ±‚æ—¶ï¼Œè¦ç”Ÿæˆå…·ä½“çš„ã€å¯æ“ä½œçš„ä¿¡æ¯é€‰é¡¹ï¼Œè€Œä¸æ˜¯æŠ½è±¡æ¦‚å¿µã€‚

ä¾‹å¦‚ï¼š
- ç”¨æˆ·è¯´"æˆ‘è¦ä¹°ä»¶è¡£æœ" â†’ ç”Ÿæˆï¼šå°ºç ã€é¢œè‰²ã€ä»·ä½ã€åœºåˆã€æè´¨
- ç”¨æˆ·è¯´"æˆ‘è¦ä¹°ä¸ªæ‰‹æœº" â†’ ç”Ÿæˆï¼šé¢„ç®—ã€å“ç‰Œã€åŠŸèƒ½éœ€æ±‚ã€å­˜å‚¨å®¹é‡ã€é¢œè‰²
- ç”¨æˆ·è¯´"æˆ‘è¦è£…ä¿®" â†’ ç”Ÿæˆï¼šé¢ç§¯ã€é£Žæ ¼ã€é¢„ç®—ã€æ—¶é—´ã€æˆ¿é—´ç±»åž‹

è¦æ±‚ï¼š
1. æ¯ä¸ªé€‰é¡¹åç§°2-4ä¸ªå­—ï¼Œç®€æ´æ˜Žäº†
2. å¿…é¡»æ˜¯å…·ä½“çš„ã€å¯ç›´æŽ¥è¯¢é—®çš„ä¿¡æ¯ç‚¹
3. ä¸Žè¯¥äº§å“/æœåŠ¡ç›´æŽ¥ç›¸å…³ï¼Œä¸è¦æŠ½è±¡æ¦‚å¿µ
4. æŒ‰é‡è¦æ€§æŽ’åºï¼Œæœ€é‡è¦çš„æ”¾å‰é¢`},enterprise:{systemRole:`ã€Platform Introductionã€‘ZeroTouchæ™ºèƒ½æ²Ÿé€šä¸­ä»‹å¹³å°æ­£åœ¨ä¸ºä¼ä¸šå†…éƒ¨è·¨éƒ¨é—¨æ²Ÿé€šæä¾›æ™ºèƒ½åˆ†æžï¼Œä¸“æ³¨äºŽè¯†åˆ«ä¸šåŠ¡éœ€æ±‚çš„å…³é”®è¦ç´ ã€‚

ã€Function Descriptionã€‘ç³»ç»Ÿæ¿€æ´»äº†"ä¸šåŠ¡éœ€æ±‚è§£æž"æŒ‰é’®ï¼Œè¿™ä¸ªæŒ‰é’®çš„åŠŸèƒ½æ˜¯ï¼šåŸºäºŽä¸šåŠ¡éƒ¨é—¨çš„è¡¨è¾¾ï¼Œæ™ºèƒ½åˆ†æžæŠ€æœ¯å®žçŽ°æ‰€éœ€çš„å…³é”®ä¿¡æ¯ç‚¹ï¼Œä¸ºæŠ€æœ¯å›¢é˜Ÿæä¾›æ˜Žç¡®çš„ä¿¡æ¯æ”¶é›†æ–¹å‘ã€‚

ã€Generation Instructionsã€‘è¯·ä¸ºè¿™ä¸ªæŒ‰é’®åŠŸèƒ½è¿›è¡Œä¸“ä¸šçš„éœ€æ±‚åˆ†æžï¼šé’ˆå¯¹ä»»ä½•ä¸šåŠ¡éœ€æ±‚ç²¾å‡†è¯†åˆ«å…·ä½“çš„å…³é”®ä¿¡æ¯ç‚¹ã€‚

**âš¡ é‡è¦ï¼šå›žç­”å¿…é¡»ç®€æ´æ˜Žäº†ã€ç›´è¾¾è¦ç‚¹ï¼Œé¿å…å†—é•¿è¡¨è¾¾å’Œä¸å¿…è¦çš„ç»†èŠ‚æè¿°ã€‚ç¦æ­¢è¿‡åº¦æŽ¨ç†ï¼Œç›´æŽ¥ç»™å‡ºå®žç”¨ç­”æ¡ˆã€‚**`,instruction:`åˆ†æžä¸šåŠ¡éœ€æ±‚æ—¶ï¼Œè¦ç”Ÿæˆå…·ä½“çš„ã€å¯æ“ä½œçš„ä¿¡æ¯é€‰é¡¹ï¼Œè€Œä¸æ˜¯æŠ½è±¡æ¦‚å¿µã€‚

ä¾‹å¦‚ï¼š
- ç”¨æˆ·è¯´"æˆ‘è¦å¼€å‘ç³»ç»Ÿ" â†’ ç”Ÿæˆï¼šé¢„ç®—è§„æ¨¡ã€å¼€å‘å‘¨æœŸã€ç”¨æˆ·æ•°é‡ã€æ ¸å¿ƒåŠŸèƒ½ã€æŠ€æœ¯æ ˆ
- ç”¨æˆ·è¯´"æˆ‘è¦åšè¥é”€" â†’ ç”Ÿæˆï¼šç›®æ ‡å®¢ç¾¤ã€æŽ¨å¹¿æ¸ é“ã€æ´»åŠ¨é¢„ç®—ã€æ•ˆæžœæœŸæœ›ã€æ—¶é—´å®‰æŽ’
- ç”¨æˆ·è¯´"æˆ‘è¦åŸ¹è®­å‘˜å·¥" â†’ ç”Ÿæˆï¼šåŸ¹è®­äººæ•°ã€åŸ¹è®­å†…å®¹ã€æ—¶é—´å®‰æŽ’ã€åŸ¹è®­æ–¹å¼ã€é¢„ç®—èŒƒå›´

è¦æ±‚ï¼š
1. æ¯ä¸ªé€‰é¡¹åç§°2-4ä¸ªå­—ï¼Œç®€æ´æ˜Žäº†
2. å¿…é¡»æ˜¯å…·ä½“çš„ã€å¯ç›´æŽ¥è¯¢é—®çš„ä¿¡æ¯ç‚¹
3. ä¸Žè¯¥ä¸šåŠ¡éœ€æ±‚ç›´æŽ¥ç›¸å…³ï¼Œä¸è¦æŠ½è±¡æ¦‚å¿µ
4. æŒ‰é‡è¦æ€§æŽ’åºï¼Œæœ€é‡è¦çš„æ”¾å‰é¢`},education:{systemRole:`ã€Platform Introductionã€‘ZeroTouchæ™ºèƒ½æ²Ÿé€šä¸­ä»‹å¹³å°æ­£åœ¨ä¸ºæ•™è‚²åœºæ™¯æä¾›å­¦ä¹ éœ€æ±‚æ™ºèƒ½åˆ†æžï¼Œå¸®åŠ©æ•™å¸ˆæ›´å¥½åœ°ç†è§£å­¦ç”Ÿçš„å…·ä½“å­¦ä¹ æƒ…å†µã€‚

ã€Function Descriptionã€‘ç³»ç»Ÿå¯ç”¨äº†"å­¦ä¹ éœ€æ±‚åˆ†æž"æŒ‰é’®ï¼Œè¿™ä¸ªæŒ‰é’®çš„ç›®çš„æ˜¯ï¼šåŸºäºŽå­¦ç”Ÿè¡¨è¾¾çš„å­¦ä¹ å›°éš¾ï¼Œæ™ºèƒ½è¯†åˆ«åˆ¶å®šæ•™å­¦æ–¹æ¡ˆæ‰€éœ€çš„å…³é”®ä¿¡æ¯ç‚¹ï¼Œä¸ºæ•™å¸ˆæä¾›ç²¾å‡†çš„äº†è§£æ–¹å‘ã€‚

ã€Generation Instructionsã€‘è¯·ä¸ºè¿™ä¸ªæŒ‰é’®åŠŸèƒ½è¿›è¡Œä¸“ä¸šçš„éœ€æ±‚åˆ†æžï¼šé’ˆå¯¹ä»»ä½•å­¦ä¹ éœ€æ±‚ç²¾å‡†è¯†åˆ«å…·ä½“çš„å…³é”®ä¿¡æ¯ç‚¹ã€‚

**âš¡ é‡è¦ï¼šå›žç­”å¿…é¡»ç®€æ´æ˜Žäº†ã€ç›´è¾¾è¦ç‚¹ï¼Œé¿å…å†—é•¿è¡¨è¾¾å’Œä¸å¿…è¦çš„ç»†èŠ‚æè¿°ã€‚ç¦æ­¢è¿‡åº¦æŽ¨ç†ï¼Œç›´æŽ¥ç»™å‡ºå®žç”¨ç­”æ¡ˆã€‚**`,instruction:`åˆ†æžå­¦ä¹ éœ€æ±‚æ—¶ï¼Œè¦ç”Ÿæˆå…·ä½“çš„ã€å¯æ“ä½œçš„ä¿¡æ¯é€‰é¡¹ï¼Œè€Œä¸æ˜¯æŠ½è±¡æ¦‚å¿µã€‚

ä¾‹å¦‚ï¼š
- ç”¨æˆ·è¯´"æˆ‘è¦å­¦è‹±è¯­" â†’ ç”Ÿæˆï¼šå½“å‰æ°´å¹³ã€å­¦ä¹ ç›®æ ‡ã€æ—¶é—´å®‰æŽ’ã€å­¦ä¹ æ–¹å¼ã€é¢„ç®—è€ƒè™‘
- ç”¨æˆ·è¯´"å­©å­è¦è¡¥æ•°å­¦" â†’ ç”Ÿæˆï¼šå¹´çº§é˜¶æ®µã€è–„å¼±çŽ¯èŠ‚ã€ä¸Šè¯¾æ—¶é—´ã€æœŸæœ›æ•ˆæžœã€è´¹ç”¨é¢„ç®—
- ç”¨æˆ·è¯´"æˆ‘è¦è€ƒè¯" â†’ ç”Ÿæˆï¼šè€ƒè¯•æ—¶é—´ã€åŸºç¡€æƒ…å†µã€å­¦ä¹ æ—¶é—´ã€åŸ¹è®­æ–¹å¼ã€é€šè¿‡ç›®æ ‡

è¦æ±‚ï¼š
1. æ¯ä¸ªé€‰é¡¹åç§°2-4ä¸ªå­—ï¼Œç®€æ´æ˜Žäº†
2. å¿…é¡»æ˜¯å…·ä½“çš„ã€å¯ç›´æŽ¥è¯¢é—®çš„ä¿¡æ¯ç‚¹
3. ä¸Žè¯¥å­¦ä¹ éœ€æ±‚ç›´æŽ¥ç›¸å…³ï¼Œä¸è¦æŠ½è±¡æ¦‚å¿µ
4. æŒ‰é‡è¦æ€§æŽ’åºï¼Œæœ€é‡è¦çš„æ”¾å‰é¢`}}[l];if(!x)throw new Error(`ä¸æ”¯æŒçš„åœºæ™¯ç±»åž‹: ${l}`);const y=Me(m,d),v=[{role:"system",content:`${x.systemRole}

${x.instruction}

ã€Importantã€‘Input content filtering and intelligent processing rules:
1. Inappropriate language handling: If user input contains profanity, vulgarity, or aggressive words, do not repeat this content, but:
   - Identify as "user emotional expression" or "test input"
   - Understand possible real intentions (such as expressing dissatisfaction, seeking help, random testing, etc.)
   - Respond in a professional and friendly manner

2. Meaningless input handling: If input is:
   - Random letter/number combinations (like "cnm", "123", "aaa")
   - Single words without clear requirement meaning
   - Obviously test inputs
   Identify as "users needing guidance", suggest providing real requirements

3. Negative emotion recognition: If input expresses dissatisfaction or negative emotions, transform into opportunities to understand problems and provide help

Please output in the following format:

ã€REQUIREMENTS UNDERSTANDINGã€‘
Briefly summarize the user's core requirements (no more than 30 words)
- For valid requirements: normal summary
- For inappropriate input: state "user test input" or "user emotional expression"
- For meaningless input: state "input content unclear, needs guidance"

ã€INFORMATION OPTIONSã€‘
Generate options for specific requirements, format: option name|inquiry reason
- For valid requirements: normally generate 3-5 options
- For invalid input: return "no need to collect additional information"

ã€REQUIREMENTS TRANSLATIONã€‘
Transform into professional description:
- For valid requirements: normal translation
- For inappropriate input: translate to "customer may be testing system or expressing emotions, suggest friendly guidance to provide specific requirements"
- For meaningless input: translate to "customer input is unclear, suggest actively asking what help can be provided"`},{role:"user",content:`User input: "${s}"${t?`
(User also uploaded an image)`:""}${y}

Please analyze this input, and if it contains inappropriate language or meaningless content, please handle it intelligently.`}],b=await X(v,.7,2048,c,{enableThinking:!0,stream:!0}),k=Ot(b),C=k.match(/ã€REQUIREMENTS UNDERSTANDINGã€‘\s*\n([\s\S]*?)(?=\nã€|$)/),j=k.match(/ã€INFORMATION OPTIONSã€‘\s*\n([\s\S]*?)(?=\nã€|$)/),M=k.match(/ã€REQUIREMENTS TRANSLATIONã€‘\s*\n([\s\S]*?)(?=\nã€|$)/),F=C?C[1].trim():"éœ€æ±‚åˆ†æž",D=j?j[1].trim():"",q=M?M[1].trim():`å®¢æˆ·å’¨è¯¢ï¼š${s}ï¼Œå»ºè®®äº†è§£å®¢æˆ·çš„å…·ä½“éœ€æ±‚ä»¥æä¾›ç²¾å‡†çš„${currentScenario||"retail"}æœåŠ¡è§£å†³æ–¹æ¡ˆã€‚`,O=[];if(D){const U=D.split(`
`).filter(J=>J.trim());for(const J of U){const E=J.match(/^[â€¢\-\*]?\s*([^|]{2,8})\|(.+)$/);E&&O.push({name:E[1].trim(),description:E[2].trim(),selected:!1})}}return console.log("[LLM] Intelligent demand analysis results:",{needsUnderstanding:F,missingInfoOptions:O,translation:q}),{needsUnderstanding:F,missingInfoOptions:O,translation:q,structuredOutput:{needsUnderstanding:F,missingInfoOptions:O,translation:q}}}catch(u){throw console.error("Intelligent demand analysis error:",u),u}},Ut=async(s,t,l=[],m=[])=>{try{console.log(`
=== Starting negotiation suggestion processing ===`),console.log("Original suggestion:",s.originalSuggestion),console.log("Negotiation request:",s.negotiationRequest),console.log("Scenario:",t);const c=Me(l,m),d=`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system that supports dynamic negotiation optimization, allowing users to engage in multiple rounds of negotiation with AI to continuously improve and adjust suggestion content.

ã€Function Descriptionã€‘Users are not completely satisfied with the previously generated suggestions and clicked the "Negotiation Optimization" button. The function of this button is: based on the user's specific negotiation requirements, intelligently adjust and improve the original suggestions to generate optimization plans that better meet the user's actual needs.

ã€Generation Instructionsã€‘Please make in-depth adjustments to suggestions based on professional negotiation optimization requirements: modify and optimize the original suggestions according to the user's negotiation requirements, ensuring suggestions are specific and actionable, meet negotiation requirements, maintain professionalism and practicality, and use natural and coherent sentence expressions.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`;let u="";s.negotiationHistory&&s.negotiationHistory.length>0&&(u=`

Negotiation History:
`+s.negotiationHistory.map((k,C)=>`Negotiation ${C+1}: ${k.negotiationRequest}`).join(`
`));const x=`Current Suggestion:
${s.originalSuggestion}

Latest Negotiation Request:
${s.negotiationRequest}${u}

Please based on all the above negotiation history, directly output the optimized complete suggestion, ensuring content is complete and sentences are fluent.${c}`,y=[{role:"system",content:d},{role:"user",content:x}];console.log("Sending negotiation request to LLM...");const v=await X(y,.7,3072,null,{enableThinking:!1,stream:!1});console.log("LLM negotiation response:",je(v));const b=(v||"").trim();return console.log("Negotiation processing completed"),console.log("Optimized suggestion:",je(b)),{steps:[{name:"Negotiation Optimization",content:b}],suggestionMessage:b}}catch(c){throw console.error("Negotiation suggestion processing error:",c),c}},Hn=async(s,t,l,m=[],c=null,d=[])=>{try{const u={retail:{systemRole:`ã€Platform Introductionã€‘The ZeroTouch Intelligent Communication Mediation Platform is providing precise follow-up services for retail scenarios, helping enterprise stores collect complete customer demand information.

ã€Function Descriptionã€‘Enterprise users selected key information points and clicked the "Generate Follow-up" button. The function of this button is: based on the selected information points, intelligently generate natural and fluent follow-up questions, integrating multiple information needs into one friendly question to improve communication efficiency.

ã€Generation Instructionsã€‘Please generate professional follow-up questions for this button function: help enterprises understand key information about customer needs, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:"ã€Follow-up Scenarioã€‘Generate targeted follow-up questions based on customer original needs and key information points identified by enterprise intelligent analysis.",example:`Customer says: "Need business suits", Enterprise focuses on: size, color, budget
Follow-up: "To recommend the most suitable business suit for you, please let us know your size, preferred color and approximate budget range?"`},enterprise:{systemRole:`ã€Platform Introductionã€‘The ZeroTouch Intelligent Communication Mediation Platform is providing information collection services for enterprise cross-departmental communication, focusing on obtaining complete information required for technical implementation.

ã€Function Descriptionã€‘Technical team users selected important information points and activated the "Generate Inquiry" button. The function of this button is: based on selected business information needs, intelligently generate a professional inquiry containing multiple key points, helping technical teams obtain required information in one go.

ã€Generation Instructionsã€‘Please generate professional follow-up questions for this button function: help technical teams gain in-depth understanding of business needs, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:"ã€Follow-up Scenarioã€‘Generate targeted follow-up questions based on business needs and key information points identified by enterprise intelligent analysis.",example:`Business side says: "Need to improve user experience", Enterprise focuses on: target users, specific functions, time requirements
Follow-up: "To develop the most suitable plan, please clarify the target user groups, specific functions you hope to improve, and expected completion time?"`},education:{systemRole:`ã€Platform Introductionã€‘The ZeroTouch Intelligent Communication Mediation Platform is providing learning situation understanding services for educational scenarios, helping teachers collect key information needed to develop teaching plans.

ã€Function Descriptionã€‘Teacher users selected information points of concern and used the "Generate Inquiry" button. The purpose of this button is: based on selected learning information needs, intelligently generate a comprehensive understanding question to help teachers fully grasp student situations.

ã€Generation Instructionsã€‘Please generate professional follow-up questions for this button function: help teachers understand students' learning situations, intelligently filter and transform inappropriate expressions, ensuring communication professionalism.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,context:"ã€Follow-up Scenarioã€‘Generate targeted follow-up questions based on learning needs and key information points identified by enterprise intelligent analysis.",example:`Student says: "Don't understand math concepts", Enterprise focuses on: grade, specific chapters, learning methods
Follow-up: "To develop a personalized tutoring plan, please let us know your grade, specific chapters you don't understand, and your preferred learning methods?"`}};if(!l||!u[l])throw new Error(`Invalid scenario type: ${l}`);const x=u[l],y=Me(m,d),v={retail:`Follow-up Generation Guidance Principles (Retail Enterprise Specific):
1. Sales Opportunity Mining: Identify customer potential needs, generate key follow-ups that promote transactions
2. Product Matching Precision: Understand customer specific usage scenarios and preferences through follow-ups
3. Price Sensitivity Detection: Skillfully understand customer budget range and value perception
4. Competitive Product Analysis: Understand customer perception and comparison standards of competitive products
5. Purchase Decision Process: Identify key factors and decision-makers that influence purchase decisions
6. Retail Scenario Adaptability: Ensure follow-up methods comply with retail environment communication characteristics
7. Intelligent Information Integration: Naturally integrate key information points identified by AI analysis into follow-ups`,enterprise:`Follow-up Generation Guidance Principles (Enterprise Service Specific):
1. Business Needs Deep Mining: Understand enterprise real business pain points and goals through follow-ups
2. Decision Chain Identification: Understand enterprise internal decision-making processes and key decision-makers
3. Budget & Time Constraints: Explore project budget scope and implementation time requirements
4. Technical Environment Assessment: Understand enterprise existing technical architecture and integration requirements
5. Risk Tolerance Capability: Assess enterprise acceptance of new technologies and changes
6. Enterprise-level Professionalism: Use business language familiar to enterprise decision-makers for follow-ups
7. Intelligent Information Integration: Naturally integrate key information points identified by AI analysis into follow-ups`,education:`Follow-up Generation Guidance Principles (Education Service Specific):
1. Learning Goal Clarification: Understand specific learning goals and expected outcomes through follow-ups
2. Learning Ability Assessment: Understand student current level, learning habits and ability characteristics
3. Learning Environment Analysis: Explore home learning environment and school teaching conditions
4. Learning Motivation Stimulation: Understand student interest points and learning motivation sources
5. Parent Expectation Management: Balance differences between parent expectations and student actual abilities
6. Educational Professionalism Assurance: Ensure follow-ups comply with educational laws and student psychological characteristics
7. Intelligent Information Integration: Naturally integrate key information points identified by AI analysis into follow-ups`},b=t.map(F=>`${F.name}ï¼š${F.description}`).join(`
`),k=[{role:"system",content:`${x.systemRole}

${x.context}

${v[l]}

        Important Requirements:
1) Generate only one concise inquiry sentence, not multiple sentences;
2) Naturally integrate all selected information points into one sentence;
3) Ensure content is specific and clear with complete sentences, ending with a question mark.`},{role:"user",content:`Original Requirements: "${s}"

Enterprise Selected Information Points:
${b}

${y}

Please generate one concise and clear inquiry sentence based on the above selected information points, naturally integrating all information points. Just one sentence is needed.`}];let C=await X(k,.7,1024,c,{enableThinking:!0,stream:!0}),j=Rt(C);if(j=Mt(j),j.length<10||!j.includes("ï¼Ÿ")||j.split("ï¼Ÿ").filter(F=>F.trim()).length>1){const F=[{role:"system",content:`${x.systemRole}

${x.context}

Important Requirements:
1) Can only output one follow-up question, ending with a question mark;
2) Must include all selected information points;
3) Sentences should be concise and clear, avoiding lengthy expressions.`},{role:"user",content:`Original Requirements: "${s}"

Selected Information Points:
${b}

Please generate one concise follow-up question, naturally integrating all information points. Just one sentence is needed.${y}`}];C=await X(F,.8,1024,null,{enableThinking:!1,stream:!1}),j=Mt(Rt(C))}const M=An(j.trim());return console.groupCollapsed("[LLM] Parsed -> generate_questions_by_selected_info"),console.log("followUpMessage:",je(M)),console.groupEnd(),M}catch(u){throw console.error("Follow-up generation error:",u),u}},Bn=async(s,t,l=[],m=[])=>{try{console.log(`
=== Starting follow-up negotiation processing ===`),console.log("Original follow-up:",s.originalFollowUp),console.log("Negotiation request:",s.negotiationRequest),console.log("Scenario:",t);const c=Me(l,m),d=`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system that supports dynamic negotiation optimization, allowing users to conduct multiple rounds of negotiation adjustments on generated follow-up questions to ensure the follow-up methods best meet actual needs.

ã€Function Descriptionã€‘Users are not satisfied with the previously generated follow-up questions and clicked the "Follow-up Negotiation" button. The purpose of this button is: based on the user's specific negotiation feedback, intelligently adjust and rephrase the original follow-up questions to generate more suitable inquiry methods.

ã€Generation Instructionsã€‘Please make precise adjustments to follow-up questions based on professional follow-up negotiation requirements: modify and optimize the original follow-up questions according to the user's negotiation requirements, ensuring follow-up questions are specific and actionable, meet negotiation requirements, maintain professionalism and practicality, and use natural and coherent sentence expressions.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`;let u="";s.negotiationHistory&&s.negotiationHistory.length>0&&(u=`

Negotiation History:
`+s.negotiationHistory.map((k,C)=>`Negotiation ${C+1}: ${k.negotiationRequest}`).join(`
`));const x=`Current Follow-up:
${s.originalFollowUp}

Latest Negotiation Request:
${s.negotiationRequest}${u}

Please based on all the above negotiation history, directly output the optimized complete follow-up question, ensuring content is complete and sentences are fluent.${c}`,y=[{role:"system",content:d},{role:"user",content:x}];console.log("å‘é€åå•†è¿½é—®è¯·æ±‚åˆ°LLM...");const v=await X(y,.7,2048,null,{enableThinking:!1,stream:!1});console.log("LLMåå•†è¿½é—®å“åº”:",je(v));const b=(v||"").trim();return console.log("åå•†è¿½é—®å¤„ç†å®Œæˆ"),console.log("ä¼˜åŒ–è¿½é—®:",je(b)),{steps:[{name:"åå•†ä¼˜åŒ–",content:b}],followUpMessage:b}}catch(c){throw console.error("åå•†è¿½é—®å¤„ç†é”™è¯¯:",c),c}},re=async({type:s,content:t,image:l,context:m,scenario:c,chatHistory:d=[],aiChatHistory:u=[],currentContext:x=null,streamCallbacks:y=null})=>{try{if(s==="problem_input")return await $n(t,l,c,d,u);if(s==="analyze_needs_with_missing_info")return await Gn(t,l,c,d,y,u);if(s==="comprehensive_analysis_with_suggestion")return await Ht(t,l,c,d,y,u);if(s==="generate_questions_by_selected_info"){const{originalContent:v,selectedInfoItems:b}=t;return await Hn(v,b,c,d,y,u)}else{if(s==="solution_response")return await qn(t,c,d,y,u);if(s==="generate_suggestion")return await Ft(t,c,d,y,u);if(s==="generate_followup")return await Nt(t,c,d,y,u);if(s==="generate_simple_followup")return await Nt(t,c,d,y,u);if(s==="negotiate_suggestion")return await Ut(t,c,d,u);if(s==="negotiate_followup")return await Bn(t,c,d,u);if(s==="generate_department_contact")return await zt(t,c,d,u);if(s==="generate_department_contact_only")return await Gt(t,c,d,u);if(s==="ai_chat")return await Lt(t,c,u,x,y);if(s==="generate_department_suggestion")return await Bt(t,c,d,u);if(s==="generate_department_contact_with_instructions")return await Wt(t,c,d,y,u);if(s==="emergency_handling")return await Yt(t,c,y)}throw new Error("Unknown processing type")}catch(v){throw console.error("LLM processing error:",v),v}},zt=async(s,t,l=[],m=[])=>{try{console.log(`
=== Starting department contact instruction generation ===`),console.log("Suggestion content:",s),console.log("Scenario:",t);const c=Me(l,m),d={retail:{systemRole:"You are a professional retail customer service supervisor responsible for coordinating various departments to handle customer issues.",context:"Generate standard customer replies and internal contact instructions based on customer service suggestions.",departments:["Order Department","Logistics Department","After-sales Department","Technical Department","Finance Department"]},finance:{systemRole:"You are a professional financial customer service supervisor responsible for coordinating various departments to handle customer business.",context:"Generate standard customer replies and internal contact instructions based on customer service suggestions.",departments:["Business Department","Risk Control Department","Technical Department","Compliance Department","Operations Department"]},logistics:{systemRole:"You are a professional logistics customer service supervisor responsible for coordinating various departments to handle customer issues.",context:"Generate standard customer replies and internal contact instructions based on customer service suggestions.",departments:["Transportation Department","Warehousing Department","Customer Service Department","Technical Department","Settlement Department"]}},x=`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specifically designed to optimize customer service and internal coordination, helping enterprises achieve seamless integration between external communication and internal coordination when handling customer issues.

ã€Function Descriptionã€‘Customer service representatives, based on system suggestions, are preparing to handle customer issues and clicked the "Generate Contact Instructions" button. This button has dual functions: on one hand, it generates professional and friendly replies to customers, and on the other hand, it generates specific action instructions for relevant internal departments to ensure comprehensive problem resolution.

ã€Generation Instructionsã€‘Please generate two types of standard outputs simultaneously based on professional contact instruction generation requirements:

1. ã€Customer Replyã€‘- Generate professional replies to customers
- Tone should be friendly, professional, empathetic, clearly explaining solutions and timelines
- Reflect service attitude and sense of responsibility, extremely concise

2. ã€Contact Instructionsã€‘- Generate action instructions for internal departments
- Specify responsible departments: ${(d[t]||d.retail).departments.join(", ")}
- Specific action steps and deadlines, follow-up points and reporting requirements, instructions should be concise and clear

Output Format:
ã€Customer Replyã€‘
[Customer reply content here]

ã€Contact Instructionsã€‘
[Internal contact instructions here]

ã€Mandatory Requirementsã€‘Strictly base on the provided suggestion content, do not add information not mentioned in the conversation, no word count, extremely concise, get straight to the point.`,y=`Customer Service Suggestion Content:
${s}

Please generate standard customer replies and internal contact instructions based on the above suggestions.${c}`,v=[{role:"system",content:x},{role:"user",content:y}];console.log("Sending contact instruction generation request to LLM...");const b=await X(v,.7,2048,null,{enableThinking:!1,stream:!1});console.log("LLM contact instruction response:",je(b));const k=b.match(/ã€Customer Replyã€‘\s*\n([\s\S]*?)(?=\nã€Contact Instructionsã€‘|$)/),C=b.match(/ã€Contact Instructionsã€‘\s*\n([\s\S]*?)$/),j=k?k[1].trim():"Sorry, there was an issue generating the customer reply. Please handle manually.",M=C?C[1].trim():"Please have relevant departments follow up on customer issues.",F=[{name:"Customer Reply Generation",content:j},{name:"Contact Instruction Generation",content:M}];return console.groupCollapsed("[LLM] Parsed -> generate_department_contact"),console.log("customerReply:",je(j)),console.log("contactInstruction:",je(M)),console.groupEnd(),{steps:F,customerReply:j,contactInstruction:M,structuredOutput:{customerReply:j,contactInstruction:M}}}catch(c){throw console.error("Error generating department contact instructions:",c),c}},Gt=async(s,t,l=[],m=[])=>{try{console.log(`
=== Starting department contact instruction generation (contact only) ===`),console.log("Suggestion content:",s),console.log("Scenario:",t);const c=Me(l,m),d={retail:{systemRole:"You are a professional retail customer service supervisor responsible for coordinating various departments to handle customer issues.",context:"Generate internal contact instructions based on current customer issues or needs.",departments:["Order Department","Logistics Department","After-sales Department","Technical Department","Finance Department"]},finance:{systemRole:"You are a professional financial customer service supervisor responsible for coordinating various departments to handle customer business.",context:"Generate internal contact instructions based on current customer issues or needs.",departments:["Business Department","Risk Control Department","Technical Department","Compliance Department","Operations Department"]},logistics:{systemRole:"You are a professional logistics customer service supervisor responsible for coordinating various departments to handle customer issues.",context:"Generate internal contact instructions based on current customer issues or needs.",departments:["Transportation Department","Warehousing Department","Customer Service Department","Technical Department","Settlement Department"]}},x=`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specifically designed to optimize enterprise internal coordination efficiency, helping customer service quickly generate standardized internal contact instructions to ensure smooth departmental collaboration.

ã€Function Descriptionã€‘After customer service analyzed the current situation, they clicked the "Generate Internal Instructions" button. The specialized function of this button is: based on the current customer situation and problem nature, generate detailed internal contact instructions for customer service, clarifying departmental responsibilities and action steps.

ã€Generation Instructionsã€‘Please generate detailed internal action instructions based on professional internal contact instruction generation requirements:
- Specify responsible departments: ${(d[t]||d.retail).departments.join(", ")}
- Specific action steps and deadlines, follow-up points and reporting requirements
- 80-150 word instructions should be detailed and clear

Output Format:
ã€Contact Instructionsã€‘
[Internal contact instructions here]

ã€Importantã€‘Strictly base on the provided content, do not add information not mentioned in the conversation, ensure all information has clear source basis.`,y=`Current Situation:
${s}

Please generate internal contact instructions based on the above situation.${c}`,v=[{role:"system",content:x},{role:"user",content:y}];console.log("Sending contact instruction generation request to LLM...");const b=await X(v,.7,2048);console.log("LLM contact instruction response:",je(b));const k=b.match(/ã€Contact Instructionsã€‘\s*\n([\s\S]*?)$/),C=k?k[1].trim():"Please have relevant departments follow up on the current situation.",j=[{name:"Contact Instruction Generation",content:C}];return console.groupCollapsed("[LLM] Parsed -> generate_department_contact_only"),console.log("contactInstruction:",je(C)),console.groupEnd(),{steps:j,contactInstruction:C,structuredOutput:{contactInstruction:C}}}catch(c){throw console.error("Error generating department contact instructions:",c),c}},Ht=async(s,t,l,m=[],c=null,d=[])=>{try{const u={retail:{systemRole:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specialized in requirements analysis, capable of quickly completing requirements understanding, information translation and suggestion generation.

ã€Function Descriptionã€‘The system activated the "Comprehensive Intelligent Analysis" function button. The purpose of this button is: to intelligently analyze customer input, complete requirements understanding, professional translation, missing information identification and AI suggestion generation, providing practical suggestions for customer service.

ã€Generation Instructionsã€‘Please conduct retail scenario analysis based on comprehensive intelligent analysis professional requirements.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,instruction:`You need to quickly complete the following tasks:

1. Requirements Understanding: Identify customer core needs
2. Requirements Translation: Transform into customer service expressions
3. Missing Information Identification: Identify key information points
4. AI Suggestion Generation: Provide sales suggestions

Requirements:
- Suggestions should be practical and feasible
- Information options should be specific (e.g.: budget, size, material, etc.)
- Based on retail industry characteristics, include scripts
- When information is insufficient, specify key information that needs to be understood`},enterprise:{systemRole:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specialized in enterprise requirements analysis, capable of quickly completing business requirements analysis and solution suggestion generation.

ã€Function Descriptionã€‘The system activated the "Enterprise Comprehensive Analysis" function button. The function of this button is: to intelligently analyze enterprise business requirements, complete requirements understanding, professional translation, key information identification and solution suggestion generation.

ã€Generation Instructionsã€‘Please conduct enterprise scenario analysis based on enterprise comprehensive analysis professional requirements.

**âš¡ Important: Responses must be concise and to the point, avoiding lengthy expressions and unnecessary details. No over-reasoning - provide practical answers directly.**`,instruction:`You need to quickly complete the following tasks:

1. Requirements Understanding: Identify core business needs
2. Requirements Translation: Transform into enterprise service expressions
3. Missing Information Identification: Identify key information points
4. AI Suggestion Generation: Provide enterprise solutions

Requirements:
- Suggestions should be practical and feasible
- Information options should be specific (e.g.: budget scale, time requirements, technology stack, etc.)
- Based on enterprise service characteristics, include implementation plans
- When information is insufficient, specify key information that needs to be understood`}},x=u[l||"retail"]||u.retail,y=Me(m,d),v=[{role:"system",content:`${x.systemRole}

${x.instruction}

ã€Importantã€‘Input content filtering and intelligent processing rules:
1. Inappropriate language handling: If user input contains profanity, vulgarity, or aggressive words, do not repeat this content, but:
   - Identify as "user emotional expression" or "test input"
   - Understand possible real intentions (such as expressing dissatisfaction, seeking help, random testing, etc.)
   - Respond in a professional and friendly manner

2. Meaningless input handling: If input is:
   - Random letter/number combinations (like "cnm", "123", "aaa")
   - Single words without clear requirement meaning
   - Obviously test inputs
   Identify as "users needing guidance", suggest providing real requirements

3. Negative emotion recognition: If input expresses dissatisfaction or negative emotions, transform into opportunities to understand problems and provide help

Please output in the following format:

ã€REQUIREMENTS UNDERSTANDINGã€‘
Briefly summarize the user's core requirements (no more than 30 words)
- For valid requirements: normal summary
- For inappropriate input: state "user test input" or "user emotional expression"
- For meaningless input: state "input content unclear, needs guidance"

ã€REQUIREMENTS TRANSLATIONã€‘
Transform into professional description:
- For valid requirements: normal translation
- For inappropriate input: translate to "customer may be testing system or expressing emotions, suggest friendly guidance to provide specific requirements"
- For meaningless input: translate to "customer input is unclear, suggest actively asking what help can be provided"

ã€INFORMATION OPTIONSã€‘
Generate options for specific requirements, format: option name|inquiry reason
- For valid requirements: normally generate 3-5 options
- For invalid input: return "no need to collect additional information"

ã€AI Suggestionsã€‘
Provide professional suggestions based on analysis results (limited to 100 words):
- For valid requirements: provide specific product recommendations, script suggestions, handling solutions
- For inappropriate input: suggest customer service provide friendly guidance to understand customer real needs
- For meaningless input: suggest actively asking customers what help they need

ã€AI Guidanceã€‘
Provide specific operational guidance for customer service (limited to 80 words):
- Include specific communication scripts
- Clarify next step operation suggestions
- Precautions or skill tips`},{role:"user",content:`User input: "${s}"${t?`
(User also uploaded an image)`:""}${y}`}],b=await X(v,.7,3072,c,{enableThinking:!0,stream:!0}),k=(b||"").match(/ã€REQUIREMENTS UNDERSTANDINGã€‘\s*\n([\s\S]*?)(?=\nã€|$)/),C=(b||"").match(/ã€REQUIREMENTS TRANSLATIONã€‘\s*\n([\s\S]*?)(?=\nã€|$)/),j=(b||"").match(/ã€INFORMATION OPTIONSã€‘\s*\n([\s\S]*?)(?=\nã€|$)/),M=(b||"").match(/ã€AI Suggestionsã€‘\s*\n([\s\S]*?)(?=\nã€|$)/),F=(b||"").match(/ã€AI Guidanceã€‘\s*\n([\s\S]*?)(?=\nã€|$)/),D=k?k[1].trim():"Requirements Analysis",q=C?C[1].trim():`Customer inquiry: ${s}, suggest understanding customer specific needs to provide precise ${l||"retail"} service solutions.`,O=j?j[1].trim():"",U=M?M[1].trim():"Analyzing your requirements and generating suggestions...",J=F?F[1].trim():"Suggest actively understanding customer specific needs, providing targeted service.",E=[];if(O&&O!=="no need to collect additional information"){const K=O.split(`
`).filter(ce=>ce.trim());for(const ce of K){const P=ce.match(/^[â€¢\-\*]?\s*([^|]{2,8})\|(.+)$/);P&&E.push({name:P[1].trim(),description:P[2].trim(),selected:!1})}}return console.log("[LLM] Comprehensive intelligent analysis results:",{needsUnderstanding:D,translation:q,missingInfoOptions:E,suggestion:U,aiAdvice:J}),{needsUnderstanding:D,translation:q,missingInfoOptions:E,suggestion:U,aiAdvice:J,structuredOutput:{needsUnderstanding:D,translation:q,missingInfoOptions:E,suggestion:U,aiAdvice:J}}}catch(u){throw console.error("Comprehensive intelligent analysis error:",u),u}},Bt=async(s,t,l=[],m=[])=>{try{console.log(`
=== Starting department contact suggestion generation ===`),console.log("Conversation content:",s),console.log("Scenario:",t);const c=_n(l,"Department Contact Suggestion Context",4),d={retail:{systemRole:"You are a professional retail business supervisor, familiar with departmental divisions and responsibilities.",context:"Based on current conversation, analyze customer needs and recommend appropriate department contact plans.",departments:["Customer Service Department - Handle general customer inquiries and complaints","Sales Department - Product recommendations, price inquiries, promotional activities","Technical Support - Product usage issues, troubleshooting","After-sales Service - Returns/exchanges, repairs, warranty","Management - Important customers, complex issues, complaint escalation"]},enterprise:{systemRole:"You are an enterprise service expert, understanding interdepartmental collaboration relationships within enterprises.",context:"Based on cross-departmental communication needs, provide optimal department contact suggestions.",departments:["Marketing Department - Marketing strategies, brand promotion, market research","R&D Department - Technical development, product innovation, technical support","Operations Department - Business processes, operational analysis, efficiency optimization","Human Resources - Personnel allocation, training needs, team coordination","Management - Strategic decisions, resource allocation, major issues"]},education:{systemRole:"You are an educational management expert, familiar with the organizational structure of educational institutions.",context:"Based on student or teacher needs, recommend appropriate departments or personnel.",departments:["Academic Affairs Office - Course scheduling, student records management, examination affairs","Student Affairs Office - Student life, psychological counseling, activity organization","Teaching Departments - Specific subjects, teaching methods, academic guidance","Technical Support - Equipment maintenance, system usage, technical training","School Leadership - Important decisions, policy consultation, major issues"]}},u=d[t]||d.retail,y=[{role:"user",content:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specialized in assisting customer service with departmental coordination, helping customer service quickly identify the most suitable departments to handle issues and formulate contact strategies.

ã€Function Descriptionã€‘Customer service encountered situations requiring cross-departmental collaboration and clicked the "Department Contact Suggestions" button. The function of this button is: based on current customer issues and conversation situations, intelligently analyze and recommend the most suitable contact departments, providing concise contact reasons and key points.

ã€Generation Instructionsã€‘Please analyze the current situation and recommend suitable departments based on professional department contact suggestion requirements: only recommend 1 most suitable contact department, extremely concise, one sentence explanation of reason, one sentence explanation of key points, strictly prohibit word counting.

${u.systemRole}

${u.context}

Available Contact Departments:
${u.departments.map(k=>`â€¢ ${k}`).join(`
`)}

Conversation History:
${c}

Current Situation:
${s}

Please recommend in the following format:
**Suggested Contact: [Department Name]**
- Reason: [Brief explanation]
- Contact Key Points: [Key information, 1-2 sentences]`}],b=(await X(y,.7,2048,null,{enableThinking:!1,stream:!1})).trim();return console.log("âœ… Department contact suggestion generation completed"),b}catch(c){throw console.error("Error generating department contact suggestions:",c),c}},Wt=async(s,t,l=[],m=null,c=[])=>{try{console.log(`
=== Starting department contact suggestion and internal instruction generation ===`),console.log("Conversation content:",s),console.log("Scenario:",t);const d=Me(l,c),u={retail:{systemRole:"You are a professional retail customer service supervisor responsible for coordinating various departments to handle customer issues and formulating internal contact instructions.",context:"Based on current conversation, analyze situation and provide: 1) Recommended contact departments 2) Specific internal contact instructions",departments:["Customer Service Department - Handle general customer inquiries and complaints","Sales Department - Product recommendations, price inquiries, promotional activities","Technical Support - Product usage issues, troubleshooting","After-sales Service - Returns/exchanges, repairs, warranty","Finance Department - Refunds, accounting, price adjustments","Management - Important customers, complex issues, complaint escalation"]},enterprise:{systemRole:"You are an enterprise internal coordination expert responsible for cross-departmental communication coordination and internal instruction formulation.",context:"Based on inter-departmental communication needs, provide department contact plans and specific execution instructions.",departments:["Marketing Department - Marketing strategies, brand promotion, market research","R&D Department - Technical development, product innovation, technical support","Operations Department - Business processes, operational analysis, efficiency optimization","Human Resources - Personnel allocation, training needs, team coordination","Finance Department - Budget approval, cost control, financial analysis","Management - Strategic decisions, resource allocation, major issues"]},education:{systemRole:"You are an educational management coordinator, familiar with the organizational structure and coordination processes of educational institutions.",context:"Based on student or teacher needs, recommend appropriate department contacts and formulate handling instructions.",departments:["Academic Affairs Office - Course scheduling, student records management, examination affairs","Student Affairs Office - Student life, psychological counseling, activity organization","Teaching Departments - Specific subjects, teaching methods, academic guidance","Technical Support - Equipment maintenance, system usage, technical training","Administrative Department - Document processing, process approval, policy consultation","School Leadership - Important decisions, policy consultation, major issues"]}},x=u[t]||u.retail,v=[{role:"user",content:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specialized in assisting customer service with comprehensive departmental coordination, capable of both recommending suitable contact departments and generating detailed internal execution instructions.

ã€Function Descriptionã€‘Customer service faced complex situations requiring departmental collaboration and clicked the "Complete Contact Plan" button. The comprehensive function of this button is: not only analyze and recommend the most suitable contact departments, but also generate specific internal contact instructions and execution steps, providing complete coordination plans for customer service.

ã€Generation Instructionsã€‘Please provide comprehensive departmental coordination plans based on professional complete contact plan generation requirements: precisely recommend contact departments with explanations, formulate specific actionable internal instructions, including immediate action steps, contact key points and follow-up requirements, with total length controlled within 200 words.

${x.systemRole}

${x.context}

Available Contact Departments:
${x.departments.map(b=>`â€¢ ${b}`).join(`
`)}

Conversation History:
${d}

Current Situation Analysis:
${s}

Please provide complete plan in the following format:

## ðŸ“ž **Recommended Contact Departments**
**Primary Contact:** [Most suitable department name]
**Reason:** [Concise reason for choosing this department]

**Alternative Contact:** [Secondary department (if necessary)]
**Reason:** [Alternative reason]

## ðŸ“‹ **Internal Contact Instructions**
**Immediate Actions:**
1. [Specific operation step 1]
2. [Specific operation step 2]

**Contact Key Points:**
â€¢ [Key information 1 to explain to department]
â€¢ [Key information 2 to explain to department]

**Follow-up Requirements:**
â€¢ [Content requiring department feedback]
â€¢ [Expected response time]`}];if(m){console.log("ðŸ“¡ Using streaming mode to generate department contact suggestions and internal instructions");const b=await X(v,.7,2048,m,{enableThinking:!0,stream:!0});return console.log("âœ… Department contact suggestions and internal instructions generation completed (streaming)"),b.trim()}else{console.log("ðŸ“ Using non-streaming mode to generate department contact suggestions and internal instructions");const k=(await X(v,.7,2048,null,{enableThinking:!1,stream:!1})).trim();return console.log("âœ… Department contact suggestions and internal instructions generation completed (non-streaming)"),k}}catch(d){throw console.error("Error generating department contact suggestions and internal instructions:",d),d}},Yt=async(s,t,l=null)=>{try{console.log(`
=== Starting emergency situation handling ===`),console.log("Emergency level:",s.urgencyLevel),console.log("Situation description:",s.description);const m={urgent:{name:"Urgent",priority:"High priority handling, respond within 1 hour"},high:{name:"High",priority:"Important matter, handle within 4 hours"},critical:{name:"Critical",priority:"Immediate handling, simultaneously report to management"}},c=m[s.urgencyLevel]||m.urgent,d={retail:{systemRole:"You are an experienced retail crisis management expert.",context:"Facing urgent customer service situations, need to provide solutions quickly and professionally.",escalationProtocol:"Customer Service Supervisor â†’ Store Manager â†’ Regional Manager â†’ Headquarters"},enterprise:{systemRole:"You are an enterprise emergency affairs handling expert.",context:"Handle enterprise internal emergency affairs, ensure business continuity and risk control.",escalationProtocol:"Direct Supervisor â†’ Department Manager â†’ Senior Management â†’ CEO"},education:{systemRole:"You are an educational institution emergency affairs handling expert.",context:"Handle campus emergency situations, ensure faculty and student safety and teaching order.",escalationProtocol:"Class Teacher â†’ Grade Director â†’ Academic Affairs Director â†’ Principal"}},u=d[t]||d.retail;let x="";if(s.context&&s.context.recentMessages){const C=s.context.recentMessages.map(j=>j.text||j.output||"").filter(j=>j.trim()).join(`
`);C&&(x=`
Relevant conversation background:
${C}
`)}const v=[{role:"user",content:`ã€Platform Introductionã€‘You are working for the ZeroTouch Intelligent Communication Mediation Platform, which is an AI system specialized in handling emergency affairs, providing rapid and professional emergency handling guidance for customer service in crisis situations.

ã€Function Descriptionã€‘The system detected an emergency situation and activated the "Emergency Handling" function button. The key role of this button is: based on the level and description of emergency events, quickly generate emergency handling plans for customer service, including immediate action steps, contact personnel and time requirements, ensuring crises are handled promptly.

ã€Generation Instructionsã€‘Please generate emergency handling plans based on professional emergency handling requirements: provide concise and practical emergency handling plans, highlighting actionable steps.

**âš¡ Mandatory Requirements: Answers must be extremely concise, get straight to the core, maximum 3 steps, strictly prohibit lengthy expressions, explanations, background descriptions, word counting and any unnecessary content. Only state key actions!**

${u.systemRole}

Emergency Situation: ${s.description}
Level: ${c.name} (${c.priority})${x}

Please provide handling plan in the following format:

**Immediate Actions:**
1. [Priority step 1]
2. [Priority step 2]

**Contact Personnel:** [Key contacts/departments]

${s.urgencyLevel==="critical"?"**Management Report:** [Key points]":"**Estimated Time:** [Processing duration]"}`}],k=(await X(v,.7,2048,l,{enableThinking:!0,stream:!0})).trim();return console.log("âœ… Emergency handling plan generation completed"),k}catch(m){throw console.error("Error handling emergency situation:",m),m}},Wn=Object.freeze(Object.defineProperty({__proto__:null,analyzeContext:On,callModelScopeAPI:X,chatWithAI:Lt,comprehensiveAnalysisWithSuggestion:Ht,conceptualize:Ln,detectMissingInfo:Fn,generateDepartmentContact:zt,generateDepartmentContactOnly:Gt,generateDepartmentContactWithInstructions:Wt,generateDepartmentSuggestion:Bt,generateEnterpriseFollowUp:Nt,generateEnterpriseSuggestion:Ft,handleEmergencyProcessing:Yt,negotiateSuggestion:Ut,optimizeForUser:zn,processWithLLM:re,translateToSolution:Un},Symbol.toStringTag,{value:"Module"})),Yn=s=>{const[t,l]=f.useState({problem:[],llm:[],solution:[]}),[m,c]=f.useState(!1),[d,u]=f.useState(null),[x,y]=f.useState(!1),[v,b]=f.useState(!1),[k,C]=f.useState(null),[j,M]=f.useState([]),[F,D]=f.useState(!1),[q,O]=f.useState(null),[U,J]=f.useState(null),[E,K]=f.useState([]),[ce,P]=f.useState("normal"),[z,Z]=f.useState(!1),[me,oe]=f.useState(!1),[we,ae]=f.useState(""),[ue,Q]=f.useState(""),[$e,H]=f.useState(!1),[ne,he]=f.useState(!1),[ee,ve]=f.useState(null),[ge,ze]=f.useState(null),[te,Ee]=f.useState(null),[qe,L]=f.useState(""),R=f.useRef(null),se=f.useRef(null),N={onStreamStart:(r,a)=>{if(console.log("ðŸš€ Hook: æµå¼å¼€å§‹å›žè°ƒè§¦å‘"),H(!0),he(!1),ae(""),Q(""),ve(r),ze(a),!(a!=null&&a.suppressMessageCreation)){const p=(a==null?void 0:a.messageType)||"ai_chat",h={type:p,text:"",timestamp:new Date().toISOString(),isStreaming:!0,streamId:`stream_${Date.now()}`,generatedInMode:(a==null?void 0:a.chatMode)||ce,...p==="emergency_response"&&{urgencyLevel:a==null?void 0:a.urgencyLevel,description:a==null?void 0:a.description,escalated:a==null?void 0:a.escalated},...p==="intelligent_followup_candidate"&&{selectedInfo:a==null?void 0:a.selectedInfo,feedbackGiven:!1,accepted:!1,negotiating:!1,negotiated:!1,id:Date.now()+Math.random()}};l(S=>{const o=p==="intelligent_followup_candidate"?S.solution.filter(i=>i.type!=="intelligent_followup_candidate"):S.solution;return{...S,solution:[...o,h]}}),Ee(h),R.current=h,L(""),se.current=h.streamId}},onThinking:(r,a)=>{console.log("ðŸ§  Hook: æ€è€ƒå†…å®¹æ›´æ–°",{fragment:r?r.substring(0,20)+"...":"ç©º",fullLength:a?a.length:0,isPaused:ne}),ne||ae(a)},onAnswering:(r,a)=>{if(!ne){Q(a);const p=se.current;p&&(L(a),l(h=>({...h,solution:h.solution.map(S=>S.streamId===p?{...S,text:a,answer:a,isStreaming:!0}:S)})))}},onStreamEnd:(r,a)=>{console.log("ðŸ Hook: æµå¼ç»“æŸå›žè°ƒè§¦å‘",{thinkingLength:r?r.length:0,answerLength:a?a.length:0}),H(!1),he(!1),ae(r),Q(a),ve(null),ze(null);const p=se.current;p&&(l(h=>({...h,solution:h.solution.map(S=>S.streamId===p?{...S,text:a||S.text,isStreaming:!1,answer:a||S.answer||S.text}:S)})),Ee(null),R.current=null,se.current=null,L(""))},onStreamPaused:()=>{he(!0)}},I=f.useCallback((r,a)=>{l(p=>({...p,[r]:[...p[r],a]}))},[]);f.useCallback(()=>{l({problem:[],llm:[],solution:[]}),b(!1),C(null),c(!1),u(null),K([]),P("normal"),Z(!1),oe(!1),ae(""),Q(""),H(!1),he(!1),ve(null),ze(null),Ee(null),L("")},[]);const fe=f.useCallback(()=>{ee&&ee.pause&&(ee.pause(),he(!0))},[ee]),_=f.useCallback(()=>{ee&&ee.resume&&(ee.resume(),he(!1))},[ee]),Ie=f.useCallback(async r=>{if(ge)try{ee&&ee.abort&&ee.abort(),console.log("ðŸ”„ åº”ç”¨ç”¨æˆ·è°ƒæ•´å»ºè®®:",r);const a={role:"user",content:`[ç”¨æˆ·å¹²é¢„è°ƒæ•´] ${r}

è¯·æ ¹æ®ä¸Šè¿°å»ºè®®é‡æ–°æ€è€ƒå¹¶è°ƒæ•´æ‚¨çš„æŽ¨ç†è¿‡ç¨‹ã€‚`},p={...ge,messages:[...ge.messages||[],a]},{processWithLLM:h}=await Pn(()=>Promise.resolve().then(()=>Wn),void 0,import.meta.url),S=await h({...p,streamCallbacks:N});ge.onComplete&&ge.onComplete(S)}catch(a){console.error("è°ƒæ•´AIæŽ¨ç†æ—¶å‡ºé”™:",a),H(!1),he(!1)}},[ge,ee,N]),xe=f.useCallback(r=>{const a={type:"ai_response",text:r.text,timestamp:r.timestamp,source:"customer_reply"};I("problem",a)},[I]),de=f.useCallback(async r=>{const a={type:"user",text:r.text,image:r.image,timestamp:r.timestamp};I("problem",a),u("problem"),c(!0);try{const p=[...t.problem.filter(g=>g.type==="user"||g.type==="ai_response").map(g=>({...g,panel:"problem"})),...t.solution.filter(g=>g.type==="llm_request"||g.type==="user"||g.type==="ai_response").map(g=>({...g,panel:"solution"})),a].sort((g,T)=>new Date(g.timestamp)-new Date(T.timestamp));let h=!1;const S={...N,onStreamStart:(g,T)=>{h=!0,N&&typeof N.onStreamStart=="function"&&N.onStreamStart(g,{...T,messageType:"comprehensive_analysis"})}},o=await re({type:"comprehensive_analysis_with_suggestion",content:r.text,image:r.image,context:"problem_to_solution",scenario:s,chatHistory:p,aiChatHistory:E,streamCallbacks:S});O({originalContent:r.text,image:r.image,chatHistory:p}),M(o.missingInfoOptions||[]);const i={type:"processing",title:"Comprehensive analysis",steps:[{name:"Needs understanding",content:o.needsUnderstanding},{name:"Needs translation",content:o.translation},{name:"AI suggestion",content:o.suggestion||"æ­£åœ¨ç”Ÿæˆä¸“ä¸šå»ºè®®..."},{name:"Missing info analysis",content:o.missingInfoOptions&&o.missingInfoOptions.length>0?`Detected ${o.missingInfoOptions.length} info points to collect`:"Information is sufficient; no extra info needed"}],output:o.suggestion||o.translation,timestamp:new Date().toISOString()};if(I("llm",i),h)l(g=>{const T=[...g.solution];for(let ie=T.length-1;ie>=0;ie--){const st=T[ie];if(st&&st.type==="comprehensive_analysis"&&st.streamId){T[ie]={...st,text:o.needsUnderstanding,translation:o.translation,suggestion:o.suggestion,aiAdvice:o.aiAdvice,missingInfoOptions:o.missingInfoOptions||[],isStreaming:!1};break}}return{...g,solution:T}});else{const g={type:"comprehensive_analysis",text:o.needsUnderstanding,timestamp:new Date().toISOString(),missingInfoOptions:o.missingInfoOptions||[],translation:o.translation,suggestion:o.suggestion,aiAdvice:o.aiAdvice};I("solution",g)}const w={type:"llm_request",text:o.translation,timestamp:new Date().toISOString(),needsAnalysis:o.needsUnderstanding,missingInfoOptions:o.missingInfoOptions||[]};I("solution",w),o.missingInfoOptions&&o.missingInfoOptions.length>0&&D(!0)}catch(p){console.error("LLMå¤„ç†é”™è¯¯:",p);const h={type:"processing",title:"Processing error",steps:[{name:"Error",content:"Sorry, something went wrong. Please try again later."}],timestamp:new Date().toISOString()};I("llm",h)}finally{c(!1),u(null)}},[I,s,t.problem,t.solution]),Te=f.useCallback(async r=>{const a={type:"user",text:r.text,timestamp:r.timestamp};F&&(D(!1),M([]),O(null));const p=r.text.trim(),h=t.solution.find(i=>(i.type==="followup"||i.type==="intelligent_followup")&&i.negotiated&&i.text.trim()===p),S=t.solution.find(i=>(i.type==="followup"||i.type==="intelligent_followup")&&i.feedbackGiven&&i.accepted&&(i.text||"").trim()===p),o=t.solution.find(i=>i.type==="department_contact"&&i.customerReply&&i.customerReply.trim()===p);if(h||S){console.log("ðŸŽ¯ æ£€æµ‹åˆ°åå•†åŽçš„è¿½é—®ï¼Œç›´æŽ¥å‘é€ç»™ç”¨æˆ·ç«¯ï¼Œè·³è¿‡AIè½¬è¯‘å¤„ç†");const i={type:"ai_response",text:p,timestamp:new Date().toISOString(),isNegotiated:!!h};I("problem",i);const w={type:"processing",title:"è¿½é—®ç›´è¾¾ç”¨æˆ·ç«¯",steps:[{name:"å¤„ç†è¯´æ˜Ž",content:"å·²æŽ¥å—/åå•†å®Œæˆçš„è¿½é—®ç›´æŽ¥å‘é€ç»™ç”¨æˆ·ç«¯ï¼Œæ— éœ€AIäºŒæ¬¡è½¬è¯‘"}],output:p,timestamp:new Date().toISOString()};I("llm",w);return}if(o){console.log("ðŸŽ¯ æ£€æµ‹åˆ°å®¢æˆ·å›žå¤å†…å®¹ï¼Œç›´æŽ¥å‘é€ç»™ç”¨æˆ·ç«¯ï¼Œè·³è¿‡AIè½¬è¯‘å¤„ç†");const i={type:"ai_response",text:p,timestamp:new Date().toISOString(),isCustomerReply:!0};I("problem",i);const w={type:"processing",title:"å®¢æˆ·å›žå¤ç›´è¾¾ç”¨æˆ·ç«¯",steps:[{name:"å¤„ç†è¯´æ˜Ž",content:"ç”Ÿæˆçš„å®¢æˆ·å›žå¤ç›´æŽ¥å‘é€ç»™ç”¨æˆ·ç«¯ï¼Œæ— éœ€AIäºŒæ¬¡è½¬è¯‘"}],output:p,timestamp:new Date().toISOString()};I("llm",w);return}u("solution"),c(!0);try{const i=[...t.problem.filter(ie=>ie.type==="user"||ie.type==="ai_response").map(ie=>({...ie,panel:"problem"})),...t.solution.filter(ie=>ie.type==="llm_request"||ie.type==="user"||ie.type==="ai_response").map(ie=>({...ie,panel:"solution"})),a].sort((ie,st)=>new Date(ie.timestamp)-new Date(st.timestamp)),w=await re({type:"solution_response",content:r.text,context:"solution_to_problem",scenario:s,chatHistory:i,aiChatHistory:E,streamCallbacks:N}),g={type:"processing",title:"Optimize reply for customer",steps:w.steps,output:w.optimizedMessage,timestamp:new Date().toISOString()};I("llm",g);const T={type:"ai_response",text:w.optimizedMessage,timestamp:new Date().toISOString()};I("problem",T)}catch(i){console.error("LLMå¤„ç†é”™è¯¯:",i);const w={type:"processing",title:"Processing error",steps:[{name:"Error",content:"Sorry, something went wrong. Please try again later."}],timestamp:new Date().toISOString()};I("llm",w)}finally{c(!1),u(null)}},[I,s,t.problem,t.solution,F]),Pe=f.useCallback(async()=>{if(!x){y(!0);try{const a=[...t.problem.filter(i=>i.type==="user"||i.type==="ai_response").slice(-2),...t.solution.filter(i=>i.type==="user"||i.type==="ai_response").slice(-2)].sort((i,w)=>new Date(i.timestamp)-new Date(w.timestamp)).map(i=>i.text).join(`
`),p=[...t.problem.filter(i=>i.type==="user"||i.type==="ai_response").map(i=>({...i,panel:"problem"})),...t.solution.filter(i=>i.type==="llm_request"||i.type==="user"||i.type==="ai_response").map(i=>({...i,panel:"solution"}))].sort((i,w)=>new Date(i.timestamp)-new Date(w.timestamp)),h=await re({type:"generate_suggestion",content:a,scenario:s,chatHistory:p,aiChatHistory:E,streamCallbacks:N}),S={type:"processing",title:"Generate suggestion",steps:h.steps,output:h.suggestionMessage,structuredOutput:h.structuredOutput,timestamp:new Date().toISOString()};I("llm",S);const o={type:"suggestion",text:h.suggestionMessage,timestamp:new Date().toISOString(),id:`suggestion_${Date.now()}`,feedbackGiven:!1};I("solution",o),b(!0),C(h.suggestionMessage)}catch(r){console.error("ç”Ÿæˆå»ºè®®é”™è¯¯:",r);const a={type:"processing",title:"Suggestion error",steps:[{name:"Error",content:"Sorry, failed to generate suggestion. Please try again later."}],timestamp:new Date().toISOString()};I("llm",a)}finally{y(!1)}}},[I,s,t.problem,t.solution,x]),Ae=f.useCallback(async()=>{if(!x){y(!0);try{const a=[...t.problem.filter(i=>i.type==="user"||i.type==="ai_response").slice(-2),...t.solution.filter(i=>i.type==="user"||i.type==="ai_response").slice(-2)].sort((i,w)=>new Date(i.timestamp)-new Date(w.timestamp)).map(i=>i.text).join(`
`),p=[...t.problem.filter(i=>i.type==="user"||i.type==="ai_response").map(i=>({...i,panel:"problem"})),...t.solution.filter(i=>i.type==="llm_request"||i.type==="user"||i.type==="ai_response").map(i=>({...i,panel:"solution"}))].sort((i,w)=>new Date(i.timestamp)-new Date(w.timestamp)),h=await re({type:"generate_followup",content:a,scenario:s,chatHistory:p,aiChatHistory:E,streamCallbacks:N}),S={type:"processing",title:"Generate follow-up",steps:h.steps,output:h.followUpMessage,structuredOutput:h.structuredOutput,timestamp:new Date().toISOString()};I("llm",S);const o={type:"followup",text:h.followUpMessage,timestamp:new Date().toISOString(),id:`followup_${Date.now()}`,feedbackGiven:!1};I("solution",o),b(!0),C(h.followUpMessage)}catch(r){console.error("ç”Ÿæˆè¿½é—®é”™è¯¯:",r);const a={type:"processing",title:"Follow-up error",steps:[{name:"Error",content:"Sorry, failed to generate follow-up. Please try again later."}],timestamp:new Date().toISOString()};I("llm",a)}finally{y(!1)}}},[I,s,t.problem,t.solution,x]),le=f.useCallback(async r=>{if(m)return;const a={type:"user",text:r,timestamp:new Date().toISOString()};I("solution",a),u("solution"),c(!0);try{const p=[...t.problem.filter(i=>i.type==="user"||i.type==="ai_response").map(i=>({...i,panel:"problem"})),...t.solution.filter(i=>i.type==="llm_request"||i.type==="user"||i.type==="ai_response").map(i=>({...i,panel:"solution"})),a].sort((i,w)=>new Date(i.timestamp)-new Date(w.timestamp)),h=await re({type:"solution_response",content:r,context:"solution_to_problem",scenario:s,chatHistory:p,aiChatHistory:E,streamCallbacks:N}),S={type:"processing",title:"Process final response",steps:h.steps,output:h.optimizedMessage,timestamp:new Date().toISOString()};I("llm",S);const o={type:"ai_response",text:h.optimizedMessage,timestamp:new Date().toISOString()};I("problem",o),b(!1),C(null)}catch(p){console.error("ç¡®è®¤å‘é€é”™è¯¯:",p);const h={type:"processing",title:"Final response error",steps:[{name:"Error",content:"Sorry, failed to process final response. Please try again later."}],timestamp:new Date().toISOString()};I("llm",h)}finally{c(!1),u(null)}},[I,s,t.problem,t.solution,m]),Ce=f.useCallback(()=>{b(!1),C(null)},[]),pe=f.useCallback(r=>{M(a=>a.map((p,h)=>h===r?{...p,selected:!p.selected}:p))},[]),Oe=f.useCallback(async()=>{if(!q||x){console.log("âš ï¸ generateFollowUpBySelectedInfo: æ¡ä»¶ä¸æ»¡è¶³ï¼Œè·³è¿‡æ‰§è¡Œ",{hasCurrentNeedsAnalysis:!!q,iterationProcessing:x});return}const r=j.filter(a=>a.selected);if(r.length===0){console.log("âš ï¸ generateFollowUpBySelectedInfo: æ²¡æœ‰é€‰ä¸­çš„é€‰é¡¹ï¼Œè·³è¿‡æ‰§è¡Œ");return}console.log("ðŸ”„ å¼€å§‹ç”Ÿæˆæ™ºèƒ½è¿½é—®ï¼Œé€‰ä¸­é€‰é¡¹æ•°é‡:",r.length),y(!0),D(!1),l(a=>({...a,solution:a.solution.filter(p=>p.type!=="intelligent_followup_candidate")}));try{const a={...N,onStreamStart:(S,o)=>{N&&N.onStreamStart&&N.onStreamStart(S,{...o,messageType:"intelligent_followup_candidate",selectedInfo:r})}},p=await re({type:"generate_questions_by_selected_info",content:{originalContent:q.originalContent,selectedInfoItems:r},scenario:s,chatHistory:q.chatHistory,aiChatHistory:E,streamCallbacks:a});typeof p=="string"&&p.trim()&&l(S=>{const o=[...S.solution];for(let i=o.length-1;i>=0;i--){const w=o[i];if(w&&w.type==="intelligent_followup_candidate"){o[i]={...w,text:p.trim(),isStreaming:!1};break}}return{...S,solution:o}});const h={type:"processing",title:"ç”Ÿæˆæ™ºèƒ½è¿½é—®",steps:[{name:"é€‰ä¸­ä¿¡æ¯",content:r.map(S=>`${S.name}ï¼š${S.description}`).join(`
`)},{name:"ç”Ÿæˆè¿½é—®",content:p}],output:p,timestamp:new Date().toISOString()};I("llm",h),console.log("âœ… æ™ºèƒ½è¿½é—®ç”Ÿæˆå®Œæˆ")}catch(a){console.error("ç”Ÿæˆè¿½é—®é”™è¯¯:",a);const p={type:"processing",title:"ç”Ÿæˆè¿½é—®å‡ºé”™",steps:[{name:"é”™è¯¯ä¿¡æ¯",content:"æŠ±æ­‰ï¼Œç”Ÿæˆè¿½é—®æ—¶å‡ºçŽ°äº†é”™è¯¯ï¼Œè¯·ç¨åŽé‡è¯•ã€‚"}],timestamp:new Date().toISOString()};I("llm",p),D(!0)}finally{y(!1)}},[q,j,s,x,I,F]),Le=f.useCallback(()=>{D(!1),M([]),O(null)},[]),$=f.useCallback(async()=>{if(m||x){console.log("âš ï¸ generateSimpleIntelligentFollowUp: System is processing, skipping execution");return}if(F){console.log("âš ï¸ generateSimpleIntelligentFollowUp: ä¿¡æ¯é€‰æ‹©é¢æ¿å·²æ˜¾ç¤ºï¼Œè·³è¿‡ç®€å•è¿½é—®ç”Ÿæˆ");return}console.log("ðŸ”„ å¼€å§‹ç”Ÿæˆç®€å•æ™ºèƒ½è¿½é—®"),y(!0);try{const r=t.problem.slice(-3),a=t.solution.slice(-3),p=[...r,...a].sort((o,i)=>new Date(o.timestamp)-new Date(i.timestamp)).map(o=>o.text||o.output).join(`
`);if(!p.trim()){console.log("æ²¡æœ‰è¶³å¤Ÿçš„å¯¹è¯å†…å®¹ç”Ÿæˆæ™ºèƒ½è¿½é—®"),y(!1);return}const h=await re({type:"generate_simple_followup",content:p,scenario:s,chatHistory:[...r,...a],aiChatHistory:E,streamCallbacks:null}),S={type:"processing",title:"ç”Ÿæˆæ™ºèƒ½è¿½é—®",steps:h.steps,output:h.followUpMessage,timestamp:new Date().toISOString()};I("llm",S),console.log("âœ… æ™ºèƒ½è¿½é—®ç”Ÿæˆå®Œæˆ:",h.followUpMessage)}catch(r){console.error("ç”Ÿæˆæ™ºèƒ½è¿½é—®é”™è¯¯:",r)}finally{y(!1)}},[m,x,t.problem,t.solution,s,I,F]),Y=f.useCallback(async()=>{if(!(m||x)){y(!0);try{const r=t.problem.filter(i=>i.type==="user").slice(-2);if(r.length===0){console.log("æ²¡æœ‰ç”¨æˆ·è¾“å…¥å†…å®¹è¿›è¡Œéœ€æ±‚åˆ†æž"),y(!1);return}const a=r[r.length-1],p=[...t.problem.slice(-3),...t.solution.slice(-3)].sort((i,w)=>new Date(i.timestamp)-new Date(w.timestamp)),h=await re({type:"analyze_needs_with_missing_info",content:a.text,image:a.image,scenario:s,chatHistory:p,aiChatHistory:E,streamCallbacks:N}),S={type:"processing",title:"æ™ºèƒ½éœ€æ±‚åˆ†æž",steps:[{name:"éœ€æ±‚ç†è§£",content:h.needsUnderstanding},{name:"ä¿¡æ¯é€‰é¡¹",content:h.missingInfoOptions.map(i=>`${i.name}ï¼š${i.description}`).join(`
`)},{name:"éœ€æ±‚è½¬è¯‘",content:h.translation}],output:h.needsUnderstanding,timestamp:new Date().toISOString(),structuredOutput:h.structuredOutput};I("llm",S);const o={type:"needs_analysis",text:h.needsUnderstanding,timestamp:new Date().toISOString(),missingInfoOptions:h.missingInfoOptions||[],translation:h.translation};I("solution",o),M(h.missingInfoOptions||[]),h.missingInfoOptions&&h.missingInfoOptions.length>0&&D(!0),console.log("âœ… æ™ºèƒ½éœ€æ±‚åˆ†æžå®Œæˆ:",h)}catch(r){console.error("æ™ºèƒ½éœ€æ±‚åˆ†æžé”™è¯¯:",r)}finally{y(!1)}}},[m,x,t.problem,t.solution,s,I]),A=f.useCallback(r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r?{...p,feedbackGiven:!0,accepted:!0}:p)}))},[]),G=f.useCallback(r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r?{...p,negotiating:!0}:p)}))},[]),V=f.useCallback(r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r?{...p,negotiating:!1}:p)}))},[]),ye=f.useCallback(async(r,a,p)=>{if(a.trim()){console.log("ðŸ”„ å¼€å§‹å¤„ç†å»ºè®®åå•†è¯·æ±‚:",{suggestionId:r,negotiationText:a});try{let h;if(r.includes("_suggestion")){const i=parseInt(r.split("_")[0]);h=t.llm[i]}else h=t.solution.find(i=>i.id===r);if(!h){console.error("âŒ æœªæ‰¾åˆ°åŽŸå§‹å»ºè®®",{suggestionId:r,messagesLlmLength:t.llm.length,messagesSolutionLength:t.solution.length});return}console.log("âœ… æ‰¾åˆ°åŽŸå§‹å»ºè®®:",{suggestionId:r,originalSuggestionText:h.text||h.output});const S=[...t.problem.filter(i=>i.type==="user"||i.type==="ai_response").map(i=>({...i,panel:"problem"})),...t.solution.filter(i=>i.type==="llm_request"||i.type==="user"||i.type==="ai_response").map(i=>({...i,panel:"solution"}))].sort((i,w)=>new Date(i.timestamp)-new Date(w.timestamp)),o=await re({type:"negotiate_suggestion",content:{originalSuggestion:h.text||h.output,negotiationRequest:a,negotiationHistory:h.negotiationHistory||[]},scenario:s,chatHistory:S,aiChatHistory:E,streamCallbacks:N});p&&typeof p=="function"?(console.log("ðŸ”„ è°ƒç”¨å›žè°ƒå‡½æ•°æ›´æ–°å»ºè®®å†…å®¹:",o.suggestionMessage),p(o.suggestionMessage)):console.warn("âš ï¸ æœªæä¾›å›žè°ƒå‡½æ•°æˆ–å›žè°ƒå‡½æ•°æ— æ•ˆ"),console.log("âœ… å»ºè®®åå•†å¤„ç†å®Œæˆ"),l(i=>({...i,solution:i.solution.map(w=>{var g;return w.id===r?{...w,text:o.suggestionMessage,negotiating:!1,negotiated:!0,negotiationHistory:[...w.negotiationHistory||[],{previousText:((g=w.negotiationHistory)==null?void 0:g.length)>0?w.text:w.originalText||w.text,negotiationRequest:a,timestamp:new Date().toISOString()}],originalText:w.originalText||h.text}:w})}))}catch(h){console.error("åå•†å»ºè®®é”™è¯¯:",h),V(r)}}},[t.problem,t.solution,s,I,V]),Ve=f.useCallback(async r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r?{...p,feedbackGiven:!0,accepted:!1}:p)})),await Pe()},[Pe]),Ge=f.useCallback((r,a)=>{const p=t.solution.find(h=>h.id===r);p&&(l(h=>({...h,solution:h.solution.map(S=>S.id===r?{...S,feedbackGiven:!0,accepted:!0}:S)})),a&&typeof a=="function"&&a(p.text),J({type:"followup",sourceMessageId:r,sourceText:p.text,createdAt:new Date().toISOString()}))},[t.solution]),_e=f.useCallback(r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r?{...p,negotiating:!0}:p)}))},[]),He=f.useCallback(r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r?{...p,negotiating:!1}:p)}))},[]),ot=f.useCallback(async(r,a,p)=>{if(a.trim()){console.log("ðŸ”„ å¼€å§‹å¤„ç†è¿½é—®åå•†è¯·æ±‚:",{followUpId:r,negotiationText:a});try{let h;if(r.includes("_followup")){const i=parseInt(r.split("_")[0]);h=t.llm[i]}else h=t.solution.find(i=>i.id===r);if(!h){console.error("æœªæ‰¾åˆ°åŽŸå§‹è¿½é—®ï¼ŒfollowUpId:",r);return}const S=[...t.problem.filter(i=>i.type==="user"||i.type==="ai_response").map(i=>({...i,panel:"problem"})),...t.solution.filter(i=>i.type==="llm_request"||i.type==="user"||i.type==="ai_response").map(i=>({...i,panel:"solution"}))].sort((i,w)=>new Date(i.timestamp)-new Date(w.timestamp)),o=await re({type:"negotiate_followup",content:{originalFollowUp:h.text||h.output,negotiationRequest:a,negotiationHistory:h.negotiationHistory||[]},scenario:s,chatHistory:S,aiChatHistory:E,streamCallbacks:N});p&&typeof p=="function"&&p(o.followUpMessage),l(i=>({...i,solution:i.solution.map(w=>{var g;return w.id===r?{...w,text:o.followUpMessage,negotiating:!1,negotiated:!0,negotiationHistory:[...w.negotiationHistory||[],{previousText:((g=w.negotiationHistory)==null?void 0:g.length)>0?w.text:w.originalText||w.text,negotiationRequest:a,timestamp:new Date().toISOString()}],originalText:w.originalText||h.text}:w})})),onSetInput&&typeof onSetInput=="function"&&onSetInput(o.followUpMessage)}catch(h){console.error("åå•†è¿½é—®é”™è¯¯:",h),He(r)}}},[t.problem,t.solution,s,I,He]),n=f.useCallback(async r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r?{...p,feedbackGiven:!0,accepted:!1}:p)})),await Ae()},[Ae]),be=f.useCallback((r,a)=>{const p=t.solution.find(h=>h.id===r);p&&(l(h=>({...h,solution:h.solution.map(S=>S.id===r?{...S,feedbackGiven:!0,accepted:!0}:S)})),a&&typeof a=="function"&&a(p.text),J({type:"intelligent_followup",sourceMessageId:r,sourceText:p.text,createdAt:new Date().toISOString()}))},[t.solution]),Fe=f.useCallback(r=>{if(!r||!r.trim())return;const a={type:"ai_response",text:r.trim(),timestamp:new Date().toISOString(),isDirectFollowUp:!0,candidateType:U==null?void 0:U.type};I("problem",a);const p={type:"processing",title:"è¿½é—®ç›´è¾¾ç”¨æˆ·ç«¯",steps:[{name:"å¤„ç†è¯´æ˜Ž",content:"å·²ç¡®è®¤ç›´å‘ï¼Œè·³è¿‡AIè½¬è¯‘"}],output:r.trim(),timestamp:new Date().toISOString()};I("llm",p),J(null)},[I,U]),Be=f.useCallback(()=>{J(null)},[]),Ze=f.useCallback(r=>{!r||!r.sourceText||J({type:r.type||"customer_reply",sourceMessageId:r.sourceMessageId,sourceText:r.sourceText,createdAt:new Date().toISOString()})},[]),Je=f.useCallback(async r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r?{...p,feedbackGiven:!0,accepted:!1}:p)})),D(!0)},[]),Qe=f.useCallback(r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r?{...p,negotiating:!0}:p)}))},[]),We=f.useCallback(r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r?{...p,negotiating:!1}:p)}))},[]),Ue=f.useCallback(async(r,a,p)=>{if(a.trim())try{const h=t.solution.find(w=>w.id===r);if(!h)return;const S=[...t.problem.filter(w=>w.type==="user"||w.type==="ai_response").map(w=>({...w,panel:"problem"})),...t.solution.filter(w=>w.type==="llm_request"||w.type==="user"||w.type==="ai_response").map(w=>({...w,panel:"solution"}))].sort((w,g)=>new Date(w.timestamp)-new Date(g.timestamp)),o=await re({type:"negotiate_followup",content:{originalFollowUp:h.text||h.output,negotiationRequest:a,negotiationHistory:h.negotiationHistory||[]},scenario:s,chatHistory:S,aiChatHistory:E,streamCallbacks:N}),i={type:"processing",title:"åå•†ä¿®æ”¹æ™ºèƒ½è¿½é—®",steps:o.steps,output:o.followUpMessage,timestamp:new Date().toISOString()};I("llm",i),l(w=>({...w,solution:w.solution.map(g=>{var T;return g.id===r?{...g,text:o.followUpMessage,negotiating:!1,negotiated:!0,negotiationHistory:[...g.negotiationHistory||[],{previousText:((T=g.negotiationHistory)==null?void 0:T.length)>0?g.text:g.originalText||g.text,negotiationRequest:a,timestamp:new Date().toISOString()}],originalText:g.originalText||h.text}:g})})),p&&typeof p=="function"&&p(o.followUpMessage)}catch(h){console.error("åå•†æ™ºèƒ½è¿½é—®é”™è¯¯:",h),We(r)}},[t.problem,t.solution,s,I,We]),Xe=f.useCallback(async r=>{console.log("ðŸ¤– å¼€å§‹AIåä½œå¯¹è¯:",{question:r,previousChatHistory:E.length});try{const a={role:"user",content:r,timestamp:new Date().toISOString()},p={type:"user",text:r,timestamp:new Date().toISOString(),generatedInMode:ce};I("solution",p);const h=[...E,a],S={aiChatHistory:h.map(g=>({role:g.role,content:g.content,timestamp:g.timestamp})),customerMessages:t.problem.map(g=>({type:g.type,content:g.text||g.content||"",timestamp:g.timestamp,role:g.type==="user"?"customer":"system",panel:"problem"})),solutionMessages:t.solution.map(g=>({type:g.type,content:g.text||g.content||"",timestamp:g.timestamp,panel:"solution"})),llmMessages:t.llm?t.llm.map(g=>({type:g.type,content:g.output||g.text||g.content||"",timestamp:g.timestamp,panel:"llm"})):[],scenario:{name:(s==null?void 0:s.name)||"retail",problemRole:(s==null?void 0:s.problemRole)||"å®¢æˆ·",solutionRole:(s==null?void 0:s.solutionRole)||"å®¢æœä»£è¡¨"},chatMode:ce};console.log("ðŸ“‹ å®Œæ•´å¯¹è¯ä¸Šä¸‹æ–‡:",{aiChatHistoryLength:S.aiChatHistory.length,customerMessagesLength:S.customerMessages.length,solutionMessagesLength:S.solutionMessages.length,llmMessagesLength:S.llmMessages.length,scenario:S.scenario});const o={...S,messageType:"ai_chat",question:r},i=await re({type:"ai_chat",content:r,scenario:s,chatHistory:S,aiChatHistory:h,currentContext:S,streamCallbacks:{...N,onStreamStart:(g,T)=>{N.onStreamStart(g,{...T,messageType:"ai_chat",question:r,chatMode:ce})}}}),w={role:"assistant",content:i.answer,timestamp:new Date().toISOString()};K(g=>[...g,a,w]),l(g=>({...g,solution:g.solution.map(T=>T.isStreaming&&T.streamId===(te==null?void 0:te.streamId)?{...T,type:"ai_chat",question:r,answer:i.answer,text:i.answer,error:i.error,conversationId:Date.now(),isStreaming:!1}:T)})),console.log("âœ… AIåä½œå¯¹è¯å®Œæˆ:",{answer:i.answer,chatHistoryLength:h.length+1})}catch(a){console.error("âŒ AIåä½œå¯¹è¯å¤±è´¥:",a),te&&l(h=>({...h,solution:h.solution.map(S=>S.streamId===te.streamId?{...S,type:"ai_chat",question:r,answer:"AIåä½œåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œå»ºè®®ç¨åŽå†æ¬¡å°è¯•ã€‚æˆ‘å·²è®°ä½æœ¬æ¬¡å¯¹è¯ï¼Œæ‚¨å¯ä»¥ç¨åŽç»§ç»­",text:"AIåä½œåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œå»ºè®®ç¨åŽå†æ¬¡å°è¯•ã€‚æˆ‘å·²è®°ä½æœ¬æ¬¡å¯¹è¯ï¼Œæ‚¨å¯ä»¥ç¨åŽç»§ç»­",error:!0,isStreaming:!1}:S)}));const p={role:"user",content:r,timestamp:new Date().toISOString()};K(h=>[...h,p])}},[I,s,E,t.problem,ce,N]),et=f.useCallback(()=>{K([]),console.log("ðŸ—‘ï¸ AIåä½œå¯¹è¯åŽ†å²å·²æ¸…ç©º")},[]),tt=f.useCallback(async r=>{console.log("ðŸ” useMessageFlow - generateCustomerReplyForMessage è¢«è°ƒç”¨"),console.log("ðŸ” æŽ¥æ”¶åˆ°çš„æ¶ˆæ¯å‚æ•°:",r);try{const a=((r==null?void 0:r.translation)||(r==null?void 0:r.suggestion)||(r==null?void 0:r.aiAdvice)||(r==null?void 0:r.answer)||(r==null?void 0:r.text)||"").toString();if(console.log("ðŸ” å®¢æˆ·å›žå¤ç”Ÿæˆè°ƒè¯•:",{message:r,baseContent:a.substring(0,100)+"...",isEmpty:!a.trim()}),!a.trim())return console.log("âŒ åŸºç¡€å†…å®¹ä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆå®¢æˆ·å›žå¤"),"";const p=`candidate_${Date.now()}`,h={id:p,type:"customer_reply_candidate",text:"æ­£åœ¨ç”Ÿæˆå›žå¤â€¦",timestamp:new Date().toISOString(),isStreaming:!0};l(g=>({...g,solution:[...g.solution,h]}));const S=[...t.problem.filter(g=>g.type==="user"||g.type==="ai_response").map(g=>({...g,panel:"problem"})),...t.solution.filter(g=>g.type==="llm_request"||g.type==="user"||g.type==="ai_response").map(g=>({...g,panel:"solution"}))].sort((g,T)=>new Date(g.timestamp)-new Date(T.timestamp)),o={...N,onStreamStart:(g,T)=>{console.log("ðŸš€ å®¢æˆ·å›žå¤ç”Ÿæˆ: æµå¼å¼€å§‹ï¼Œåªæ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹");const ie={...T,isCustomerReply:!0,suppressMessageCreation:!0};N&&N.onStreamStart&&N.onStreamStart(g,ie)},onThinking:(g,T)=>{N&&N.onThinking&&N.onThinking(g,T)},onAnswering:(g,T)=>{N&&N.onAnswering&&N.onAnswering(g,T)},onStreamEnd:(g,T)=>{console.log("âœ… å®¢æˆ·å›žå¤ç”Ÿæˆ: æµå¼ç»“æŸ"),N&&N.onStreamEnd&&N.onStreamEnd(g,T)},onStreamError:g=>{console.error("âŒ å®¢æˆ·å›žå¤ç”Ÿæˆ: æµå¼é”™è¯¯",g),N&&N.onStreamError&&N.onStreamError(g)}},i=await re({type:"solution_response",content:a,context:"solution_to_problem",scenario:s,chatHistory:S,aiChatHistory:E,streamCallbacks:o});console.log("ðŸ” LLMç»“æžœ:",{llmResult:i,optimizedMessage:i==null?void 0:i.optimizedMessage});const w=(i==null?void 0:i.optimizedMessage)||"";return console.log("ðŸ” æœ€ç»ˆä¼˜åŒ–ç»“æžœï¼ˆæ— å¤„ç†ï¼‰:",{optimized:w,isEmpty:!w}),l(g=>({...g,solution:g.solution.map(T=>T.id===p?{...T,text:w||"ï¼ˆç©ºï¼‰",isStreaming:!1}:T)})),w}catch(a){return console.error("ç”Ÿæˆå®¢æˆ·å›žå¤å¤±è´¥:",a),console.log("ðŸ” é”™è¯¯è¯¦æƒ…:",{error:a.message,stack:a.stack}),l(p=>({...p,solution:p.solution.map(h=>h.type==="customer_reply_candidate"&&h.isStreaming?{...h,text:"ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•",isStreaming:!1,error:!0}:h)})),""}},[t.problem,t.solution,s]),Ke=f.useCallback(async(r,a,p)=>{if(!(!a||!a.trim()))try{const h=t.solution.find(g=>g.type==="customer_reply_candidate"&&g.id===r);if(!h){console.error("æœªæ‰¾åˆ°å®¢æˆ·å›žå¤è‰ç¨¿ï¼ŒcandidateId:",r);return}const S=[...t.problem.filter(g=>g.type==="user"||g.type==="ai_response").map(g=>({...g,panel:"problem"})),...t.solution.filter(g=>g.type==="llm_request"||g.type==="user"||g.type==="ai_response").map(g=>({...g,panel:"solution"}))].sort((g,T)=>new Date(g.timestamp)-new Date(T.timestamp)),o=`ã€åŽŸå®¢æˆ·å›žå¤è‰ç¨¿ã€‘
${h.text}

ã€ä¿®æ”¹è¦æ±‚ã€‘
${a}

è¯·æ ¹æ®ä¿®æ”¹è¦æ±‚ç›´æŽ¥è¾“å‡ºä¼˜åŒ–åŽçš„å®¢æˆ·å›žå¤ï¼Œä¿æŒç®€æ´å‹å¥½ã€‚`,i=await re({type:"solution_response",content:o,context:"solution_to_problem",scenario:s,chatHistory:S,aiChatHistory:E,streamCallbacks:null}),w=(i==null?void 0:i.optimizedMessage)||"";l(g=>({...g,solution:g.solution.map(T=>T.id===r&&T.type==="customer_reply_candidate"?{...T,text:w||T.text,negotiated:!0}:T)})),p&&typeof p=="function"&&p(w)}catch(h){console.error("åå•†ä¿®æ”¹å®¢æˆ·å›žå¤å¤±è´¥:",h)}},[t.problem,t.solution,s]),W=f.useCallback(async()=>{if(!x){y(!0);try{const a=[...t.problem.filter(o=>o.type==="user"||o.type==="ai_response").slice(-2),...t.solution.filter(o=>o.type==="user"||o.type==="ai_response").slice(-2)].sort((o,i)=>new Date(o.timestamp)-new Date(i.timestamp)).map(o=>o.text).join(`
`)||"åŸºäºŽå½“å‰å¯¹è¯ç”Ÿæˆè”ç»œæŒ‡ä»¤",p=[...t.problem.filter(o=>o.type==="user"||o.type==="ai_response").map(o=>({...o,panel:"problem"})),...t.solution.filter(o=>o.type==="llm_request"||o.type==="user"||o.type==="ai_response").map(o=>({...o,panel:"solution"}))].sort((o,i)=>new Date(o.timestamp)-new Date(i.timestamp)),h=await re({type:"generate_department_contact_only",content:a,scenario:s,chatHistory:p,aiChatHistory:E,streamCallbacks:N}),S={type:"processing",title:"ç”Ÿæˆéƒ¨é—¨è”ç»œ",steps:h.steps,structuredOutput:h.structuredOutput,timestamp:new Date().toISOString()};I("llm",S),console.log("âœ… éƒ¨é—¨è”ç»œæŒ‡ä»¤ç”Ÿæˆå®Œæˆ")}catch(r){console.error("ç”Ÿæˆéƒ¨é—¨è”ç»œæŒ‡ä»¤æ—¶å‡ºé”™:",r);const a={type:"processing",title:"ç”Ÿæˆéƒ¨é—¨è”ç»œå‡ºé”™",steps:[{name:"é”™è¯¯ä¿¡æ¯",content:"æŠ±æ­‰ï¼Œç”Ÿæˆéƒ¨é—¨è”ç»œæŒ‡ä»¤æ—¶å‡ºçŽ°äº†é”™è¯¯ï¼Œè¯·ç¨åŽé‡è¯•ã€‚"}],timestamp:new Date().toISOString()};I("llm",a)}finally{y(!1)}}},[I,s,t.problem,t.solution,x]),Re=f.useCallback(async r=>{if(!x){y(!0);try{const a=[...t.problem.filter(o=>o.type==="user"||o.type==="ai_response").map(o=>({...o,panel:"problem"})),...t.solution.filter(o=>o.type==="llm_request"||o.type==="user"||o.type==="ai_response").map(o=>({...o,panel:"solution"}))].sort((o,i)=>new Date(o.timestamp)-new Date(i.timestamp)),p=await re({type:"generate_department_contact",content:r,scenario:s,chatHistory:a,aiChatHistory:E,streamCallbacks:N}),h={type:"processing",title:"ç”Ÿæˆå®¢æˆ·å›žå¤å’Œéƒ¨é—¨è”ç»œ",steps:p.steps,output:`å®¢æˆ·å›žå¤ï¼š${p.customerReply}

è”ç»œæŒ‡ä»¤ï¼š${p.contactInstruction}`,structuredOutput:p.structuredOutput,timestamp:new Date().toISOString()};I("llm",h);const S={type:"department_contact",customerReply:p.customerReply,contactInstruction:p.contactInstruction,timestamp:new Date().toISOString(),id:`contact_${Date.now()}`,instructionSent:!1,sentTimestamp:null,customerReplyApplied:!1,appliedTimestamp:null};I("solution",S)}catch(a){console.error("ç”Ÿæˆéƒ¨é—¨è”ç»œæŒ‡ä»¤æ—¶å‡ºé”™:",a);const p={type:"processing",title:"ç”Ÿæˆå®¢æˆ·å›žå¤å’Œéƒ¨é—¨è”ç»œå‡ºé”™",steps:[{name:"é”™è¯¯ä¿¡æ¯",content:"æŠ±æ­‰ï¼Œç”Ÿæˆéƒ¨é—¨è”ç»œæŒ‡ä»¤æ—¶å‡ºçŽ°äº†é”™è¯¯ï¼Œè¯·ç¨åŽé‡è¯•ã€‚"}],timestamp:new Date().toISOString()};I("llm",p)}finally{y(!1)}}},[I,s,t.problem,t.solution,x]),Ye=f.useCallback(r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r&&p.type==="department_contact"?{...p,instructionSent:!0,sentTimestamp:new Date().toISOString()}:p)}))},[]),De=f.useCallback(r=>{l(a=>({...a,solution:a.solution.map(p=>p.id===r&&p.type==="department_contact"?{...p,customerReplyApplied:!0,appliedTimestamp:new Date().toISOString()}:p)})),console.log("âœ… å®¢æˆ·å›žå¤å·²æ ‡è®°ä¸ºåº”ç”¨çŠ¶æ€",r)},[]),ct=f.useCallback(()=>{l({problem:[],llm:[],solution:[]}),b(!1),C(null),M([]),D(!1),O(null),P("normal"),Z(!1),oe(!1)},[]),nt=f.useCallback(async()=>{if(console.log("ðŸ“ž generateDepartmentContactSuggestionè¢«è°ƒç”¨"),console.log("ðŸ“Š å½“å‰çŠ¶æ€:",{llmProcessing:m,iterationProcessing:x,problemMessages:t.problem.length,solutionMessages:t.solution.length,currentScenario:s}),m||x){console.log("â¸ï¸ Skipping execution: processing in progress");return}y(!0);try{const r=[...t.problem.slice(-3),...t.solution.slice(-3)].sort((S,o)=>new Date(S.timestamp)-new Date(o.timestamp)),a=r.map(S=>S.text||S.output||"").filter(S=>S.trim()).join(`
`);console.log("ðŸ“ å¯¹è¯å†…å®¹:",{content:a.substring(0,100),isEmpty:!a.trim()});const p=a.trim()?a:"æš‚æ— å…·ä½“å¯¹è¯å†…å®¹ï¼Œéœ€è¦ç”Ÿæˆé€šç”¨çš„éƒ¨é—¨è”ç»œæ–¹æ¡ˆ";console.log("ðŸ¤– è°ƒç”¨LLMç”Ÿæˆæ™ºèƒ½éƒ¨é—¨è”ç»œå»ºè®®å’Œå†…éƒ¨æŒ‡ä»¤ï¼ˆæµå¼æ˜¾ç¤ºï¼‰");const h={messageType:"department_contact_with_instructions",chatMode:"department"};await re({type:"generate_department_contact_with_instructions",content:p,scenario:s,chatHistory:r,streamCallbacks:{...N,onStreamStart:(S,o)=>{N.onStreamStart(S,{...o,messageType:"department_contact_with_instructions",chatMode:"department"})}}}),console.log("âœ… éƒ¨é—¨è”ç»œå»ºè®®æµå¼ç”Ÿæˆå®Œæˆ")}catch(r){console.error("ç”Ÿæˆéƒ¨é—¨è”ç»œå»ºè®®å¤±è´¥:",r);const p={type:"department_contact_with_instructions",text:`âš ï¸ **ç³»ç»Ÿæç¤ºï¼š** ç”Ÿæˆå»ºè®®æ—¶å‡ºçŽ°é”™è¯¯ï¼Œè¯·æ‰‹åŠ¨è”ç»œç›¸å…³éƒ¨é—¨æˆ–åˆ‡æ¢è‡³æ™®é€šå¯¹è¯æ¨¡å¼ã€‚
      
**å¤‡ç”¨è”ç»œæ–¹æ¡ˆï¼š**
ðŸ“ž **å®¢æœä¸»ç®¡** - ç«‹å³è”ç³»å¤„ç†å½“å‰æƒ…å†µ
ðŸ“§ **å†…éƒ¨æŒ‡ä»¤ï¼š** è¯·å°†æ­¤å¯¹è¯è®°å½•å‘é€ç»™ç›¸å…³è´Ÿè´£äºº`,timestamp:new Date().toISOString(),isError:!0,generatedInMode:ce};I("solution",p)}finally{y(!1),console.log("ðŸ generateDepartmentContactSuggestionæ‰§è¡Œå®Œæˆ")}},[m,x,t.problem,t.solution,s,I]),dt=f.useCallback(r=>{console.log("ðŸ”„ switchChatModeè¢«è°ƒç”¨:",r),P(r),r==="department"?(console.log("ðŸ“ž å¼€å§‹ç”Ÿæˆéƒ¨é—¨è”ç»œå»ºè®®"),setTimeout(()=>{nt()},100)):r==="emergency"?oe(!0):(Z(!1),oe(!1))},[nt]),ut=f.useCallback(async(r,a)=>{if(!(m||x)){y(!0);try{const p={urgencyLevel:r,description:a,context:{scenario:s,recentMessages:[...t.problem.slice(-2),...t.solution.slice(-2)]},timestamp:new Date().toISOString()},h={...N,onStreamStart:(o,i)=>{N&&N.onStreamStart&&N.onStreamStart(o,{...i,messageType:"emergency_response",chatMode:"emergency",urgencyLevel:r,description:a,escalated:r==="critical"})}},S=await re({type:"emergency_handling",content:p,scenario:s,streamCallbacks:h});if(r==="critical"){const o={type:"escalation_notice",text:`å…³é”®çº§åˆ«ç´§æ€¥æƒ…å†µå·²è‡ªåŠ¨ä¸ŠæŠ¥ç®¡ç†å±‚
æ—¶é—´ï¼š${new Date().toLocaleString()}
æè¿°ï¼š${a}`,timestamp:new Date().toISOString()};I("solution",o)}}catch(p){console.error("å¤„ç†ç´§æ€¥æƒ…å†µå¤±è´¥:",p);const h={type:"emergency_error",text:"ç´§æ€¥å¤„ç†ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç«‹å³è”ç³»ç›´å±žä¸Šçº§æˆ–æ‹¨æ‰“ç´§æ€¥è”ç³»ç”µè¯ã€‚",timestamp:new Date().toISOString(),isError:!0};I("solution",h)}finally{y(!1)}}},[m,x,s,t.problem,t.solution,I]),pt=f.useCallback(r=>{r==="department"?Z(!1):r==="emergency"&&oe(!1),P("normal")},[]),mt=f.useCallback(()=>{oe(!1)},[]);return{messages:t,llmProcessing:m,llmProcessingContext:d,iterationProcessing:x,iterationMode:v,pendingResponse:k,directSendCandidate:U,missingInfoOptions:j,showMissingInfoPanel:F,currentNeedsAnalysis:q,toggleMissingInfoOption:pe,generateFollowUpBySelectedInfo:Oe,generateSimpleIntelligentFollowUp:$,generateIntelligentNeedsAnalysis:Y,skipInfoCollection:Le,acceptSuggestion:A,negotiateSuggestion:G,cancelNegotiation:V,sendNegotiationRequest:ye,rejectSuggestion:Ve,acceptFollowUp:Ge,negotiateFollowUp:_e,cancelFollowUpNegotiation:He,sendFollowUpNegotiationRequest:ot,rejectFollowUp:n,confirmDirectSendToProblem:Fe,cancelDirectSend:Be,prepareDirectSendCandidate:Ze,generateCustomerReplyForMessage:tt,negotiateCustomerReplyCandidate:Ke,acceptIntelligentFollowUp:be,negotiateIntelligentFollowUp:Qe,cancelIntelligentFollowUpNegotiation:We,sendIntelligentFollowUpNegotiationRequest:Ue,rejectIntelligentFollowUp:Je,chatMode:ce,departmentModalVisible:z,emergencyModalVisible:me,switchChatMode:dt,generateDepartmentContactSuggestion:nt,handleEmergencyMode:ut,closeModeModal:pt,closeEmergencyModalOnly:mt,thinkingContent:we,answerContent:ue,isStreaming:$e,streamingMessage:te,streamingMessageContent:qe,isPaused:ne,pauseAI:fe,resumeAI:_,adjustAI:Ie,sendProblemMessage:de,sendCustomerReplyToProblem:xe,sendSolutionMessage:Te,generateSuggestion:Pe,generateFollowUp:Ae,generateDepartmentContact:Re,generateDepartmentContactOnly:W,chatWithAI:Xe,clearAiChatHistory:et,aiChatHistory:E,markContactInstructionSent:Ye,markCustomerReplyApplied:De,confirmSendResponse:le,cancelIteration:Ce,clearMessages:ct}};class Vn{constructor(){this.listeners={},this.connected=!1,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=2e3,this.connectionId=null,this.EVENT_TYPES={MESSAGE_RECEIVED:"message_received",MESSAGE_SENT:"message_sent",CONNECTION_STATE_CHANGED:"connection_state_changed",PROCESSING_STARTED:"processing_started",PROCESSING_COMPLETED:"processing_completed",PROCESSING_STEP_UPDATED:"processing_step_updated",ERROR:"error"}}connect(){return this.connected?Promise.resolve(this.connectionId):new Promise((t,l)=>{setTimeout(()=>{this.connected=!0,this.connectionId=`conn_${Date.now()}`,this.reconnectAttempts=0,this._triggerEvent(this.EVENT_TYPES.CONNECTION_STATE_CHANGED,{connected:!0,connectionId:this.connectionId}),console.log(`[RealtimeService] Connected with ID: ${this.connectionId}`),t(this.connectionId),this._setupHeartbeat()},500)})}disconnect(){return this.connected?new Promise(t=>{setTimeout(()=>{this.connected=!1,this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null),this._triggerEvent(this.EVENT_TYPES.CONNECTION_STATE_CHANGED,{connected:!1,connectionId:this.connectionId}),console.log("[RealtimeService] Disconnected"),this.connectionId=null,t()},300)}):Promise.resolve()}sendMessage(t,l){return this.connected?new Promise((m,c)=>{setTimeout(()=>{const d={...t,id:t.id||`msg_${Date.now()}`,timestamp:t.timestamp||new Date().toISOString(),targetPanel:l};this._triggerEvent(this.EVENT_TYPES.MESSAGE_SENT,d),console.log("[RealtimeService] Message sent:",d),m(d),this._simulateServerReceipt(d)},Math.random()*300+100)}):Promise.reject(new Error("Not connected to server"))}startProcessing(t,l){return this.connected?new Promise(m=>{setTimeout(()=>{const c={messageId:t,startTime:new Date().toISOString(),steps:l||[],currentStep:0};this._triggerEvent(this.EVENT_TYPES.PROCESSING_STARTED,c),console.log(`[RealtimeService] Processing started for message: ${t}`),m(c),l&&l.length>0&&this._simulateProcessingSteps(t,l)},200)}):Promise.reject(new Error("Not connected to server"))}subscribe(t,l){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(l),()=>{this.listeners[t]=this.listeners[t].filter(m=>m!==l)}}_triggerEvent(t,l){this.listeners[t]&&this.listeners[t].forEach(m=>{try{m(l)}catch(c){console.error(`[RealtimeService] Error in event listener for ${t}:`,c)}})}_setupHeartbeat(){this.heartbeatInterval=setInterval(()=>{if(!this.connected){clearInterval(this.heartbeatInterval),this.heartbeatInterval=null;return}Math.random()<.05&&this._handleConnectionLoss()},1e4)}_handleConnectionLoss(){this.connected=!1,this._triggerEvent(this.EVENT_TYPES.CONNECTION_STATE_CHANGED,{connected:!1,connectionId:this.connectionId}),console.log("[RealtimeService] Connection lost. Attempting to reconnect..."),this._attemptReconnect()}_attemptReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.log("[RealtimeService] Max reconnect attempts reached. Giving up."),this._triggerEvent(this.EVENT_TYPES.ERROR,{code:"MAX_RECONNECT_ATTEMPTS",message:"Failed to reconnect after maximum attempts"});return}this.reconnectAttempts++;const t=this.reconnectDelay*Math.pow(1.5,this.reconnectAttempts-1);console.log(`[RealtimeService] Reconnecting in ${t}ms (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),setTimeout(()=>{this.connect().catch(()=>{this._attemptReconnect()})},t)}_simulateServerReceipt(t){setTimeout(()=>{const l={originalMessageId:t.id,receiptId:`receipt_${Date.now()}`,timestamp:new Date().toISOString(),status:"delivered"};this._triggerEvent(this.EVENT_TYPES.MESSAGE_RECEIVED,l),console.log(`[RealtimeService] Server acknowledged message: ${t.id}`)},Math.random()*500+200)}_simulateProcessingSteps(t,l){let m=0;const c=()=>{if(m>=l.length){this._triggerEvent(this.EVENT_TYPES.PROCESSING_COMPLETED,{messageId:t,completionTime:new Date().toISOString(),steps:l}),console.log(`[RealtimeService] Processing completed for message: ${t}`);return}const d={messageId:t,currentStep:m,stepName:l[m].name,stepStatus:"completed",timestamp:new Date().toISOString()};this._triggerEvent(this.EVENT_TYPES.PROCESSING_STEP_UPDATED,d),console.log(`[RealtimeService] Step ${m} (${l[m].name}) completed for message: ${t}`),m++,setTimeout(c,Math.random()*1e3+500)};setTimeout(c,Math.random()*500+200)}}const ht=new Vn,Et={MESSAGE_RECEIVED:"message_received",MESSAGE_SENT:"message_sent",CONNECTION_STATE_CHANGED:"connection_state_changed",PROCESSING_STARTED:"processing_started",PROCESSING_COMPLETED:"processing_completed",PROCESSING_STEP_UPDATED:"processing_step_updated",ERROR:"error"},Kn={retail:{id:"retail",name:"Retail",icon:hn,description:"Communication between customer and store",problemRole:"Customer",solutionRole:"Store/Sales Representative",example:"I will attend a keynote speech at the AOM conference next week and need a formal yet modern business suit. Budget: 800â€“1500 RMB, height: 175 cm. I want to look professional and energetic."},enterprise:{id:"enterprise",name:"Enterprise",icon:lt,description:"Cross-department communication within a company",problemRole:"Marketing Manager",solutionRole:"R&D Engineer",example:"Our mobile app retention is only 30%. We need to build a personalized recommendation feature within 3 months to raise it to 45%. Target users: 18â€“35 years old. Budget: 500,000 RMB."},education:{id:"education",name:"Education",icon:an,description:"Interaction between student and teacher",problemRole:"Student",solutionRole:"Teacher",example:"I have difficulty understanding waveâ€“particle duality in quantum physics, especially why light is both a wave and a particle. I hope to understand it through concrete experimental examples."}};function Zn(){const[s,t]=f.useState("retail"),[l,m]=f.useState(!1),[c,d]=f.useState(!1),[u,x]=f.useState({darkMode:!0,fontSize:"medium",soundEnabled:!0,autoScroll:!0,showTimestamps:!0,language:"en-US",apiEndpoint:"https://api.example.com/v1",maxMessagesPerPanel:50}),y=f.useRef(null),v=f.useRef(null),{messages:b,llmProcessing:k,iterationProcessing:C,llmProcessingContext:j,iterationMode:M,pendingResponse:F,directSendCandidate:D,missingInfoOptions:q,showMissingInfoPanel:O,currentNeedsAnalysis:U,toggleMissingInfoOption:J,generateFollowUpBySelectedInfo:E,generateSimpleIntelligentFollowUp:K,generateIntelligentNeedsAnalysis:ce,skipInfoCollection:P,acceptSuggestion:z,negotiateSuggestion:Z,cancelNegotiation:me,sendNegotiationRequest:oe,rejectSuggestion:we,acceptFollowUp:ae,negotiateFollowUp:ue,cancelFollowUpNegotiation:Q,sendFollowUpNegotiationRequest:$e,rejectFollowUp:H,confirmDirectSendToProblem:ne,cancelDirectSend:he,prepareDirectSendCandidate:ee,acceptIntelligentFollowUp:ve,negotiateIntelligentFollowUp:ge,cancelIntelligentFollowUpNegotiation:ze,sendIntelligentFollowUpNegotiationRequest:te,rejectIntelligentFollowUp:Ee,chatMode:qe,departmentModalVisible:L,emergencyModalVisible:R,switchChatMode:se,generateDepartmentContactSuggestion:N,handleEmergencyMode:I,closeModeModal:fe,closeEmergencyModalOnly:_,thinkingContent:Ie,answerContent:xe,isStreaming:de,streamingMessage:Te,streamingMessageContent:Pe,isPaused:Ae,pauseAI:le,resumeAI:Ce,adjustAI:pe,generateCustomerReplyForMessage:Oe,negotiateCustomerReplyCandidate:Le,sendProblemMessage:$,sendCustomerReplyToProblem:Y,sendSolutionMessage:A,generateSuggestion:G,generateFollowUp:V,generateDepartmentContact:ye,generateDepartmentContactOnly:Ve,chatWithAI:Ge,clearAiChatHistory:_e,aiChatHistory:He,markContactInstructionSent:ot,markCustomerReplyApplied:n,confirmSendResponse:be,cancelIteration:Fe,clearMessages:Be}=Yn(s);f.useEffect(()=>{(async()=>{try{await ht.connect(),d(!0)}catch(De){console.error("Failed to connect to realtime service:",De)}})();const Re=ht.subscribe(Et.CONNECTION_STATE_CHANGED,De=>{d(De.connected)}),Ye=ht.subscribe(Et.ERROR,De=>{console.error("Realtime service error:",De)});return()=>{Re(),Ye(),ht.disconnect()}},[]),f.useEffect(()=>{u.darkMode?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");const W={small:"text-sm",medium:"text-base",large:"text-lg"};Object.values(W).forEach(Re=>{document.documentElement.classList.remove(Re)}),document.documentElement.classList.add(W[u.fontSize])},[u]);const Ze=W=>{x(W),localStorage.setItem("app-settings",JSON.stringify(W))};f.useEffect(()=>{const W=localStorage.getItem("app-settings");if(W)try{const Re=JSON.parse(W);x(Ye=>({...Ye,...Re}))}catch(Re){console.error("Failed to parse saved settings:",Re)}},[]);const Je=()=>{Be()},Qe=()=>{m(W=>!W)},We=W=>{W==="problem"&&y.current?y.current.focus():W==="solution"&&v.current&&v.current.focus()},[Ue,Xe]=f.useState(null),et=f.useCallback(W=>{console.log("ðŸ”„ setSolutionInputè¢«è°ƒç”¨:",{text:W,solutionSetInputRef:!!Ue}),Ue?(console.log("ðŸ“ è°ƒç”¨solutionSetInputRef:",W),Ue(W)):console.error("âŒ solutionSetInputRefæœªè®¾ç½®")},[Ue]),tt=f.useCallback(W=>{Xe(()=>W)},[]);f.useCallback(W=>{t(W),Be()},[Be]);const Ke=Kn[s];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"min-h-screen relative overflow-hidden transition-colors duration-300",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute -top-10 -right-10 w-80 h-80 bg-gradient-to-r from-blue-500/20 to-purple-600/20 rounded-full blur-3xl animate-pulse"}),e.jsx("div",{className:"absolute -bottom-10 -left-10 w-96 h-96 bg-gradient-to-r from-orange-500/15 to-pink-600/15 rounded-full blur-3xl animate-pulse",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-gradient-to-r from-cyan-400/12 to-violet-500/12 rounded-full blur-3xl animate-pulse",style:{animationDelay:"2s"}}),e.jsx("div",{className:"absolute top-1/4 right-1/4 w-48 h-48 bg-gradient-to-r from-blue-400/10 to-indigo-500/10 rounded-full blur-2xl animate-pulse",style:{animationDelay:"3s"}}),e.jsx("div",{className:"absolute bottom-1/4 left-1/4 w-56 h-56 bg-gradient-to-r from-purple-400/8 to-pink-500/8 rounded-full blur-2xl animate-pulse",style:{animationDelay:"4s"}})]}),e.jsx("header",{className:"app-toolbar",children:e.jsx("div",{className:"w-full px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex justify-between items-center h-16",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-white drop-shadow",style:{textShadow:u.darkMode?"0 1px 2px rgba(0, 0, 0, 0.5)":"0 1px 2px rgba(0, 0, 0, 0.25)"},children:"GenAI ZeroTouch Services"}),!1]}),!1]})})}),e.jsxs("main",{className:"w-full px-4 sm:px-6 lg:px-8 py-4 flex flex-col",style:{height:"calc(100vh - 64px)"},children:[!1,e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-1 lg:grid-cols-[20%_50%_30%] gap-6 flex-1 items-stretch",style:{height:"calc(100vh - 150px)",minHeight:"calc(100vh - 150px)"},children:[e.jsx(Se,{type:"slide-left",show:!0,children:e.jsx("div",{className:"panel",children:e.jsx(Nn,{scenario:Ke,messages:b.problem,onSendMessage:$,isProcessing:k&&j==="problem",inputRef:y,settings:u})})}),e.jsx(Se,{type:"slide-right",show:!0,children:e.jsx("div",{className:"panel",children:e.jsx(Sn,{scenario:Ke,messages:b.solution,onSendMessage:A,onSendToProblem:Y,isProcessing:k&&j==="solution",iterationMode:M,pendingResponse:F,directSendCandidate:D,onConfirmDirectSend:ne,onCancelDirectSend:he,onGenerateSuggestion:G,onGenerateFollowUp:V,onGenerateDepartmentContact:ye,onMarkContactInstructionSent:ot,onMarkCustomerReplyApplied:n,onPrepareDirectSendCandidate:ee,onConfirmSend:be,onCancelIteration:Fe,onSetInput:tt,inputRef:v,settings:u,iterationProcessing:C,onAcceptSuggestion:z,onNegotiateSuggestion:Z,onCancelNegotiation:me,onSendNegotiationRequest:oe,onRejectSuggestion:we,onAcceptFollowUp:ae,onNegotiateFollowUp:ue,onCancelFollowUpNegotiation:Q,onSendFollowUpNegotiationRequest:$e,onRejectFollowUp:H,onAcceptIntelligentFollowUp:ve,onNegotiateIntelligentFollowUp:ge,onCancelIntelligentFollowUpNegotiation:ze,onSendIntelligentFollowUpNegotiationRequest:te,onRejectIntelligentFollowUp:Ee,onGenerateIntelligentFollowUp:K,onGenerateDepartmentContactOnly:Ve,onChatWithAI:Ge,onClearAiChatHistory:_e,onGenerateCustomerReplyForMessage:Oe,onNegotiateCustomerReplyCandidate:Le,aiChatHistory:He,currentScenario:s,missingInfoOptions:q,showMissingInfoPanel:O,onToggleMissingInfoOption:J,onGenerateFollowUpBySelectedInfo:E,onSkipInfoCollection:P,chatMode:qe,departmentModalVisible:L,emergencyModalVisible:R,onSwitchChatMode:se,onCloseModeModal:fe,onCloseEmergencyModalOnly:_,onHandleEmergencyMode:I,streamingMessage:Te,streamingMessageContent:Pe})})}),e.jsx(Se,{type:"scale",show:!0,children:e.jsx("div",{className:"panel",style:{boxShadow:"0 25px 50px -12px rgba(147, 51, 234, 0.25)",border:"2px solid rgba(147, 51, 234, 0.2)",background:"linear-gradient(135deg, rgba(147, 51, 234, 0.03) 0%, rgba(99, 102, 241, 0.02) 100%)"},children:e.jsx(kn,{processing:k||C,messages:b.llm,settings:u,currentScenario:s,onGenerateSuggestion:G,onGenerateFollowUp:V,onGenerateIntelligentFollowUp:K,onGenerateNeedsAnalysis:ce,onGenerateDepartmentContact:ye,onGenerateDepartmentContactOnly:Ve,onChatWithAI:Ge,onAcceptSuggestion:z,onNegotiateSuggestion:Z,onRejectSuggestion:we,onAcceptFollowUp:ae,onNegotiateFollowUp:ue,onRejectFollowUp:H,onSendToSolution:A,onSendToProblem:Y,onSetSolutionInput:et,showMissingInfoPanel:O,onCancelIteration:Fe,onCancelNegotiation:me,onSendNegotiationRequest:oe,onCancelFollowUpNegotiation:Q,onSendFollowUpNegotiationRequest:$e,onPrepareDirectSendCandidate:ee,thinkingContent:Ie,answerContent:xe,isStreaming:de,isPaused:Ae,onPauseAI:le,onResumeAI:Ce,onAdjustAI:pe})})})]}),!1]})]}),e.jsx(jn,{}),e.jsx(Rn,{onClearMessages:Je,onToggleSettings:Qe,onFocusInput:We}),e.jsx(Mn,{isOpen:l,onClose:()=>m(!1),settings:u,onUpdateSettings:Ze})]})}wt.createRoot(document.getElementById("root")).render(e.jsx(Kt.StrictMode,{children:e.jsx(Zn,{})}));
